<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerSys Pro - Executive Short Circuit Calculator</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    
    <!-- PowerSys Pro Enhanced Modules -->
    <script src="js/improved_validation.js"></script>
    <script src="js/standard_specific_calcs.js"></script>
    <script src="js/calculation_verification.js"></script>
    <script src="js/arc_flash_calculation.js"></script>
    <script src="js/ppe_selection.js"></script>
    <script src="js/voltage_drop_calculations.js"></script>
    <script src="js/bus_model.js"></script>
    <script src="js/thevenin_equivalent.js"></script>
    <script src="js/transformer_model.js"></script>
    <script src="js/power_system.js"></script>
    <script src="js/visualization.js"></script>
    <script src="js/system_ui_interaction.js"></script>
    
    <!-- Enhanced Styling -->
    <link rel="stylesheet" href="css/system_diagram.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.35);
            overflow: hidden;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1)),
                        linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1));
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            opacity: 0.3;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header .subtitle {
            font-size: 1.2em;
            font-weight: 300;
            margin-bottom: 15px;
            opacity: 0.95;
        }
        
        .standards-badge {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            padding: 8px 18px;
            border-radius: 25px;
            margin: 5px;
            font-size: 0.85em;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        
        .standards-badge:hover {
            background: rgba(255,255,255,0.35);
            transform: translateY(-2px);
        }
        
        .nav-tabs {
            display: flex;
            background: #f5f7fa;
            padding: 15px 30px 0 30px;
            border-bottom: 2px solid #e1e8ed;
        }
        
        .nav-tab {
            padding: 12px 24px;
            margin-right: 5px;
            border: none;
            background: transparent;
            color: #5a6c7d;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .nav-tab.active {
            background: white;
            color: #1e3c72;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 35px;
            padding: 35px;
            background: #fafbfc;
        }
        
        .input-section, .results-section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid #e8eef2;
        }
        
        .section-title {
            font-size: 1.6em;
            color: #1e3c72;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 5px;
            height: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        
        .info-text {
            font-size: 0.82em;
            color: #718096;
            margin-top: 5px;
            line-height: 1.5;
            font-style: italic;
        }
        
        input, select {
            width: 100%;
            padding: 13px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: #fafbfc;
        }
        
        input:hover, select:hover {
            border-color: #cbd5e0;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
            background: white;
        }
        
        input.error {
            border-color: #f56565;
            background: #fff5f5;
        }
        
        .error-message {
            color: #e53e3e;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        
        input.error + .error-message {
            display: block;
        }
        
        .component-list {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .component-item {
            background: #e8eaf6;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.45);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 10px 18px;
            font-size: 14px;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }
        
        .calculation-steps {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        
        .step-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 1.8em;
            color: #28a745;
            font-weight: 700;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            text-align: center;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .standard-selector {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }
        
        .method-selector {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #667eea;
        }
        
        .method-selector label {
            color: #1e3c72;
            font-size: 15px;
        }
        
        .comparison-mode {
            background: #fffbeb;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .voltage-zone-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
            border: 1px solid;
        }
        
        .voltage-zone-lv {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }
        
        .voltage-zone-mv {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }
        
        .voltage-zone-hv {
            background: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }
        
        .validation-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .validation-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .validation-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
            border: 1px solid #fbbf24;
        }
        
        .executive-summary {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #0284c7;
        }
        
        .executive-summary h3 {
            color: #0c4a6e;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .summary-card-label {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .summary-card-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #1e3c72;
        }
        
        .equipment-database {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }
        
        .database-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .database-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            text-align: center;
        }
        
        .database-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .safety-analysis {
            background: #fef2f2;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #ef4444;
        }
        
        .safety-analysis h4 {
            color: #991b1b;
            margin-bottom: 12px;
        }
        
        .arc-flash-boundary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .boundary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }
        
        .sensitivity-analysis {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #10b981;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .close:hover,
        .close:focus {
            opacity: 1;
        }
        
        /* Database Management Styles */
        .db-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding-left: 40px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-size: 18px;
        }
        
        .filter-dropdown {
            padding: 13px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #fafbfc;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-dropdown:hover {
            border-color: #cbd5e0;
        }
        
        .component-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .component-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .component-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .component-card-title {
            font-weight: 600;
            color: #1e3c72;
            font-size: 1.1em;
        }
        
        .component-card-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .btn-icon:hover {
            background: #f0f4ff;
        }
        
        .btn-edit {
            color: #667eea;
        }
        
        .btn-delete {
            color: #ef4444;
        }
        
        .btn-favorite {
            color: #fbbf24;
        }
        
        .btn-favorite.active {
            color: #f59e0b;
        }
        
        .component-modified {
            border-left: 4px solid #fbbf24;
            background: #fffbeb;
        }
        
        .edit-indicator {
            display: inline-block;
            background: #fbbf24;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 8px;
            font-weight: 600;
        }
        
        .favorites-section {
            background: #fffbeb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #fbbf24;
        }
        
        .favorites-section h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .tab-badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-left: 5px;
            font-weight: 600;
        }
        
        .sensitivity-analysis h4 {
            color: #065f46;
            margin-bottom: 12px;
        }
        
        .help-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        
        .help-icon {
            background: #3b82f6;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .help-tooltip:hover .help-text {
            visibility: visible;
            opacity: 1;
        }
        
        .help-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            width: 250px;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .help-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding: 10px 15px 0;
            }
            
            .main-content {
                padding: 20px;
                gap: 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .database-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>⚡ PowerSys Pro - Executive Short Circuit Calculator</h1>
                <p class="subtitle">Professional Standards-Compliant Short Circuit Analysis & Equipment Selection</p>
                <div style="margin-top: 15px;">
                    <span class="standards-badge">IEC 60909-0</span>
                    <span class="standards-badge">IEEE 141 (Red Book)</span>
                    <span class="standards-badge">IEEE C37.010</span>
                    <span class="standards-badge">ANSI C37.5</span>
                    <span class="standards-badge">NFPA 70E-2024</span>
                </div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('calculator')">Calculator</button>
            <button class="nav-tab" onclick="switchTab('equipment')">Equipment Database</button>
            <button class="nav-tab" onclick="switchTab('busManagement')">Bus Management</button>
            <button class="nav-tab" onclick="switchTab('voltageDrop')">Voltage Drop</button>
            <button class="nav-tab" onclick="switchTab('safety')">Safety Analysis</button>
            <button class="nav-tab" onclick="switchTab('reports')">Reports & Export</button>
            <button class="nav-tab" onclick="switchTab('help')">Help & Documentation</button>
        </div>
        
        <div id="calculatorTab" class="tab-content active">
            <div class="main-content">
                <div class="input-section">
                    <h2 class="section-title">Circuit Configuration</h2>
                    
                    <div class="standard-selector">
                        <label>Calculation Standard:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">IEC 60909 is used primarily in Europe and internationally. IEEE standards are common in North America.</span>
                            </span>
                        </label>
                        <select id="calcStandard" onchange="updateMethodOptions()">
                            <option value="iec">IEC 60909-0 (Europe/International)</option>
                            <option value="ieee">IEEE 141/C37 (North America)</option>
                            <option value="ansi">ANSI C37.5 (North America)</option>
                        </select>
                        <div class="info-text">Select the applicable standard for your region and requirements</div>
                    </div>
                    
                    <div class="method-selector">
                        <label>Calculation Method:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Per-Unit method uses normalized values. Point-to-Point calculates actual impedances directly. Comparison shows both methods side-by-side.</span>
                            </span>
                        </label>
                        <select id="calcMethod">
                            <option value="per-unit">Per-Unit Method (Normalized)</option>
                            <option value="point-to-point">Point-to-Point Method (Direct)</option>
                            <option value="comparison">Comparison Mode (Both Methods)</option>
                        </select>
                        <div class="info-text">Choose your preferred calculation approach</div>
                    </div>
                
                <div class="form-group">
                    <label>Project Name:</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                </div>
                
                <div class="form-group">
                    <label>System Voltage (V):</label>
                    <input type="number" id="systemVoltage" placeholder="e.g., 480" step="0.1">
                    <div class="info-text">Line-to-line voltage at fault location</div>
                </div>
                
                <div class="form-group">
                    <label>System Frequency (Hz):</label>
                    <select id="systemFrequency">
                        <option value="60">60 Hz (North America)</option>
                        <option value="50">50 Hz (Europe/Asia)</option>
                    </select>
                </div>
                
                <div id="iecControls" style="display: none;">
                    <div class="form-group">
                        <label>Voltage Factor (c) for IEC 60909:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">IEC 60909 voltage factor: cmax for maximum short-circuit, cmin for minimum. Typically 1.0-1.1 depending on voltage level.</span>
                            </span>
                        </label>
                        <select id="iecVoltageFactor">
                            <option value="auto">Auto (Based on Voltage Level)</option>
                            <option value="1.0">c = 1.00 (Low tolerance systems)</option>
                            <option value="1.05">c = 1.05 (LV ≤1kV, cmax)</option>
                            <option value="1.10">c = 1.10 (MV/HV, cmax)</option>
                            <option value="0.95">c = 0.95 (cmin for minimum fault)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Peak Factor (κ) Calculation:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Peak factor for calculating peak short-circuit current. Auto calculates from R/X ratio per IEC 60909.</span>
                            </span>
                        </label>
                        <select id="iecPeakFactor">
                            <option value="auto">Auto (Calculate from R/X ratio)</option>
                            <option value="1.15">κ = 1.15 (Near generator)</option>
                            <option value="1.5">κ = 1.5 (Medium distance)</option>
                            <option value="1.8">κ = 1.8 (Far from source)</option>
                            <option value="2.0">κ = 2.0 (Maximum, X/R >> 1)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Component Type:</label>
                    <select id="componentType">
                        <optgroup label="Power Sources">
                            <option value="utility_isc">Utility Source (ISC Known)</option>
                            <option value="utility_mva">Utility Source (MVA Known)</option>
                            <option value="utility_impedance">Utility Source (Impedance Known)</option>
                            <option value="generator">Generator</option>
                        </optgroup>
                        <optgroup label="Transformation Equipment">
                            <option value="transformer">Transformer</option>
                        </optgroup>
                        <optgroup label="Distribution Equipment">
                            <option value="distribution_board">Distribution Board</option>
                            <option value="switchgear">Switchgear</option>
                            <option value="mcc">Motor Control Center</option>
                            <option value="load_center">Load Center</option>
                        </optgroup>
                        <optgroup label="Transmission">
                            <option value="cable">Cable</option>
                        </optgroup>
                        <optgroup label="Loads">
                            <option value="motor">Motor</option>
                        </optgroup>
                        <optgroup label="Power Quality Equipment">
                            <option value="reactor">Reactor</option>
                            <option value="capacitor_bank">Capacitor Bank</option>
                            <option value="ups">UPS System</option>
                            <option value="surge_protection">Surge Protection Device</option>
                            <option value="harmonic_filter">Harmonic Filter</option>
                        </optgroup>
                    </select>
                </div>
                
                <div id="componentInputs"></div>
                
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addComponent()">Add Component</button>
                    <button class="btn btn-info" onclick="showTemplateSelector()">📋 Load Template</button>
                </div>
                
                <h3 class="section-title" style="margin-top: 30px;">Components</h3>
                <div class="component-list" id="componentList">
                    <p style="color: #999;">No components added yet</p>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="calculate()">Calculate</button>
                    <button class="btn btn-secondary" onclick="saveProject()">Save Project</button>
                    <button class="btn btn-secondary" onclick="loadProject()">Load Project</button>
                    <button class="btn btn-secondary" onclick="exportResults()">Export Results</button>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">Results & Analysis</h2>
                <div id="results">
                    <p style="color: #94a3b8; text-align: center; padding: 50px 20px; font-size: 15px;">
                        Add components and click <strong>Calculate</strong> to see comprehensive results, equipment recommendations, and safety analysis
                    </p>
                </div>
            </div>
        </div>
        </div>
        
        <div id="equipmentTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Equipment Database</h2>
                
                <div class="button-group" style="margin-bottom: 25px;">
                    <button class="btn btn-primary" onclick="openDatabaseManager()">🗄️ Database Manager</button>
                    <button class="btn btn-secondary" onclick="compareComponents()">📊 Compare Components</button>
                    <button class="btn btn-secondary" onclick="generateSpecReport()">📋 Generate Spec Report</button>
                    <button class="btn btn-info" onclick="undoEdit()" title="Undo last edit">↶ Undo</button>
                    <button class="btn btn-info" onclick="redoEdit()" title="Redo last undo">↷ Redo</button>
                </div>
                
                <div class="equipment-database">
                    <h4>Standard Transformer Database</h4>
                    <div class="database-grid" id="transformerDB"></div>
                </div>
                <div class="equipment-database">
                    <h4>Standard Cable Database</h4>
                    <div class="database-grid" id="cableDB"></div>
                </div>
                <div class="equipment-database">
                    <h4>Standard Generator Database</h4>
                    <div class="database-grid" id="generatorDB"></div>
                </div>
                
                <div class="equipment-database" style="background: #f0f9ff; border-color: #0284c7;">
                    <h4>✨ New Component Types Available</h4>
                    <div style="padding: 15px; color: #0c4a6e;">
                        <p style="margin-bottom: 10px;"><strong>Distribution Equipment:</strong> Distribution Boards, Switchgear, Motor Control Centers, Load Centers</p>
                        <p style="margin-bottom: 10px;"><strong>Power Quality Equipment:</strong> Reactors, Capacitor Banks, UPS Systems, Surge Protection Devices, Harmonic Filters</p>
                        <p style="margin-bottom: 0;">Select these from the Component Type dropdown in the Calculator tab to add them to your project.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="safetyTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Safety Analysis & Arc Flash</h2>
                
                <div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 25px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">⚡ Arc Flash Parameters (IEEE 1584-2018)</h3>
                    
                    <div class="form-group">
                        <label>Working Distance (mm):
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Distance from arc source to worker. Typical: 450mm (18") for LV, 900mm (36") for MV</span>
                            </span>
                        </label>
                        <input type="number" id="arcWorkingDistance" placeholder="e.g., 450" value="450" step="10">
                    </div>
                    
                    <div class="form-group">
                        <label>Equipment Gap (mm):
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Distance between conductors. Typical: 32mm for LV, 104mm for MV</span>
                            </span>
                        </label>
                        <input type="number" id="arcEquipmentGap" placeholder="e.g., 32" value="32" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label>Enclosure Type:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Type of electrical enclosure affects arc energy</span>
                            </span>
                        </label>
                        <select id="arcEnclosureType">
                            <option value="VCB">VCB - Vertical conductors in a box</option>
                            <option value="VCBB">VCBB - Vertical conductors in a box with barriers</option>
                            <option value="HCB">HCB - Horizontal conductors in a box</option>
                            <option value="VOA">VOA - Vertical conductors in open air</option>
                            <option value="HOA">HOA - Horizontal conductors in open air</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Arc Duration / Clearing Time (seconds):
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Time for protective device to clear the fault. Typical: 0.1s (6 cycles @ 60Hz)</span>
                            </span>
                        </label>
                        <input type="number" id="arcDuration" placeholder="e.g., 0.1" value="0.1" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>System Grounding:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Grounding method affects fault current and arc flash energy</span>
                            </span>
                        </label>
                        <select id="arcGrounding">
                            <option value="solidly">Solidly Grounded</option>
                            <option value="resistance">Resistance Grounded</option>
                            <option value="ungrounded">Ungrounded</option>
                            <option value="reactance">Reactance Grounded</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="calculateArcFlashFromResults()">Calculate Arc Flash Analysis</button>
                </div>
                
                <div id="safetyResults">
                    <p style="color: #94a3b8; text-align: center; padding: 50px 20px;">
                        Complete short circuit calculation and then click "Calculate Arc Flash Analysis" to see arc flash boundaries and PPE requirements
                    </p>
                </div>
            </div>
        </div>
        
        <div id="reportsTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Reports & Export</h2>
                <div style="background: white; padding: 30px; border-radius: 16px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">Export Options</h3>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="exportPDF()">📄 Export PDF Report</button>
                        <button class="btn btn-success" onclick="exportExcel()">📊 Export to Excel</button>
                        <button class="btn btn-info" onclick="exportResults()">📝 Export Text Report</button>
                        <button class="btn btn-secondary" onclick="printReport()">🖨️ Print Report</button>
                    </div>
                    <div id="reportPreview" style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 10px; display: none;">
                        <h4 style="color: #1e3c72; margin-bottom: 15px;">Report Preview</h4>
                        <div id="reportContent"></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 16px; margin-top: 20px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">Visualizations</h3>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #64748b; margin-bottom: 15px;">Single-Line Diagram</h4>
                        <div id="singleLineDiagram" style="border: 2px solid #e1e8ed; border-radius: 8px; padding: 20px; min-height: 400px; background: white; overflow: auto;">
                            <p style="color: #94a3b8; text-align: center; padding: 50px;">Add components and calculate to generate diagram</p>
                        </div>
                        <div class="button-group" style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="generateSingleLineDiagram()">🔄 Regenerate Diagram</button>
                            <button class="btn btn-info" onclick="exportDiagramAsPNG()">💾 Export as PNG</button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                        <div>
                            <h4 style="color: #64748b; margin-bottom: 15px;">Fault Contribution Analysis</h4>
                            <canvas id="faultContributionChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="color: #64748b; margin-bottom: 15px;">Method Comparison</h4>
                            <canvas id="comparisonChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="helpTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Help & Documentation</h2>
                <div style="background: white; padding: 30px; border-radius: 16px;">
                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help1')">
                                📘 Getting Started
                            </h3>
                            <div id="help1" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>Step 1:</strong> Select your calculation standard (IEC 60909, IEEE 141, or ANSI)</p>
                                <p><strong>Step 2:</strong> Choose calculation method (Per-Unit, Point-to-Point, or Comparison)</p>
                                <p><strong>Step 3:</strong> Enter system voltage and frequency</p>
                                <p><strong>Step 4:</strong> Add components (transformers, cables, generators, motors, utility sources)</p>
                                <p><strong>Step 5:</strong> Click Calculate to see results and recommendations</p>
                            </div>
                        </div>
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help2')">
                                📊 Calculation Methods
                            </h3>
                            <div id="help2" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>Per-Unit Method:</strong> Traditional approach using normalized values (pu) on a base MVA. Best for complex systems.</p>
                                <p><strong>Point-to-Point Method:</strong> Direct impedance calculations from source to fault. Simpler for radial systems.</p>
                                <p><strong>Comparison Mode:</strong> Shows results from both methods side-by-side for verification.</p>
                            </div>
                        </div>
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help3')">
                                ⚡ Standards Overview
                            </h3>
                            <div id="help3" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>IEC 60909-0:</strong> International standard for short-circuit calculations. Uses voltage factor c and κ factor for peak current.</p>
                                <p><strong>IEEE 141 (Red Book):</strong> IEEE recommended practice for industrial/commercial power systems.</p>
                                <p><strong>IEEE C37.010:</strong> Application guide for AC high-voltage circuit breakers. Includes asymmetrical calculations.</p>
                                <p><strong>ANSI C37.5:</strong> Methods for determining values of sinusoidal current. Used for equipment rating.</p>
                            </div>
                        </div>
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help4')">
                                🛡️ Safety & Compliance
                            </h3>
                            <div id="help4" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>Arc Flash Analysis:</strong> Estimates incident energy and arc flash boundaries per IEEE 1584.</p>
                                <p><strong>PPE Selection:</strong> Recommends personal protective equipment based on calculated incident energy.</p>
                                <p><strong>Equipment Ratings:</strong> Verifies circuit breaker and equipment ratings against calculated fault currents.</p>
                                <p><strong>Code Compliance:</strong> Checks calculations against NEC and IEC requirements.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="busManagementTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Bus Management & System Configuration</h2>
                
                <!-- Add Bus Section -->
                <div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 25px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">🔌 Add New Bus</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Bus Name:</label>
                            <input type="text" id="busName" placeholder="e.g., Main Bus">
                        </div>
                        <div class="form-group">
                            <label>Voltage (V):</label>
                            <input type="number" id="busVoltage" placeholder="e.g., 400" step="1">
                        </div>
                        <div class="form-group">
                            <label>Bus Type:</label>
                            <select id="busType">
                                <option value="load">Load Bus</option>
                                <option value="source">Source Bus</option>
                                <option value="junction">Junction Bus</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="handleAddBus()">Add Bus</button>
                        </div>
                    </div>
                </div>
                
                <!-- Connect Buses Section -->
                <div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 25px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">🔗 Connect Buses</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>From Bus ID:</label>
                            <input type="number" id="bus1Id" placeholder="e.g., 1">
                        </div>
                        <div class="form-group">
                            <label>To Bus ID:</label>
                            <input type="number" id="bus2Id" placeholder="e.g., 2">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="handleConnectBuses()">Connect</button>
                        </div>
                    </div>
                </div>
                
                <!-- Bus List Display -->
                <div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1e3c72; margin: 0;">System Buses</h3>
                        <button class="btn btn-secondary" onclick="updateBusDisplay()">🔄 Refresh</button>
                    </div>
                    <div id="busList" style="min-height: 100px;">
                        <div style="text-align: center; color: #64748b; padding: 20px;">
                            No buses configured. Add a bus to get started.
                        </div>
                    </div>
                </div>
                
                <!-- System Diagram Display -->
                <div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 25px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">📊 System Diagram</h3>
                    <div id="systemDiagramContainer" style="min-height: 400px; background: #f8fafc; border-radius: 8px; border: 1px solid #e1e8ed; padding: 20px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 360px; color: #64748b;">
                            System diagram will appear here once buses are added
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="background: white; padding: 30px; border-radius: 16px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">⚡ Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn btn-primary" onclick="calculateAllBusFaults()">
                            ⚡ Calculate All Fault Currents
                        </button>
                        <button class="btn btn-primary" onclick="exportSystemConfiguration()">
                            💾 Export Configuration
                        </button>
                        <button class="btn btn-secondary" onclick="clearAllBuses()">
                            🗑️ Clear All Buses
                        </button>
                    </div>
                    <div id="faultCurrentResults" style="margin-top: 20px;">
                        <!-- Results will appear here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div id="voltageDropTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Voltage Drop Analysis</h2>
                
                <!-- Input Parameters -->
                <div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 25px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">📐 Circuit Parameters</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>System Voltage (V):</label>
                            <input type="number" id="voltageDropVoltage" placeholder="e.g., 400" step="1">
                        </div>
                        <div class="form-group">
                            <label>Load Current (A):</label>
                            <input type="number" id="voltageDropCurrent" placeholder="e.g., 100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Cable Length (m):</label>
                            <input type="number" id="voltageDropLength" placeholder="e.g., 50" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Conductor Size:</label>
                            <select id="conductorSize">
                                <option value="14">14 AWG</option>
                                <option value="12">12 AWG</option>
                                <option value="10" selected>10 AWG</option>
                                <option value="8">8 AWG</option>
                                <option value="6">6 AWG</option>
                                <option value="4">4 AWG</option>
                                <option value="2">2 AWG</option>
                                <option value="1/0">1/0 AWG</option>
                                <option value="2/0">2/0 AWG</option>
                                <option value="3/0">3/0 AWG</option>
                                <option value="4/0">4/0 AWG</option>
                                <option value="250">250 kcmil</option>
                                <option value="500">500 kcmil</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Conductor Material:</label>
                            <select id="conductorMaterial">
                                <option value="copper" selected>Copper</option>
                                <option value="aluminum">Aluminum</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Phase Type:</label>
                            <select id="phaseType">
                                <option value="three-phase" selected>Three-Phase</option>
                                <option value="single-phase">Single-Phase</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Power Factor:</label>
                            <input type="number" id="powerFactorVD" placeholder="e.g., 0.85" step="0.01" value="0.85" min="0.1" max="1.0">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="handleVoltageDropCalculation()">Calculate</button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Display -->
                <div id="voltageDropResults">
                    <!-- Results will be displayed here -->
                </div>
                
                <!-- Conductor Database Reference -->
                <div style="background: white; padding: 30px; border-radius: 16px; margin-top: 25px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">📚 Conductor Data Reference</h3>
                    <p style="color: #64748b; margin-bottom: 15px;">
                        Standard conductor resistance and reactance values at 75°C are used for calculations.
                        Values are based on NEC and IEEE standards.
                    </p>
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong>NEC Voltage Drop Limits:</strong><br>
                        • Feeder circuits: 3% recommended, 5% maximum<br>
                        • Branch circuits: 3% recommended, 5% maximum<br>
                        • Combined feeder + branch: 5% maximum
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let components = [];
        let calculationResults = null;
        let perUnitResults = null;
        let pointToPointResults = null;
        
        // Unit conversion constants
        const MM_TO_FEET = 304.8; // millimeters to feet conversion
        const MM_TO_INCHES = 25.4; // millimeters to inches conversion
        
        // Initialize global systems for enhanced features
        let globalBusSystem = null;
        let globalPowerSystem = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof BusSystem !== 'undefined') {
                globalBusSystem = new BusSystem();
                window.globalBusSystem = globalBusSystem;
            }
            if (typeof PowerSystem !== 'undefined') {
                globalPowerSystem = new PowerSystem();
                window.globalPowerSystem = globalPowerSystem;
            }
        });
        
        // ============================================================================
        // CALCULATION SAFETY MODULE - Zero-division and NaN protection
        // ============================================================================
        
        /**
         * Safe division with zero-division protection
         */
        function safeDivide(numerator, denominator, defaultValue = 0) {
            if (denominator === 0 || !isFinite(denominator) || isNaN(denominator)) {
                console.warn(`Division by zero or invalid denominator detected: ${numerator}/${denominator}`);
                return defaultValue;
            }
            const result = numerator / denominator;
            if (!isFinite(result) || isNaN(result)) {
                console.warn(`Invalid division result: ${numerator}/${denominator} = ${result}`);
                return defaultValue;
            }
            return result;
        }
        
        /**
         * Safe square root with NaN protection
         */
        function safeSqrt(value, defaultValue = 0) {
            if (value < 0 || isNaN(value)) {
                console.warn(`Invalid square root input: sqrt(${value})`);
                return defaultValue;
            }
            const result = Math.sqrt(value);
            if (!isFinite(result) || isNaN(result)) {
                console.warn(`Invalid square root result: sqrt(${value}) = ${result}`);
                return defaultValue;
            }
            return result;
        }
        
        /**
         * Validate calculation result for NaN/Infinity
         */
        function validateCalculationResult(value, name, minAllowed = 0, maxAllowed = 1e6) {
            if (isNaN(value)) {
                console.error(`NaN detected in calculation: ${name}`);
                return { valid: false, message: `Invalid calculation result for ${name}: NaN` };
            }
            if (!isFinite(value)) {
                console.error(`Infinity detected in calculation: ${name}`);
                return { valid: false, message: `Invalid calculation result for ${name}: Infinity` };
            }
            if (value < minAllowed || value > maxAllowed) {
                console.warn(`${name} out of expected range: ${value} (expected ${minAllowed}-${maxAllowed})`);
                return { valid: false, message: `${name} value ${value.toFixed(2)} is outside expected range (${minAllowed}-${maxAllowed})` };
            }
            return { valid: true };
        }
        
        /**
         * Sanity check for calculation results
         */
        function performSanityChecks(results) {
            const warnings = [];
            const errors = [];
            
            // Check symmetrical current
            const symmCheck = validateCalculationResult(results.iscSymm, 'Symmetrical Current', 0.001, 1000);
            if (!symmCheck.valid) errors.push(symmCheck.message);
            
            // Check asymmetrical current should be greater than symmetrical
            if (results.iscAsymm < results.iscSymm) {
                warnings.push('⚠️ Asymmetrical current is less than symmetrical current - this is unusual.');
            }
            
            // Check X/R ratio reasonableness
            if (results.xr < 0.01 || results.xr > 50) {
                warnings.push(`⚠️ X/R ratio ${results.xr.toFixed(2)} is outside typical range (0.01-50). Verify component data.`);
            }
            
            // Check fault MVA
            const mvaCheck = validateCalculationResult(results.faultMVA, 'Fault MVA', 0.001, 100000);
            if (!mvaCheck.valid) errors.push(mvaCheck.message);
            
            // Check impedance
            const zCheck = validateCalculationResult(results.impedance, 'Total Impedance', 0.0001, 1000);
            if (!zCheck.valid) errors.push(zCheck.message);
            
            // Arc flash sanity checks
            if (results.incidentEnergy !== undefined) {
                if (results.incidentEnergy < 1.2) {
                    warnings.push('✓ Incident energy below 1.2 cal/cm² threshold - minimal arc flash hazard.');
                } else if (results.incidentEnergy > 40) {
                    warnings.push('⚠️ HIGH HAZARD: Incident energy exceeds 40 cal/cm². Consider arc-resistant equipment.');
                }
            }
            
            return { warnings, errors };
        }
        
        // ============================================================================
        // STORAGE MODULE - Data Persistence with localStorage and IndexedDB
        // ============================================================================
        
        let autoSaveTimer = null;
        let hasUnsavedChanges = false;
        let projectHistory = [];
        
        // Initialize IndexedDB with Dexie.js (if available)
        let db = null;
        if (typeof Dexie !== 'undefined') {
            db = new Dexie('PowerSysProDB');
            db.version(1).stores({
                projects: '++id, name, created, modified',
                equipmentDatabase: '++id, type, name',
                settings: 'key',
                calculationHistory: '++id, projectId, timestamp'
            });
        } else {
            console.warn('Dexie.js not loaded - IndexedDB features disabled');
        }
        
        /**
         * Initialize auto-save functionality
         */
        function initializeAutoSave() {
            // Mark changes on any input
            document.addEventListener('input', () => {
                hasUnsavedChanges = true;
                scheduleAutoSave();
            });
            
            // Load recent projects on startup
            loadRecentProjects();
        }
        
        /**
         * Schedule auto-save after 30 seconds of inactivity
         */
        function scheduleAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                if (hasUnsavedChanges) {
                    autoSaveProject();
                }
            }, 30000); // 30 seconds
        }
        
        /**
         * Auto-save project to localStorage and IndexedDB
         */
        async function autoSaveProject() {
            try {
                const projectData = getCurrentProjectData();
                
                // Save to localStorage for quick recovery
                localStorage.setItem('autoSave', JSON.stringify(projectData));
                localStorage.setItem('autoSaveTimestamp', new Date().toISOString());
                
                // Save to IndexedDB for permanent storage
                await saveToIndexedDB(projectData);
                
                hasUnsavedChanges = false;
                showToast('Auto-saved successfully', 'success');
            } catch (error) {
                console.error('Auto-save failed:', error);
                showToast('Auto-save failed', 'error');
            }
        }
        
        /**
         * Get current project data
         */
        function getCurrentProjectData() {
            return {
                id: localStorage.getItem('currentProjectId') || generateUUID(),
                name: document.getElementById('projectName').value || 'Unnamed Project',
                created: localStorage.getItem('projectCreated') || new Date().toISOString(),
                modified: new Date().toISOString(),
                version: '2.0',
                standard: document.getElementById('calcStandard').value,
                method: document.getElementById('calcMethod').value,
                systemVoltage: parseFloat(document.getElementById('systemVoltage').value) || 0,
                systemFrequency: parseFloat(document.getElementById('systemFrequency').value) || 60,
                components: components,
                results: calculationResults,
                settings: getUserSettings()
            };
        }
        
        /**
         * Save project to IndexedDB
         */
        async function saveToIndexedDB(projectData) {
            if (!db) {
                console.warn('IndexedDB not available');
                return;
            }
            try {
                const existingProject = await db.projects.get(projectData.id);
                if (existingProject) {
                    await db.projects.update(projectData.id, projectData);
                } else {
                    await db.projects.add(projectData);
                }
                updateRecentProjects(projectData);
            } catch (error) {
                console.error('IndexedDB save error:', error);
                throw error;
            }
        }
        
        /**
         * Load recent projects
         */
        async function loadRecentProjects() {
            if (!db) return;
            try {
                const projects = await db.projects.orderBy('modified').reverse().limit(10).toArray();
                projectHistory = projects;
                updateRecentProjectsMenu();
            } catch (error) {
                console.error('Failed to load recent projects:', error);
            }
        }
        
        /**
         * Update recent projects menu
         */
        function updateRecentProjectsMenu() {
            const menu = document.getElementById('recentProjectsMenu');
            if (!menu) return;
            
            let html = '<h4>Recent Projects</h4>';
            if (projectHistory.length === 0) {
                html += '<p style="color: #888;">No recent projects</p>';
            } else {
                html += '<ul style="list-style: none; padding: 0;">';
                projectHistory.forEach(project => {
                    const date = new Date(project.modified).toLocaleDateString();
                    html += `<li style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" 
                             onclick="loadProjectById('${project.id}')">
                        <strong>${project.name}</strong><br>
                        <small style="color: #888;">${date}</small>
                    </li>`;
                });
                html += '</ul>';
            }
            menu.innerHTML = html;
        }
        
        /**
         * Load project by ID
         */
        async function loadProjectById(projectId) {
            if (!db) {
                showToast('IndexedDB not available', 'error');
                return;
            }
            try {
                const project = await db.projects.get(projectId);
                if (project) {
                    restoreProjectData(project);
                    showToast('Project loaded successfully', 'success');
                }
            } catch (error) {
                console.error('Failed to load project:', error);
                showToast('Failed to load project', 'error');
            }
        }
        
        /**
         * Restore project data
         */
        function restoreProjectData(project) {
            document.getElementById('projectName').value = project.name || '';
            document.getElementById('systemVoltage').value = project.systemVoltage || '';
            document.getElementById('calcStandard').value = project.standard || 'iec';
            document.getElementById('calcMethod').value = project.method || 'per-unit';
            document.getElementById('systemFrequency').value = project.systemFrequency || 60;
            components = project.components || [];
            calculationResults = project.results;
            localStorage.setItem('currentProjectId', project.id);
            localStorage.setItem('projectCreated', project.created);
            updateComponentList();
            if (calculationResults) displayResults();
        }
        
        /**
         * Update recent projects list
         */
        function updateRecentProjects(projectData) {
            const index = projectHistory.findIndex(p => p.id === projectData.id);
            if (index > -1) {
                projectHistory.splice(index, 1);
            }
            projectHistory.unshift(projectData);
            if (projectHistory.length > 10) {
                projectHistory = projectHistory.slice(0, 10);
            }
            updateRecentProjectsMenu();
        }
        
        /**
         * Get user settings
         */
        function getUserSettings() {
            return {
                theme: localStorage.getItem('theme') || 'light',
                units: localStorage.getItem('units') || 'metric',
                autoSave: localStorage.getItem('autoSave') !== 'false'
            };
        }
        
        /**
         * Generate UUID
         */
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        /**
         * Show toast notification
         */
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ============================================================================
        // ARC FLASH CALCULATION MODULE - IEEE 1584-2018
        // ============================================================================
        
        /**
         * Calculate arc flash energy using IEEE 1584-2018 method
         */
        function calculateArcFlash(params) {
            const {
                method = 'ieee1584-2018',
                voltage,
                boltedFaultCurrent,
                workingDistance,
                equipmentGap,
                enclosureType = 'VCB',
                arcDuration = 0.1
            } = params;
            
            if (method === 'ieee1584-2018') {
                return calculateArcFlash2018(voltage, boltedFaultCurrent, workingDistance, equipmentGap, enclosureType, arcDuration);
            } else {
                return calculateArcFlash2002(voltage, boltedFaultCurrent, workingDistance, equipmentGap, arcDuration);
            }
        }
        
        /**
         * IEEE 1584-2018 calculation
         */
        function calculateArcFlash2018(voltage, If, D, G, enclosure, t) {
            // Voltage in kV, current in kA, distance in mm, gap in mm, time in seconds
            const Voc = voltage; // System voltage in kV
            const Ibf = If; // Bolted fault current in kA
            
            // Determine if low voltage or medium voltage
            const isLowVoltage = Voc <= 1.0;
            
            let Iarc, E;
            
            if (isLowVoltage) {
                // Low voltage: 208V - 600V
                // Arcing current calculation for LV
                const k = -0.153;
                const a = 0.75;
                const b = -0.065;
                const c = 0;
                
                const logIarc = k + a * Math.log10(Ibf) + b * Math.log10(G);
                Iarc = Math.pow(10, logIarc);
                
                // Incident energy for VCB (Vertical Conductors in a Box)
                if (enclosure === 'VCB' || enclosure === 'VCBB') {
                    const k1 = -3.682;
                    const k2 = 0.959;
                    const k3 = 0;
                    const k4 = 0.524;
                    const k5 = -0.388;
                    const k6 = 0;
                    
                    const logE = k1 + k2 * Math.log10(Iarc) + k4 * Math.log10(D) + k5 * Math.log10(G);
                    E = Math.pow(10, logE) * (t / 0.2); // Normalize for time
                } else if (enclosure === 'HCB') {
                    // Horizontal Conductors in a Box
                    const k1 = -3.555;
                    const k2 = 0.959;
                    const k4 = 0.524;
                    const k5 = -0.388;
                    
                    const logE = k1 + k2 * Math.log10(Iarc) + k4 * Math.log10(D) + k5 * Math.log10(G);
                    E = Math.pow(10, logE) * (t / 0.2);
                } else {
                    // Open air or other configurations
                    const k1 = -3.682;
                    const k2 = 0.959;
                    const k4 = 0.524;
                    const k5 = -0.388;
                    
                    const logE = k1 + k2 * Math.log10(Iarc) + k4 * Math.log10(D) + k5 * Math.log10(G);
                    E = Math.pow(10, logE) * (t / 0.2);
                }
            } else {
                // Medium voltage: > 1kV to 15kV
                const k = 0.00402;
                const a = 1.081;
                
                Iarc = Math.pow(10, k + a * Math.log10(Ibf));
                
                // Incident energy for medium voltage
                const k1 = -0.792;
                const k2 = 0.555;
                const k4 = 0.501;
                
                const logE = k1 + k2 * Math.log10(Iarc) + k4 * Math.log10(D);
                E = Math.pow(10, logE) * (t / 0.2);
            }
            
            // Calculate arc flash boundary (AFB)
            const AFB = calculateArcFlashBoundary(E, D);
            
            // Determine PPE category based on incident energy
            const ppeCategory = getPPECategory(E);
            
            return {
                method: 'ieee1584-2018',
                voltage: Voc,
                boltedFaultCurrent: Ibf,
                arcingCurrent: Iarc,
                incidentEnergy: E,
                workingDistance: D,
                equipmentGap: G,
                arcFlashBoundary: AFB,
                ppeCategory: ppeCategory,
                arcDuration: t,
                enclosureType: enclosure
            };
        }
        
        /**
         * IEEE 1584-2002 calculation (legacy)
         */
        function calculateArcFlash2002(voltage, If, D, G, t) {
            // Simplified 2002 method
            const k = -0.153;
            const logIarc = k + 0.662 * Math.log10(If) + 0.0966 * Math.log10(voltage) + 0.000526 * G + 0.5588 * voltage - 0.00304 * G * voltage;
            const Iarc = Math.pow(10, logIarc);
            
            // Incident energy
            const logE = -0.555 + 0.662 * Math.log10(Iarc) + 0.0966 * Math.log10(voltage) + 0.000526 * G + 0.5588 * voltage - 0.00304 * G * voltage + Math.log10(t * 1000 / 0.2) - 1.473 * Math.log10(D);
            const E = 4.184 * Math.pow(10, logE);
            
            const AFB = calculateArcFlashBoundary(E, D);
            const ppeCategory = getPPECategory(E);
            
            return {
                method: 'ieee1584-2002',
                voltage: voltage,
                boltedFaultCurrent: If,
                arcingCurrent: Iarc,
                incidentEnergy: E,
                workingDistance: D,
                equipmentGap: G,
                arcFlashBoundary: AFB,
                ppeCategory: ppeCategory,
                arcDuration: t
            };
        }
        
        /**
         * Calculate arc flash from calculation results
         */
        function calculateArcFlashFromResults() {
            if (!calculationResults) {
                alert('Please complete a short circuit calculation first before performing arc flash analysis.');
                return;
            }
            
            // Get arc flash parameters from UI
            const workingDistance = parseFloat(document.getElementById('arcWorkingDistance').value);
            const equipmentGap = parseFloat(document.getElementById('arcEquipmentGap').value);
            const enclosureType = document.getElementById('arcEnclosureType').value;
            const arcDuration = parseFloat(document.getElementById('arcDuration').value);
            const grounding = document.getElementById('arcGrounding').value;
            
            // Get system voltage from original calculation
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value) / 1000; // Convert to kV
            const boltedFaultCurrent = calculationResults.iscSymm; // Already in kA
            
            // Perform arc flash calculation
            const arcFlashResults = calculateArcFlash({
                method: 'ieee1584-2018',
                voltage: systemVoltage,
                boltedFaultCurrent: boltedFaultCurrent,
                workingDistance: workingDistance,
                equipmentGap: equipmentGap,
                enclosureType: enclosureType,
                arcDuration: arcDuration
            });
            
            // Display results
            displayArcFlashResults(arcFlashResults, grounding);
        }
        
        /**
         * Display arc flash results
         */
        function displayArcFlashResults(results, grounding) {
            const safetyDiv = document.getElementById('safetyResults');
            
            // Check arc flash thresholds and generate warnings
            const arcFlashWarnings = [];
            const THRESHOLD_1_2 = 1.2; // cal/cm² - minimum PPE threshold
            const THRESHOLD_4 = 4.0;   // cal/cm² - Category 1 limit
            const THRESHOLD_8 = 8.0;   // cal/cm² - Category 2 limit
            const THRESHOLD_25 = 25.0; // cal/cm² - Category 3 limit
            const THRESHOLD_40 = 40.0; // cal/cm² - Category 4 limit
            
            if (results.incidentEnergy < THRESHOLD_1_2) {
                arcFlashWarnings.push({
                    level: 'info',
                    message: `✓ SAFE: Incident energy (${results.incidentEnergy.toFixed(2)} cal/cm²) is below 1.2 cal/cm² threshold. Minimal arc flash hazard.`
                });
            } else if (results.incidentEnergy >= THRESHOLD_1_2 && results.incidentEnergy < THRESHOLD_4) {
                arcFlashWarnings.push({
                    level: 'warning',
                    message: `⚠️ CAUTION: Incident energy (${results.incidentEnergy.toFixed(2)} cal/cm²) requires PPE Category 1 minimum.`
                });
            } else if (results.incidentEnergy >= THRESHOLD_4 && results.incidentEnergy < THRESHOLD_8) {
                arcFlashWarnings.push({
                    level: 'warning',
                    message: `⚠️ CAUTION: Incident energy (${results.incidentEnergy.toFixed(2)} cal/cm²) requires PPE Category 2.`
                });
            } else if (results.incidentEnergy >= THRESHOLD_8 && results.incidentEnergy < THRESHOLD_25) {
                arcFlashWarnings.push({
                    level: 'danger',
                    message: `⚠️ WARNING: Incident energy (${results.incidentEnergy.toFixed(2)} cal/cm²) requires PPE Category 3. Consider additional safety measures.`
                });
            } else if (results.incidentEnergy >= THRESHOLD_25 && results.incidentEnergy < THRESHOLD_40) {
                arcFlashWarnings.push({
                    level: 'danger',
                    message: `⚠️ WARNING: HIGH HAZARD - Incident energy (${results.incidentEnergy.toFixed(2)} cal/cm²) requires PPE Category 4.`
                });
            } else if (results.incidentEnergy >= THRESHOLD_40) {
                arcFlashWarnings.push({
                    level: 'critical',
                    message: `🚨 CRITICAL: EXTREME HAZARD - Incident energy (${results.incidentEnergy.toFixed(2)} cal/cm²) exceeds 40 cal/cm². Consider arc-resistant equipment, remote operation, or de-energization.`
                });
            }
            
            // Validate arc flash boundary
            if (results.arcFlashBoundary > 0) {
                const afbFeet = (results.arcFlashBoundary / MM_TO_FEET).toFixed(2);
                if (results.arcFlashBoundary > 3000) {
                    arcFlashWarnings.push({
                        level: 'danger',
                        message: `⚠️ Arc Flash Boundary extends to ${afbFeet} feet - unusually large. Verify calculation inputs.`
                    });
                }
            }
            
            // Build warnings HTML
            let warningsHtml = '';
            if (arcFlashWarnings.length > 0) {
                warningsHtml = '<div style="margin-bottom: 20px;">';
                arcFlashWarnings.forEach(warning => {
                    const bgColor = warning.level === 'info' ? '#d1fae5' : 
                                   warning.level === 'warning' ? '#fef3c7' : 
                                   warning.level === 'danger' ? '#fee2e2' : '#fecaca';
                    const borderColor = warning.level === 'info' ? '#10b981' : 
                                       warning.level === 'warning' ? '#f59e0b' : 
                                       warning.level === 'danger' ? '#ef4444' : '#dc2626';
                    warningsHtml += `<div style="padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; margin-bottom: 10px; border-radius: 6px; font-weight: 600;">${warning.message}</div>`;
                });
                warningsHtml += '</div>';
            }
            
            const html = `
                <div class="safety-analysis">
                    <h3 style="color: #991b1b; margin-bottom: 20px;">⚡ Arc Flash Analysis Results (IEEE 1584-2018)</h3>
                    
                    ${warningsHtml}
                    
                    <div class="executive-summary" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-color: #ef4444;">
                        <div class="summary-grid">
                            <div class="summary-card">
                                <div class="summary-card-label">Incident Energy</div>
                                <div class="summary-card-value" style="color: #dc2626;">${results.incidentEnergy.toFixed(2)} cal/cm²</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-card-label">Arc Flash Boundary</div>
                                <div class="summary-card-value" style="color: #dc2626;">${results.arcFlashBoundary.toFixed(0)} mm</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-card-label">PPE Category</div>
                                <div class="summary-card-value" style="color: #dc2626;">${results.ppeCategory}</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-card-label">Arcing Current</div>
                                <div class="summary-card-value" style="color: #dc2626;">${results.arcingCurrent.toFixed(2)} kA</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h4 style="color: #1e3c72; margin-bottom: 15px;">Calculation Parameters</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 10px; font-weight: 600;">System Voltage</td>
                                <td style="padding: 10px;">${results.voltage.toFixed(2)} kV</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 10px; font-weight: 600;">Bolted Fault Current</td>
                                <td style="padding: 10px;">${results.boltedFaultCurrent.toFixed(2)} kA</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 10px; font-weight: 600;">Working Distance</td>
                                <td style="padding: 10px;">${results.workingDistance} mm (${(results.workingDistance / 25.4).toFixed(1)} inches)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 10px; font-weight: 600;">Equipment Gap</td>
                                <td style="padding: 10px;">${results.equipmentGap} mm</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 10px; font-weight: 600;">Enclosure Type</td>
                                <td style="padding: 10px;">${results.enclosureType}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 10px; font-weight: 600;">Arc Duration</td>
                                <td style="padding: 10px;">${results.arcDuration} seconds (${(results.arcDuration * 60).toFixed(1)} cycles @ 60Hz)</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">Grounding Method</td>
                                <td style="padding: 10px;">${grounding.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="background: #fffbeb; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 15px;">⚠️ Safety Recommendations</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Required PPE:</strong> ${getPPEDescription(results.ppeCategory)}</li>
                            <li><strong>Arc Flash Boundary:</strong> Workers must maintain distance of at least ${results.arcFlashBoundary.toFixed(0)} mm from energized parts</li>
                            <li><strong>Warning Labels:</strong> Install arc flash warning labels showing incident energy and arc flash boundary</li>
                            <li><strong>Training:</strong> Ensure all workers are trained in arc flash hazards and proper PPE usage</li>
                            <li><strong>Work Practices:</strong> Use energized electrical work permits and job briefings before work</li>
                            ${results.incidentEnergy > 40 ? '<li><strong>⚠️ HIGH HAZARD:</strong> Incident energy exceeds 40 cal/cm². Consider de-energizing equipment or using remote racking systems.</li>' : ''}
                        </ul>
                    </div>
                </div>
            `;
            
            safetyDiv.innerHTML = html;
            
            // Show toast notification
            showToast('Arc flash analysis completed successfully', 'success');
        }
        
        /**
         * Calculate Arc Flash Boundary
         */
        function calculateArcFlashBoundary(incidentEnergy, workingDistance) {
            // AFB is where incident energy = 1.2 cal/cm²
            const E_threshold = 1.2;
            
            // Validate inputs
            if (incidentEnergy < E_threshold) {
                // No arc flash boundary needed if incident energy is below threshold
                return 0;
            }
            
            // E is proportional to 1/D²
            // E1/E2 = (D2/D1)²
            // AFB = D * sqrt(E / E_threshold)
            const AFB = workingDistance * safeSqrt(safeDivide(incidentEnergy, E_threshold, 1), 1);
            
            // Validate result
            if (!isFinite(AFB) || isNaN(AFB) || AFB < 0) {
                console.error('Invalid arc flash boundary calculation');
                return workingDistance; // Return working distance as fallback
            }
            
            return AFB;
        }
        
        /**
         * Get PPE Category based on incident energy (NFPA 70E)
         */
        function getPPECategory(incidentEnergy) {
            if (incidentEnergy < 1.2) return 0;
            if (incidentEnergy < 4) return 1;
            if (incidentEnergy < 8) return 2;
            if (incidentEnergy < 25) return 3;
            return 4;
        }
        
        /**
         * Get PPE description based on category
         */
        function getPPEDescription(category) {
            const descriptions = {
                0: 'Category 0 - Non-melting or untreated natural fiber clothing, safety glasses',
                1: 'Category 1 - Arc-rated FR shirt and pants (4 cal/cm²), arc-rated face shield, leather gloves',
                2: 'Category 2 - Arc-rated FR shirt and pants, arc flash suit jacket (8 cal/cm²), arc-rated face shield with balaclava',
                3: 'Category 3 - Arc-rated FR shirt and pants, arc flash suit (25 cal/cm²), arc-rated hood',
                4: 'Category 4 - Arc-rated FR shirt and pants, double-layer arc flash suit (40+ cal/cm²), arc-rated hood, heavy duty gloves'
            };
            return descriptions[category] || descriptions[4];
        }
        
        /**
         * Get PPE recommendations
         */
        function getPPERecommendations(category, incidentEnergy) {
            const recommendations = {
                0: {
                    clothing: 'Non-melting or untreated natural fiber (or arc-rated alternative)',
                    arcRating: '0 cal/cm²',
                    faceShield: 'Safety glasses with side shields (or arc-rated face shield)',
                    gloves: 'Leather work gloves (or arc-rated alternative)',
                    hearing: 'Hearing protection required (per NFPA 70E-2024)',
                    other: 'Safety glasses, verify equipment ratings'
                },
                1: {
                    clothing: 'Arc-rated FR shirt and pants (or equivalent arc-rated materials)',
                    arcRating: '4 cal/cm²',
                    faceShield: 'Arc-rated face shield',
                    gloves: 'Leather or arc-rated gloves (meeting minimum arc rating)',
                    hearing: 'Hearing protection required (per NFPA 70E-2024)',
                    other: 'Hard hat, safety glasses, verify equipment ratings'
                },
                2: {
                    clothing: 'Arc-rated FR shirt and pants, arc flash suit jacket (or equivalent)',
                    arcRating: '8 cal/cm²',
                    faceShield: 'Arc-rated face shield with balaclava (or equivalent hood)',
                    gloves: 'Arc-rated gloves (meeting minimum arc rating)',
                    hearing: 'Hearing protection required (per NFPA 70E-2024)',
                    other: 'Hard hat, safety glasses, verify equipment ratings'
                },
                3: {
                    clothing: 'Arc-rated FR shirt and pants, arc flash suit (or equivalent layers)',
                    arcRating: '25 cal/cm²',
                    faceShield: 'Arc-rated hood (meeting minimum arc rating)',
                    gloves: 'Arc-rated gloves (meeting minimum arc rating)',
                    hearing: 'Hearing protection required (per NFPA 70E-2024)',
                    other: 'Hard hat, safety glasses, verify equipment ratings'
                },
                4: {
                    clothing: 'Arc-rated FR shirt and pants, double-layer arc flash suit (or equivalent)',
                    arcRating: '40+ cal/cm²',
                    faceShield: 'Arc-rated hood (meeting minimum arc rating)',
                    gloves: 'Arc-rated gloves (heavy duty, meeting minimum arc rating)',
                    hearing: 'Hearing protection required (per NFPA 70E-2024)',
                    other: 'Hard hat, safety glasses, leather work boots, verify equipment ratings'
                }
            };
            
            return recommendations[category] || recommendations[4];
        }
        
        /**
         * Calculate NFPA 70E approach boundaries
         */
        function calculateApproachBoundaries(voltage) {
            // Voltage in kV, returns boundaries in mm
            const V = voltage * 1000; // Convert to volts
            
            let limited, restricted, prohibited;
            
            if (V <= 750) {
                limited = 3050; // 10 ft
                restricted = 305; // 1 ft
                prohibited = 0; // Contact
            } else if (V <= 15000) {
                limited = 3050;
                restricted = 610; // 2 ft
                prohibited = 305; // 1 ft
            } else if (V <= 36000) {
                limited = 3050;
                restricted = 910; // 3 ft
                prohibited = 610; // 2 ft
            } else if (V <= 72500) {
                limited = 3660; // 12 ft
                restricted = 1070; // 3 ft 6 in
                prohibited = 760; // 2 ft 6 in
            } else {
                limited = 4570; // 15 ft
                restricted = 1520; // 5 ft
                prohibited = 1070; // 3 ft 6 in
            }
            
            return {
                limited: limited,
                restricted: restricted,
                prohibited: prohibited
            };
        }
        
        // ============================================================================
        // VALIDATION MODULE - Real-time Input Validation
        // ============================================================================
        
        /**
         * Enhanced validation with visual feedback
         */
        function validateInputEnhanced(element, fieldName) {
            const value = element.value;
            const validation = validateInput(value, fieldName);
            
            // Remove existing feedback
            const existingFeedback = element.parentNode.querySelector('.validation-feedback');
            if (existingFeedback) existingFeedback.remove();
            
            // Create feedback element
            const feedback = document.createElement('div');
            feedback.className = 'validation-feedback';
            feedback.style.cssText = 'margin-top: 5px; font-size: 12px;';
            
            if (validation.valid) {
                element.style.borderColor = '#10b981';
                feedback.innerHTML = '<span style="color: #10b981;">✓ Valid</span>';
            } else {
                element.style.borderColor = '#ef4444';
                feedback.innerHTML = `<span style="color: #ef4444;">✗ ${validation.message}</span>`;
            }
            
            element.parentNode.appendChild(feedback);
            
            // Check for warnings
            checkForWarnings(element, value);
            
            return validation.valid;
        }
        
        /**
         * Check for unrealistic values and show warnings
         */
        function checkForWarnings(element, value) {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return;
            
            let warning = null;
            
            // Check for unrealistic values based on field type
            if (element.id === 'systemVoltage') {
                if (numValue > 1000000) warning = 'Voltage > 1000 kV is uncommon';
                if (numValue < 100) warning = 'Voltage < 100 V is very low';
            } else if (element.id.includes('Impedance')) {
                if (numValue === 0) warning = 'Zero impedance is unrealistic';
                if (numValue > 50) warning = 'Impedance > 50% is unusually high';
            } else if (element.id.includes('Power')) {
                if (numValue > 100) warning = 'Power > 100 MVA is very large';
                if (numValue < 0.01) warning = 'Power < 10 kVA is very small';
            }
            
            if (warning) {
                const warningEl = document.createElement('div');
                warningEl.className = 'validation-warning';
                warningEl.style.cssText = 'margin-top: 5px; font-size: 12px; color: #f59e0b;';
                warningEl.innerHTML = `<span>⚠ ${warning}</span>`;
                element.parentNode.appendChild(warningEl);
            }
        }
        
        /**
         * Unit conversion
         */
        function convertUnit(value, fromUnit, toUnit, type) {
            const conversions = {
                voltage: {
                    'V': 1,
                    'kV': 1000,
                    'MV': 1000000
                },
                current: {
                    'A': 1,
                    'kA': 1000
                },
                power: {
                    'W': 1,
                    'kW': 1000,
                    'MW': 1000000,
                    'MVA': 1000000
                },
                impedance: {
                    'Ω': 1,
                    'mΩ': 0.001
                },
                length: {
                    'm': 1,
                    'km': 1000,
                    'ft': 0.3048
                }
            };
            
            if (!conversions[type]) return value;
            
            const fromFactor = conversions[type][fromUnit] || 1;
            const toFactor = conversions[type][toUnit] || 1;
            
            return value * fromFactor / toFactor;
        }
        
        /**
         * Cross-validation checks
         */
        function performCrossValidation() {
            const warnings = [];
            
            components.forEach((comp, index) => {
                if (comp.type === 'transformer') {
                    // Check transformer MVA vs impedance consistency
                    const power = parseFloat(comp.power);
                    const impedance = parseFloat(comp.impedance);
                    
                    if (power < 1 && impedance > 8) {
                        warnings.push(`Component ${index + 1}: Small transformer with high impedance`);
                    }
                    if (power > 10 && impedance < 4) {
                        warnings.push(`Component ${index + 1}: Large transformer with low impedance`);
                    }
                }
                
                if (comp.type === 'cable') {
                    // Check cable length vs impedance drop
                    const length = parseFloat(comp.length);
                    const resistance = parseFloat(comp.resistance);
                    
                    if (length > 1000 && resistance < 0.1) {
                        warnings.push(`Component ${index + 1}: Long cable with very low resistance`);
                    }
                }
                
                if (comp.type === 'motor') {
                    // Check motor contribution vs motor size
                    const power = parseFloat(comp.power);
                    const reactance = parseFloat(comp.reactance);
                    
                    if (power > 10 && reactance > 25) {
                        warnings.push(`Component ${index + 1}: Large motor with high reactance`);
                    }
                }
            });
            
            return warnings;
        }
        
        // ============================================================================
        // KEYBOARD SHORTCUTS MODULE
        // ============================================================================
        
        /**
         * Initialize keyboard shortcuts
         */
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+S: Save project
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveProject();
                }
                
                // Ctrl+E: Export results
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportResults();
                }
                
                // Ctrl+N: New project
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    newProject();
                }
                
                // Ctrl+C: Calculate
                if (e.ctrlKey && e.key === 'c') {
                    e.preventDefault();
                    calculate();
                }
                
                // F1: Help
                if (e.key === 'F1') {
                    e.preventDefault();
                    showHelp();
                }
                
                // Esc: Close modals
                if (e.key === 'Escape') {
                    closeAllModals();
                }
                
                // ?: Show shortcuts
                if (e.shiftKey && e.key === '?') {
                    e.preventDefault();
                    showShortcutsLegend();
                }
            });
        }
        
        /**
         * New project
         */
        function newProject() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Create new project?')) {
                    return;
                }
            }
            
            document.getElementById('projectName').value = '';
            document.getElementById('systemVoltage').value = '';
            document.getElementById('calcStandard').value = 'iec';
            document.getElementById('calcMethod').value = 'per-unit';
            document.getElementById('systemFrequency').value = '60';
            components = [];
            calculationResults = null;
            localStorage.removeItem('currentProjectId');
            localStorage.removeItem('projectCreated');
            updateComponentList();
            document.getElementById('results').innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 50px 20px; font-size: 15px;">Add components and click <strong>Calculate</strong> to see comprehensive results</p>';
            showToast('New project created', 'success');
        }
        
        /**
         * Show help documentation
         */
        function showHelp() {
            switchTab('help');
        }
        
        /**
         * Close all modals
         */
        function closeAllModals() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('databaseModal').style.display = 'none';
            const shortcutsModal = document.getElementById('shortcutsModal');
            if (shortcutsModal) shortcutsModal.style.display = 'none';
        }
        
        /**
         * Show shortcuts legend
         */
        function showShortcutsLegend() {
            const modal = document.createElement('div');
            modal.id = 'shortcutsModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Keyboard Shortcuts</h2>
                        <button class="close" onclick="closeAllModals()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>Ctrl+S</strong></td>
                                <td style="padding: 10px;">Save project</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>Ctrl+E</strong></td>
                                <td style="padding: 10px;">Export results</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>Ctrl+N</strong></td>
                                <td style="padding: 10px;">New project</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>Ctrl+C</strong></td>
                                <td style="padding: 10px;">Calculate</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>F1</strong></td>
                                <td style="padding: 10px;">Help documentation</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>Esc</strong></td>
                                <td style="padding: 10px;">Close modals</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px;"><strong>?</strong></td>
                                <td style="padding: 10px;">Show this legend</td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAllModals()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Equipment Database
        const equipmentDatabase = {
            transformers: [
                { name: '500 kVA', power: 0.5, impedance: 5.5, primaryV: 13.8, secondaryV: 0.48 },
                { name: '750 kVA', power: 0.75, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '1000 kVA', power: 1.0, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '1500 kVA', power: 1.5, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '2000 kVA', power: 2.0, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '2500 kVA', power: 2.5, impedance: 6.0, primaryV: 13.8, secondaryV: 0.48 },
            ],
            cables: [
                { name: '4/0 AWG CU', resistance: 0.249, reactance: 0.082, type: 'single' },
                { name: '250 MCM CU', resistance: 0.194, reactance: 0.079, type: 'single' },
                { name: '350 MCM CU', resistance: 0.139, reactance: 0.075, type: 'single' },
                { name: '500 MCM CU', resistance: 0.097, reactance: 0.072, type: 'single' },
                { name: '750 MCM CU', resistance: 0.065, reactance: 0.069, type: 'single' },
            ],
            generators: [
                { name: '1 MVA Gen', power: 1.0, reactance: 15, voltage: 0.48, rx: 0.1 },
                { name: '2 MVA Gen', power: 2.0, reactance: 15, voltage: 0.48, rx: 0.1 },
                { name: '5 MVA Gen', power: 5.0, reactance: 15, voltage: 4.16, rx: 0.1 },
            ]
        };
        
        // Validation rules
        const validationRules = {
            systemVoltage: { min: 100, max: 1000000, required: true },
            power: { min: 0.001, max: 10000, required: true },
            impedance: { min: 0.01, max: 100, required: true },
            voltage: { min: 0.1, max: 1000, required: true },
            rx: { min: 0.001, max: 100 },
            xr: { min: 0.001, max: 100 },
            frequency: { min: 50, max: 60, required: true }
        };
        
        // Common HTML for voltage zone selector
        const voltageZoneSelector = `
            <div class="form-group">
                <label>Voltage Zone:
                    <span class="help-tooltip">
                        <span class="help-icon">?</span>
                        <span class="help-text">Voltage level at which this component operates. LV: ≤1kV, MV: 1-35kV, HV: >35kV</span>
                    </span>
                </label>
                <select id="compVoltageZone">
                    <option value="lv">Low Voltage (LV) - ≤1 kV</option>
                    <option value="mv">Medium Voltage (MV) - 1-35 kV</option>
                    <option value="hv">High Voltage (HV) - >35 kV</option>
                </select>
            </div>
        `;
        
        const componentInputTemplates = {
            transformer: `
                ${voltageZoneSelector}
                <div class="form-group">
                    <label>Rated Power (MVA):</label>
                    <input type="number" id="compPower" placeholder="e.g., 1.5" step="0.01">
                </div>
                <div class="form-group">
                    <label>Impedance (%):</label>
                    <input type="number" id="compImpedance" placeholder="e.g., 5.75" step="0.01">
                    <div class="info-text">As per nameplate (typically at rated MVA)</div>
                </div>
                <div class="form-group">
                    <label>Primary Voltage (kV):</label>
                    <input type="number" id="compPrimaryV" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>Secondary Voltage (kV):</label>
                    <input type="number" id="compSecondaryV" placeholder="e.g., 0.48" step="0.01">
                </div>
                <div class="form-group">
                    <label>R/X Ratio (optional):</label>
                    <input type="number" id="compRX" placeholder="e.g., 0.1" step="0.01">
                    <div class="info-text">Leave empty for typical value based on size</div>
                </div>
            `,
            cable: `
                ${voltageZoneSelector}
                <div class="form-group">
                    <label>Length (meters):</label>
                    <input type="number" id="compLength" placeholder="e.g., 100" step="0.1">
                </div>
                <div class="form-group">
                    <label>Resistance (Ω/km) @ 20°C:</label>
                    <input type="number" id="compResistance" placeholder="e.g., 0.387" step="0.001">
                    <div class="info-text">Resistance at 20°C reference temperature</div>
                </div>
                <div class="form-group">
                    <label>Operating Temperature (°C):</label>
                    <select id="compOperatingTemp">
                        <option value="20">20°C (Reference)</option>
                        <option value="75" selected>75°C (Typical)</option>
                        <option value="90">90°C (High Load)</option>
                    </select>
                    <div class="info-text">Temperature correction will be applied automatically</div>
                </div>
                <div class="form-group">
                    <label>Reactance (Ω/km):</label>
                    <input type="number" id="compReactance" placeholder="e.g., 0.082" step="0.001">
                    <div class="info-text">X at system frequency</div>
                </div>
                <div class="form-group">
                    <label>Cable Type:</label>
                    <select id="compCableType">
                        <option value="single">Single Core</option>
                        <option value="multi">Multi Core</option>
                    </select>
                </div>
            `,
            generator: `
                ${voltageZoneSelector}
                <div class="form-group">
                    <label>Rated Power (MVA):</label>
                    <input type="number" id="compPower" placeholder="e.g., 2.0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Subtransient Reactance X"d (%):</label>
                    <input type="number" id="compReactance" placeholder="e.g., 15" step="0.1">
                    <div class="info-text">Direct-axis subtransient reactance from nameplate</div>
                </div>
                <div class="form-group">
                    <label>Rated Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 0.48" step="0.01">
                </div>
                <div class="form-group">
                    <label>R/X Ratio:</label>
                    <input type="number" id="compRX" placeholder="e.g., 0.05" step="0.01">
                    <div class="info-text">Typical: 0.05-0.15 for synchronous generators</div>
                </div>
            `,
            motor: `
                <div class="form-group">
                    <label>Rated Power (HP or kW):</label>
                    <input type="number" id="compPower" placeholder="e.g., 100" step="0.1">
                </div>
                <div class="form-group">
                    <label>Power Unit:</label>
                    <select id="compPowerUnit">
                        <option value="hp">Horsepower (HP)</option>
                        <option value="kw">Kilowatts (kW)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Locked Rotor Current (x FLA):</label>
                    <input type="number" id="compLRC" placeholder="e.g., 6" step="0.1">
                    <div class="info-text">Typically 5-7 for induction motors (Code Letter)</div>
                </div>
                <div class="form-group">
                    <label>Rated Voltage (V):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 480" step="1">
                </div>
                <div class="form-group">
                    <label>Efficiency (%):</label>
                    <input type="number" id="compEfficiency" placeholder="e.g., 90" step="0.1" value="90">
                </div>
                <div class="form-group">
                    <label>Power Factor:</label>
                    <input type="number" id="compPF" placeholder="e.g., 0.85" step="0.01" value="0.85">
                </div>
            `,
            utility_isc: `
                ${voltageZoneSelector}
                <div class="form-group">
                    <label>Available Short Circuit Current (kA):</label>
                    <input type="number" id="compISC" placeholder="e.g., 50" step="0.1">
                    <div class="info-text">Three-phase fault current from utility</div>
                </div>
                <div class="form-group">
                    <label>System Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>X/R Ratio:</label>
                    <input type="number" id="compXR" placeholder="e.g., 10" step="0.1">
                    <div class="info-text">Typical: 10-20 for utility systems</div>
                </div>
            `,
            utility_mva: `
                ${voltageZoneSelector}
                <div class="form-group">
                    <label>Available Fault MVA:</label>
                    <input type="number" id="compMVA" placeholder="e.g., 500" step="0.1">
                    <div class="info-text">Three-phase fault MVA from utility</div>
                </div>
                <div class="form-group">
                    <label>System Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>X/R Ratio:</label>
                    <input type="number" id="compXR" placeholder="e.g., 10" step="0.1">
                    <div class="info-text">Typical: 10-20 for utility systems</div>
                </div>
            `,
            utility_impedance: `
                ${voltageZoneSelector}
                <div class="form-group">
                    <label>Source Impedance (%):</label>
                    <input type="number" id="compImpedance" placeholder="e.g., 5" step="0.01">
                    <div class="info-text">Percent impedance on base MVA</div>
                </div>
                <div class="form-group">
                    <label>Base MVA:</label>
                    <input type="number" id="compBaseMVA" placeholder="e.g., 100" step="0.1">
                </div>
                <div class="form-group">
                    <label>System Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>X/R Ratio:</label>
                    <input type="number" id="compXR" placeholder="e.g., 10" step="0.1">
                    <div class="info-text">Typical: 10-20 for utility systems</div>
                </div>
            `,
            distribution_board: `
                <div class="form-group">
                    <label>Board Rating (A):</label>
                    <input type="number" id="compRating" placeholder="e.g., 800" step="1">
                </div>
                <div class="form-group">
                    <label>Rated Voltage (V):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 480" step="1">
                </div>
                <div class="form-group">
                    <label>Number of Outgoing Circuits:</label>
                    <input type="number" id="compCircuits" placeholder="e.g., 12" step="1">
                </div>
                <div class="form-group">
                    <label>Busbar Material:</label>
                    <select id="compBusbarMaterial">
                        <option value="copper">Copper</option>
                        <option value="aluminum">Aluminum</option>
                    </select>
                </div>
            `,
            switchgear: `
                <div class="form-group">
                    <label>Rated Current (A):</label>
                    <input type="number" id="compRating" placeholder="e.g., 2000" step="1">
                </div>
                <div class="form-group">
                    <label>Rated Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>Short Circuit Rating (kA):</label>
                    <input type="number" id="compSCRating" placeholder="e.g., 40" step="0.1">
                </div>
                <div class="form-group">
                    <label>Switchgear Type:</label>
                    <select id="compSwitchgearType">
                        <option value="air_insulated">Air Insulated (AIS)</option>
                        <option value="gas_insulated">Gas Insulated (GIS)</option>
                        <option value="metal_enclosed">Metal Enclosed</option>
                    </select>
                </div>
            `,
            mcc: `
                <div class="form-group">
                    <label>MCC Rating (A):</label>
                    <input type="number" id="compRating" placeholder="e.g., 1200" step="1">
                </div>
                <div class="form-group">
                    <label>Rated Voltage (V):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 480" step="1">
                </div>
                <div class="form-group">
                    <label>Number of Buckets:</label>
                    <input type="number" id="compBuckets" placeholder="e.g., 24" step="1">
                </div>
                <div class="form-group">
                    <label>Control Method:</label>
                    <select id="compControlMethod">
                        <option value="dol">Direct On-Line (DOL)</option>
                        <option value="star_delta">Star-Delta</option>
                        <option value="vfd">Variable Frequency Drive (VFD)</option>
                        <option value="soft_starter">Soft Starter</option>
                    </select>
                </div>
            `,
            load_center: `
                <div class="form-group">
                    <label>Load Center Rating (A):</label>
                    <input type="number" id="compRating" placeholder="e.g., 600" step="1">
                </div>
                <div class="form-group">
                    <label>Rated Voltage (V):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 208" step="1">
                </div>
                <div class="form-group">
                    <label>Number of Breakers:</label>
                    <input type="number" id="compBreakers" placeholder="e.g., 42" step="1">
                </div>
                <div class="form-group">
                    <label>Configuration:</label>
                    <select id="compConfiguration">
                        <option value="single_phase">Single Phase</option>
                        <option value="three_phase">Three Phase</option>
                    </select>
                </div>
            `,
            reactor: `
                <div class="form-group">
                    <label>Rated Power (MVAR):</label>
                    <input type="number" id="compPower" placeholder="e.g., 5.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Reactance (%):</label>
                    <input type="number" id="compReactance" placeholder="e.g., 6.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Rated Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>Reactor Type:</label>
                    <select id="compReactorType">
                        <option value="current_limiting">Current Limiting</option>
                        <option value="filter">Filter Reactor</option>
                        <option value="smoothing">Smoothing Reactor</option>
                    </select>
                </div>
            `,
            capacitor_bank: `
                <div class="form-group">
                    <label>Rated Power (MVAR):</label>
                    <input type="number" id="compPower" placeholder="e.g., 2.5" step="0.1">
                </div>
                <div class="form-group">
                    <label>Rated Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>Number of Steps:</label>
                    <input type="number" id="compSteps" placeholder="e.g., 4" step="1">
                </div>
                <div class="form-group">
                    <label>Connection Type:</label>
                    <select id="compConnectionType">
                        <option value="star">Star (Wye)</option>
                        <option value="delta">Delta</option>
                    </select>
                </div>
            `,
            ups: `
                <div class="form-group">
                    <label>Rated Power (kVA):</label>
                    <input type="number" id="compPower" placeholder="e.g., 100" step="0.1">
                </div>
                <div class="form-group">
                    <label>Output Voltage (V):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 480" step="1">
                </div>
                <div class="form-group">
                    <label>Backup Time (minutes):</label>
                    <input type="number" id="compBackupTime" placeholder="e.g., 30" step="1">
                </div>
                <div class="form-group">
                    <label>UPS Configuration:</label>
                    <select id="compUPSConfig">
                        <option value="online">Online/Double Conversion</option>
                        <option value="line_interactive">Line Interactive</option>
                        <option value="offline">Offline/Standby</option>
                    </select>
                </div>
            `,
            surge_protection: `
                <div class="form-group">
                    <label>Maximum Continuous Operating Voltage (MCOV) (V):</label>
                    <input type="number" id="compMCOV" placeholder="e.g., 550" step="1">
                </div>
                <div class="form-group">
                    <label>Voltage Protection Level (VPL) (V):</label>
                    <input type="number" id="compVPL" placeholder="e.g., 1200" step="1">
                </div>
                <div class="form-group">
                    <label>Discharge Current (kA):</label>
                    <input type="number" id="compDischargeCurrent" placeholder="e.g., 40" step="0.1">
                </div>
                <div class="form-group">
                    <label>SPD Type:</label>
                    <select id="compSPDType">
                        <option value="type1">Type 1 (Class I)</option>
                        <option value="type2">Type 2 (Class II)</option>
                        <option value="type3">Type 3 (Class III)</option>
                    </select>
                </div>
            `,
            harmonic_filter: `
                <div class="form-group">
                    <label>Filter Rating (MVAR):</label>
                    <input type="number" id="compPower" placeholder="e.g., 3.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Tuned Harmonic Order:</label>
                    <input type="number" id="compHarmonicOrder" placeholder="e.g., 5" step="1">
                    <div class="info-text">Common: 5th, 7th, 11th, 13th</div>
                </div>
                <div class="form-group">
                    <label>Rated Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>Filter Type:</label>
                    <select id="compFilterType">
                        <option value="passive">Passive Filter</option>
                        <option value="active">Active Filter</option>
                        <option value="hybrid">Hybrid Filter</option>
                    </select>
                </div>
            `
        };
        
        // Tab switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const navTabs = document.querySelectorAll('.nav-tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            navTabs.forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Toggle accordion
        function toggleAccordion(id) {
            const element = document.getElementById(id);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        // Update method options based on standard
        function updateMethodOptions() {
            const standard = document.getElementById('calcStandard').value;
            const iecControls = document.getElementById('iecControls');
            
            // Show IEC-specific controls only when IEC standard is selected
            if (iecControls) {
                iecControls.style.display = standard === 'iec' ? 'block' : 'none';
            }
        }
        
        // Input validation
        function validateInput(value, fieldName) {
            const rules = validationRules[fieldName];
            if (!rules) return { valid: true };
            
            if (rules.required && (!value || value === '')) {
                return { valid: false, message: 'This field is required' };
            }
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                return { valid: false, message: 'Please enter a valid number' };
            }
            
            if (rules.min !== undefined && numValue < rules.min) {
                return { valid: false, message: `Value must be at least ${rules.min}` };
            }
            
            if (rules.max !== undefined && numValue > rules.max) {
                return { valid: false, message: `Value must be at most ${rules.max}` };
            }
            
            return { valid: true };
        }
        
        // Load equipment database into UI
        function loadEquipmentDatabase() {
            const transformerDB = document.getElementById('transformerDB');
            const cableDB = document.getElementById('cableDB');
            const generatorDB = document.getElementById('generatorDB');
            
            equipmentDatabase.transformers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'database-item';
                div.innerHTML = `<strong>${item.name}</strong><br><small>${item.impedance}% Z</small>`;
                div.onclick = () => loadFromDatabase('transformer', item);
                transformerDB.appendChild(div);
            });
            
            equipmentDatabase.cables.forEach(item => {
                const div = document.createElement('div');
                div.className = 'database-item';
                div.innerHTML = `<strong>${item.name}</strong><br><small>${item.resistance} Ω/km</small>`;
                div.onclick = () => loadFromDatabase('cable', item);
                cableDB.appendChild(div);
            });
            
            equipmentDatabase.generators.forEach(item => {
                const div = document.createElement('div');
                div.className = 'database-item';
                div.innerHTML = `<strong>${item.name}</strong><br><small>${item.reactance}% X"d</small>`;
                div.onclick = () => loadFromDatabase('generator', item);
                generatorDB.appendChild(div);
            });
        }
        
        function loadFromDatabase(type, data) {
            document.getElementById('componentType').value = type;
            document.getElementById('componentInputs').innerHTML = componentInputTemplates[type];
            
            // Populate fields based on type
            setTimeout(() => {
                if (type === 'transformer') {
                    document.getElementById('compPower').value = data.power;
                    document.getElementById('compImpedance').value = data.impedance;
                    document.getElementById('compPrimaryV').value = data.primaryV;
                    document.getElementById('compSecondaryV').value = data.secondaryV;
                } else if (type === 'cable') {
                    document.getElementById('compResistance').value = data.resistance;
                    document.getElementById('compReactance').value = data.reactance;
                    document.getElementById('compCableType').value = data.type;
                } else if (type === 'generator') {
                    document.getElementById('compPower').value = data.power;
                    document.getElementById('compReactance').value = data.reactance;
                    document.getElementById('compVoltage').value = data.voltage;
                    document.getElementById('compRX').value = data.rx;
                }
                switchTab('calculator');
            }, 100);
        }
        
        document.getElementById('componentType').addEventListener('change', function() {
            document.getElementById('componentInputs').innerHTML = componentInputTemplates[this.value];
        });
        
        document.getElementById('componentInputs').innerHTML = componentInputTemplates['transformer'];
        
        // Initialize equipment database on load
        window.addEventListener('load', function() {
            loadEquipmentDatabase();
        });
        
        function addComponent() {
            const type = document.getElementById('componentType').value;
            const component = { type: type };
            
            // Capture voltage zone if present
            const voltageZoneEl = document.getElementById('compVoltageZone');
            if (voltageZoneEl) {
                component.voltageZone = voltageZoneEl.value;
            }
            
            // Capture operating temperature for cables if present
            const tempEl = document.getElementById('compOperatingTemp');
            if (tempEl && tempEl.value) {
                component.operatingTemp = parseFloat(tempEl.value);
            }
            
            if (type === 'transformer') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.impedance = parseFloat(document.getElementById('compImpedance').value);
                component.primaryV = parseFloat(document.getElementById('compPrimaryV').value);
                component.secondaryV = parseFloat(document.getElementById('compSecondaryV').value);
                component.rx = document.getElementById('compRX').value ? parseFloat(document.getElementById('compRX').value) : null;
            } else if (type === 'cable') {
                component.length = parseFloat(document.getElementById('compLength').value);
                component.resistance = parseFloat(document.getElementById('compResistance').value);
                component.reactance = parseFloat(document.getElementById('compReactance').value);
                component.cableType = document.getElementById('compCableType').value;
            } else if (type === 'generator') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.reactance = parseFloat(document.getElementById('compReactance').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.rx = parseFloat(document.getElementById('compRX').value);
            } else if (type === 'motor') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.powerUnit = document.getElementById('compPowerUnit').value;
                component.lrc = parseFloat(document.getElementById('compLRC').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.efficiency = parseFloat(document.getElementById('compEfficiency').value);
                component.pf = parseFloat(document.getElementById('compPF').value);
            } else if (type === 'utility_isc') {
                component.isc = parseFloat(document.getElementById('compISC').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.xr = parseFloat(document.getElementById('compXR').value);
            } else if (type === 'utility_mva') {
                component.mva = parseFloat(document.getElementById('compMVA').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.xr = parseFloat(document.getElementById('compXR').value);
            } else if (type === 'utility_impedance') {
                component.impedance = parseFloat(document.getElementById('compImpedance').value);
                component.baseMVA = parseFloat(document.getElementById('compBaseMVA').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.xr = parseFloat(document.getElementById('compXR').value);
            } else if (type === 'distribution_board') {
                component.rating = parseFloat(document.getElementById('compRating').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.circuits = parseInt(document.getElementById('compCircuits').value);
                component.busbarMaterial = document.getElementById('compBusbarMaterial').value;
            } else if (type === 'switchgear') {
                component.rating = parseFloat(document.getElementById('compRating').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.scRating = parseFloat(document.getElementById('compSCRating').value);
                component.switchgearType = document.getElementById('compSwitchgearType').value;
            } else if (type === 'mcc') {
                component.rating = parseFloat(document.getElementById('compRating').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.buckets = parseInt(document.getElementById('compBuckets').value);
                component.controlMethod = document.getElementById('compControlMethod').value;
            } else if (type === 'load_center') {
                component.rating = parseFloat(document.getElementById('compRating').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.breakers = parseInt(document.getElementById('compBreakers').value);
                component.configuration = document.getElementById('compConfiguration').value;
            } else if (type === 'reactor') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.reactance = parseFloat(document.getElementById('compReactance').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.reactorType = document.getElementById('compReactorType').value;
            } else if (type === 'capacitor_bank') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.steps = parseInt(document.getElementById('compSteps').value);
                component.connectionType = document.getElementById('compConnectionType').value;
            } else if (type === 'ups') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.backupTime = parseInt(document.getElementById('compBackupTime').value);
                component.upsConfig = document.getElementById('compUPSConfig').value;
            } else if (type === 'surge_protection') {
                component.mcov = parseFloat(document.getElementById('compMCOV').value);
                component.vpl = parseFloat(document.getElementById('compVPL').value);
                component.dischargeCurrent = parseFloat(document.getElementById('compDischargeCurrent').value);
                component.spdType = document.getElementById('compSPDType').value;
            } else if (type === 'harmonic_filter') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.harmonicOrder = parseInt(document.getElementById('compHarmonicOrder').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.filterType = document.getElementById('compFilterType').value;
            }
            
            saveToHistory();
            components.push(component);
            updateComponentList();
            showToast('Component added successfully', 'success');
        }
        
        function updateComponentList() {
            const list = document.getElementById('componentList');
            if (components.length === 0) {
                list.innerHTML = '<p style="color: #999;">No components added yet</p>';
                return;
            }
            
            list.innerHTML = components.map((comp, index) => {
                let details = '';
                if (comp.type === 'transformer') {
                    details = `${comp.power} MVA, ${comp.impedance}% Z`;
                } else if (comp.type === 'cable') {
                    details = `${comp.length}m, R=${comp.resistance} Ω/km, X=${comp.reactance} Ω/km`;
                } else if (comp.type === 'generator') {
                    details = `${comp.power} MVA, X"d=${comp.reactance}%`;
                } else if (comp.type === 'motor') {
                    details = `${comp.power} ${comp.powerUnit.toUpperCase()}, LRC=${comp.lrc}x`;
                } else if (comp.type === 'utility_isc') {
                    details = `${comp.isc} kA, X/R=${comp.xr}`;
                } else if (comp.type === 'utility_mva') {
                    details = `${comp.mva} MVA, X/R=${comp.xr}`;
                } else if (comp.type === 'utility_impedance') {
                    details = `${comp.impedance}% on ${comp.baseMVA} MVA base`;
                } else if (comp.type === 'distribution_board') {
                    details = `${comp.rating}A, ${comp.voltage}V, ${comp.circuits} circuits`;
                } else if (comp.type === 'switchgear') {
                    details = `${comp.rating}A, ${comp.voltage}kV, ${comp.scRating}kA SC rating`;
                } else if (comp.type === 'mcc') {
                    details = `${comp.rating}A, ${comp.voltage}V, ${comp.buckets} buckets`;
                } else if (comp.type === 'load_center') {
                    details = `${comp.rating}A, ${comp.voltage}V, ${comp.breakers} breakers`;
                } else if (comp.type === 'reactor') {
                    details = `${comp.power} MVAR, ${comp.reactance}% X, ${comp.reactorType}`;
                } else if (comp.type === 'capacitor_bank') {
                    details = `${comp.power} MVAR, ${comp.voltage}kV, ${comp.steps} steps`;
                } else if (comp.type === 'ups') {
                    details = `${comp.power} kVA, ${comp.voltage}V, ${comp.backupTime}min backup`;
                } else if (comp.type === 'surge_protection') {
                    details = `MCOV: ${comp.mcov}V, VPL: ${comp.vpl}V, ${comp.spdType}`;
                } else if (comp.type === 'harmonic_filter') {
                    details = `${comp.power} MVAR, ${comp.harmonicOrder}th harmonic, ${comp.filterType}`;
                }
                
                const modifiedClass = comp.modified ? ' component-modified' : '';
                const editIndicator = comp.modified ? '<span class="edit-indicator">EDITED</span>' : '';
                
                // Add voltage zone badge if present
                let voltageZoneBadge = '';
                if (comp.voltageZone) {
                    const zoneClass = `voltage-zone-${comp.voltageZone}`;
                    const zoneName = comp.voltageZone === 'lv' ? 'LV' : comp.voltageZone === 'mv' ? 'MV' : 'HV';
                    voltageZoneBadge = `<span class="${zoneClass} voltage-zone-badge">${zoneName}</span>`;
                }
                
                return `
                    <div class="component-item${modifiedClass}">
                        <span><strong>${comp.type.toUpperCase().replace(/_/g, ' ')}</strong>: ${details}${voltageZoneBadge}${editIndicator}</span>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-warning" style="padding: 8px 16px; font-size: 13px;" onclick="editComponent(${index})">Edit</button>
                            <button class="btn btn-danger" onclick="removeComponent(${index})">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function removeComponent(index) {
            saveToHistory();
            components.splice(index, 1);
            updateComponentList();
            showToast('Component removed', 'success');
        }
        
        function getTypicalRXRatio(type, power) {
            // IEEE and IEC typical R/X ratios
            if (type === 'transformer') {
                if (power < 1) return 0.05; // Small transformers
                if (power < 5) return 0.07;
                if (power < 10) return 0.1;
                return 0.15; // Large transformers
            }
            return 0.1; // Default
        }
        
        // Enhanced validation function
        function performPreCalculationValidation(systemVoltage, components) {
            const warnings = [];
            const errors = [];
            
            // Check for voltage zone mismatches
            const voltageZones = components.filter(c => c.voltageZone).map(c => c.voltageZone);
            const uniqueZones = [...new Set(voltageZones)];
            
            if (uniqueZones.length > 1) {
                const hasTransformer = components.some(c => c.type === 'transformer');
                if (!hasTransformer) {
                    warnings.push('⚠️ Multiple voltage zones detected without a transformer connection. Ensure impedance reflection is properly handled.');
                }
            }
            
            // Check for unrealistic X/R ratios
            components.forEach((comp, idx) => {
                if (comp.xr !== undefined) {
                    if (comp.xr < 0.01) {
                        warnings.push(`⚠️ Component ${idx + 1}: Very low X/R ratio (${comp.xr}). Typical values are 0.05-20.`);
                    } else if (comp.xr > 50) {
                        warnings.push(`⚠️ Component ${idx + 1}: Very high X/R ratio (${comp.xr}). Verify this is correct.`);
                    }
                }
                
                // Also check rx (R/X) ratios
                if (comp.rx !== undefined) {
                    if (comp.rx < 0.01) {
                        warnings.push(`⚠️ Component ${idx + 1}: Very low R/X ratio (${comp.rx}). Typical values are 0.05-0.5 for transformers.`);
                    } else if (comp.rx > 2) {
                        warnings.push(`⚠️ Component ${idx + 1}: High R/X ratio (${comp.rx}). For transformers, typical values are 0.05-0.5.`);
                    }
                }
            });
            
            // Check transformer voltage levels and ratings
            components.forEach((comp, idx) => {
                if (comp.type === 'transformer') {
                    if (comp.primaryV && comp.secondaryV) {
                        if (comp.primaryV === comp.secondaryV) {
                            warnings.push(`⚠️ Transformer ${idx + 1}: Primary and secondary voltages are equal. Is this an auto-transformer?`);
                        }
                        
                        // Check for unrealistic voltage ratio
                        const ratio = Math.max(comp.primaryV, comp.secondaryV) / Math.min(comp.primaryV, comp.secondaryV);
                        if (ratio > 100) {
                            warnings.push(`⚠️ Transformer ${idx + 1}: Very high voltage ratio (${ratio.toFixed(1)}:1). Verify voltage values.`);
                        }
                    }
                    
                    // Check impedance vs power rating consistency
                    if (comp.impedance && comp.power) {
                        if (comp.power < 1 && comp.impedance < 3) {
                            warnings.push(`⚠️ Transformer ${idx + 1}: Small transformer with unusually low impedance (${comp.impedance}%). Typical: 4-6%.`);
                        }
                        if (comp.power > 10 && comp.impedance > 12) {
                            warnings.push(`⚠️ Transformer ${idx + 1}: Large transformer with unusually high impedance (${comp.impedance}%). Typical: 5-10%.`);
                        }
                    }
                }
            });
            
            // Check cable impedances
            components.forEach((comp, idx) => {
                if (comp.type === 'cable') {
                    if (comp.resistance && comp.reactance) {
                        const ratio = comp.reactance / comp.resistance;
                        if (ratio < 0.05) {
                            warnings.push(`⚠️ Cable ${idx + 1}: Very low X/R ratio (${ratio.toFixed(3)}). Typical for cables: 0.1-1.0.`);
                        }
                        if (ratio > 5) {
                            warnings.push(`⚠️ Cable ${idx + 1}: High X/R ratio (${ratio.toFixed(3)}). Typical for cables: 0.1-1.0. May be overhead line?`);
                        }
                    }
                    
                    // Check for zero resistance
                    if (comp.resistance === 0) {
                        errors.push(`❌ Cable ${idx + 1}: Zero resistance is not realistic. Check component data.`);
                    }
                }
            });
            
            // Check for utility source
            const hasUtilitySource = components.some(c => 
                c.type === 'utility_isc' || c.type === 'utility_mva' || c.type === 'utility_impedance'
            );
            if (!hasUtilitySource) {
                warnings.push('ℹ️ No utility source defined. Results show fault current at component terminals only.');
            }
            
            // Check for missing critical data
            components.forEach((comp, idx) => {
                if ((comp.type === 'transformer' || comp.type === 'generator') && !comp.rx && comp.rx !== 0) {
                    warnings.push(`ℹ️ Component ${idx + 1}: Using typical R/X ratio. Specify exact value if available.`);
                }
            });
            
            return { warnings, errors };
        }
        
        function calculate() {
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value);
            const standard = document.getElementById('calcStandard').value;
            const frequency = parseFloat(document.getElementById('systemFrequency').value);
            const method = document.getElementById('calcMethod').value;
            
            // Validate inputs
            const voltageValidation = validateInput(systemVoltage, 'systemVoltage');
            if (!voltageValidation.valid) {
                alert('System Voltage Error: ' + voltageValidation.message);
                return;
            }
            
            if (components.length === 0) {
                alert('Please add at least one component before calculating');
                return;
            }
            
            // Perform pre-calculation validation
            const validation = performPreCalculationValidation(systemVoltage, components);
            
            // Display validation warnings if any
            if (validation.warnings.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'validation-warning';
                warningDiv.innerHTML = '<strong>Pre-Calculation Warnings:</strong><br>' + validation.warnings.join('<br>');
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(warningDiv);
                
                const proceed = confirm('Validation warnings detected:\n\n' + validation.warnings.join('\n\n') + '\n\nProceed with calculation?');
                if (!proceed) return;
            }
            
            // Check for validation errors (blocking)
            if (validation.errors.length > 0) {
                alert('Validation Errors:\n\n' + validation.errors.join('\n\n'));
                return;
            }
            
            // Show progress
            const progressDiv = document.getElementById('results');
            progressDiv.innerHTML = '<div class="progress-bar"><div class="progress-fill" id="calcProgress"></div></div><p style="text-align: center; margin-top: 15px; color: #667eea;">Calculating... Please wait</p>';
            document.getElementById('calcProgress').style.width = '30%';
            
            setTimeout(() => {
                if (method === 'comparison') {
                    calculateComparison(systemVoltage, standard, frequency);
                } else if (method === 'per-unit') {
                    calculatePerUnit(systemVoltage, standard, frequency);
                } else if (method === 'point-to-point') {
                    calculatePointToPoint(systemVoltage, standard, frequency);
                }
                const progressBar = document.getElementById('calcProgress');
                if (progressBar) progressBar.style.width = '100%';
            }, 500);
        }
        
        function calculatePerUnit(systemVoltage, standard, frequency) {
            const steps = [];
            let totalImpedance = { r: 0, x: 0 };
            const baseVoltage = systemVoltage / 1000;
            const baseMVA = 100;
            
            steps.push({
                title: '📊 Per-Unit Method Configuration',
                content: `<strong>Base Values:</strong><br>Base MVA = ${baseMVA} MVA<br>Base Voltage = ${baseVoltage} kV<br>Base Impedance Zb = V²/S = ${(baseVoltage * baseVoltage / baseMVA).toFixed(4)} Ω`
            });
            
            // Continue with existing calculation logic...
            calculateWithSteps(systemVoltage, standard, frequency, steps, totalImpedance, baseMVA, 'per-unit');
        }
        
        function calculatePointToPoint(systemVoltage, standard, frequency) {
            const steps = [];
            let totalImpedance = { r: 0, x: 0 };
            
            steps.push({
                title: '🎯 Point-to-Point Method',
                content: `<strong>Direct impedance calculation from source to fault</strong><br>System Voltage: ${systemVoltage} V<br>Frequency: ${frequency} Hz`
            });
            
            // Calculate using direct impedance method
            calculateWithSteps(systemVoltage, standard, frequency, steps, totalImpedance, null, 'point-to-point');
        }
        
        function calculateComparison(systemVoltage, standard, frequency) {
            // Calculate both methods
            perUnitResults = null;
            pointToPointResults = null;
            
            calculatePerUnit(systemVoltage, standard, frequency);
            perUnitResults = calculationResults;
            
            calculatePointToPoint(systemVoltage, standard, frequency);
            pointToPointResults = calculationResults;
            
            // Display comparison
            displayComparison();
        }
        
        function calculateWithSteps(systemVoltage, standard, frequency, steps, totalImpedance, baseMVA, method) {
            if (!baseMVA) baseMVA = 100;
            const baseVoltage = systemVoltage / 1000;
            
            // Voltage factor c per standard
            let cFactor = 1.0;
            if (standard === 'iec') {
                // Check if user has specified a custom voltage factor
                const iecVoltageFactorEl = document.getElementById('iecVoltageFactor');
                if (iecVoltageFactorEl && iecVoltageFactorEl.value !== 'auto') {
                    cFactor = parseFloat(iecVoltageFactorEl.value);
                } else {
                    // Auto-determine based on voltage level
                    if (systemVoltage <= 1000) {
                        cFactor = 1.05;
                    } else if (systemVoltage <= 35000) {
                        cFactor = 1.1;
                    } else {
                        cFactor = 1.1;
                    }
                }
            } else {
                cFactor = systemVoltage <= 600 ? 1.0 : 1.05;
            }
            
            components.forEach((comp, index) => {
                if (comp.type === 'transformer') {
                    const zBase = (comp.secondaryV * comp.secondaryV) / baseMVA;
                    const zPU = (comp.impedance / 100) * (baseMVA / comp.power);
                    
                    // Determine R/X ratio
                    let rxRatio = comp.rx !== null ? comp.rx : getTypicalRXRatio('transformer', comp.power);
                    
                    // Calculate R and X from Z and R/X ratio
                    // Z² = R² + X², R = X × (R/X)
                    const xPU = safeDivide(zPU, safeSqrt(1 + rxRatio * rxRatio, 1), 0);
                    const rPU = xPU * rxRatio;
                    
                    totalImpedance.r += rPU * zBase;
                    totalImpedance.x += xPU * zBase;
                    
                    steps.push({
                        title: `Transformer ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Rated: ${comp.power} MVA, ${comp.primaryV}/${comp.secondaryV} kV<br>Impedance: ${comp.impedance}%<br>R/X Ratio: ${rxRatio.toFixed(3)} ${comp.rx === null ? '(typical)' : '(specified)'}<br>Zbase = ${zBase.toFixed(4)} Ω<br>Z(pu) = ${comp.impedance}% × (${baseMVA}/${comp.power}) = ${zPU.toFixed(4)} pu<br>X(pu) = ${xPU.toFixed(4)} pu → ${(xPU * zBase).toFixed(4)} Ω<br>R(pu) = ${rPU.toFixed(4)} pu → ${(rPU * zBase).toFixed(4)} Ω`
                    });
                } else if (comp.type === 'cable') {
                    // Apply temperature correction if operating temperature is specified
                    let rCorrected = comp.resistance;
                    let tempNote = '';
                    if (comp.operatingTemp && comp.operatingTemp !== 20) {
                        // Temperature correction for copper: R2 = R1 × (234.5 + T2)/(234.5 + T1)
                        // For aluminum: use 228 instead of 234.5
                        const tempCoeff = 234.5; // Copper constant
                        rCorrected = comp.resistance * (tempCoeff + comp.operatingTemp) / (tempCoeff + 20);
                        tempNote = `<br>Temperature corrected from 20°C to ${comp.operatingTemp}°C<br>R@${comp.operatingTemp}°C = ${comp.resistance} × ${((tempCoeff + comp.operatingTemp) / (tempCoeff + 20)).toFixed(3)} = ${rCorrected.toFixed(4)} Ω/km`;
                    }
                    
                    const r = rCorrected * comp.length / 1000;
                    const x = comp.reactance * comp.length / 1000;
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Cable ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Type: ${comp.cableType === 'single' ? 'Single Core' : 'Multi Core'}<br>Length: ${comp.length} m${tempNote}<br>R = ${rCorrected.toFixed(4)} Ω/km × ${comp.length/1000} km = ${r.toFixed(4)} Ω<br>X = ${comp.reactance} Ω/km × ${comp.length/1000} km = ${x.toFixed(4)} Ω`
                    });
                } else if (comp.type === 'generator') {
                    const zBase = (comp.voltage * comp.voltage) / baseMVA;
                    const xdPU = (comp.reactance / 100) * (baseMVA / comp.power);
                    
                    const rxRatio = comp.rx;
                    const xPU = safeDivide(xdPU, safeSqrt(1 + rxRatio * rxRatio, 1), 0);
                    const rPU = xPU * rxRatio;
                    
                    totalImpedance.r += rPU * zBase;
                    totalImpedance.x += xPU * zBase;
                    
                    steps.push({
                        title: `Generator ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Rated: ${comp.power} MVA, ${comp.voltage} kV<br>X"d (Subtransient): ${comp.reactance}%<br>R/X Ratio: ${rxRatio}<br>Zbase = ${zBase.toFixed(4)} Ω<br>X"d(pu) = ${comp.reactance}% × (${baseMVA}/${comp.power}) = ${xdPU.toFixed(4)} pu<br>X(actual) = ${(xPU * zBase).toFixed(4)} Ω<br>R(actual) = ${(rPU * zBase).toFixed(4)} Ω`
                    });
                } else if (comp.type === 'motor') {
                    const powerKW = comp.powerUnit === 'hp' ? comp.power * 0.746 : comp.power;
                    const eff = comp.efficiency / 100;
                    const pf = comp.pf;
                    
                    // Full load current
                    const fla = safeDivide(powerKW * 1000, safeSqrt(3) * comp.voltage * eff * pf, 1);
                    const lra = fla * comp.lrc;
                    
                    // Motor impedance at locked rotor
                    const zMotor = safeDivide(safeDivide(comp.voltage, safeSqrt(3), 1), lra, 0.001);
                    
                    // Motors are highly reactive at locked rotor, typical X/R = 10-20
                    const motorXR = 15; // Typical for locked rotor
                    const xMotor = safeDivide(zMotor, safeSqrt(1 + 1/(motorXR * motorXR), 1), 0);
                    const rMotor = safeDivide(xMotor, motorXR, 0);
                    
                    totalImpedance.r += rMotor;
                    totalImpedance.x += xMotor;
                    
                    steps.push({
                        title: `Motor ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Rated: ${comp.power} ${comp.powerUnit.toUpperCase()} (${powerKW.toFixed(2)} kW)<br>Efficiency: ${comp.efficiency}%, Power Factor: ${pf}<br>FLA = ${powerKW}×1000 / (√3 × ${comp.voltage} × ${eff} × ${pf}) = ${fla.toFixed(2)} A<br>LRA = FLA × ${comp.lrc} = ${lra.toFixed(2)} A<br>Zlocked = ${comp.voltage}/√3 / ${lra.toFixed(2)} = ${zMotor.toFixed(4)} Ω<br>X/R ≈ ${motorXR} (typical locked rotor)<br>X = ${xMotor.toFixed(4)} Ω, R = ${rMotor.toFixed(4)} Ω`
                    });
                } else if (comp.type === 'utility_isc') {
                    // Calculate impedance from short circuit current
                    const z = safeDivide(comp.voltage * 1000, safeSqrt(3) * comp.isc * 1000, 0.001);
                    const x = safeDivide(z * comp.xr, safeSqrt(1 + comp.xr * comp.xr, 1), 0);
                    const r = safeDivide(z, safeSqrt(1 + comp.xr * comp.xr, 1), 0);
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Utility Source ${index + 1} - ISC Method (Per ${standard.toUpperCase()})`,
                        content: `Available ISC: ${comp.isc} kA (3-phase)<br>System Voltage: ${comp.voltage} kV<br>X/R Ratio: ${comp.xr}<br>Zsource = V/(√3 × ISC) = ${comp.voltage}/(√3 × ${comp.isc}) = ${z.toFixed(4)} Ω<br>From X/R ratio:<br>R = Z/√(1 + (X/R)²) = ${r.toFixed(4)} Ω<br>X = Z × (X/R)/√(1 + (X/R)²) = ${x.toFixed(4)} Ω`
                    });
                } else if (comp.type === 'utility_mva') {
                    // Calculate impedance from fault MVA
                    const isc = safeDivide(comp.mva * 1000, safeSqrt(3) * comp.voltage*1000, 0.001);
                    const z = safeDivide(comp.voltage * 1000, safeSqrt(3) * isc * 1000, 0.001);
                    const x = safeDivide(z * comp.xr, safeSqrt(1 + comp.xr * comp.xr, 1), 0);
                    const r = safeDivide(z, safeSqrt(1 + comp.xr * comp.xr, 1), 0);
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Utility Source ${index + 1} - MVA Method (Per ${standard.toUpperCase()})`,
                        content: `Available Fault MVA: ${comp.mva} MVA<br>System Voltage: ${comp.voltage} kV<br>X/R Ratio: ${comp.xr}<br>ISC = MVA/(√3 × V) = ${comp.mva}/(√3 × ${comp.voltage}) = ${isc.toFixed(2)} kA<br>Zsource = V/(√3 × ISC) = ${z.toFixed(4)} Ω<br>From X/R ratio:<br>R = ${r.toFixed(4)} Ω<br>X = ${x.toFixed(4)} Ω`
                    });
                } else if (comp.type === 'utility_impedance') {
                    // Calculate impedance from percent impedance
                    const zBase = safeDivide(comp.voltage * comp.voltage, comp.baseMVA, 0.001);
                    const zPU = safeDivide(comp.impedance, 100, 0.01);
                    const z = zPU * zBase;
                    const x = safeDivide(z * comp.xr, safeSqrt(1 + comp.xr * comp.xr, 1), 0);
                    const r = safeDivide(z, safeSqrt(1 + comp.xr * comp.xr, 1), 0);
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Utility Source ${index + 1} - Impedance Method (Per ${standard.toUpperCase()})`,
                        content: `Source Impedance: ${comp.impedance}% on ${comp.baseMVA} MVA base<br>System Voltage: ${comp.voltage} kV<br>X/R Ratio: ${comp.xr}<br>Zbase = V²/MVAbase = ${comp.voltage}²/${comp.baseMVA} = ${zBase.toFixed(4)} Ω<br>Zsource = ${comp.impedance}% × ${zBase.toFixed(4)} = ${z.toFixed(4)} Ω<br>From X/R ratio:<br>R = ${r.toFixed(4)} Ω<br>X = ${x.toFixed(4)} Ω`
                    });
                }
            });
            
            const totalZ = safeSqrt(totalImpedance.r * totalImpedance.r + totalImpedance.x * totalImpedance.x, 0.0001);
            const totalXR = safeDivide(totalImpedance.x, totalImpedance.r, 10);
            
            // Validate intermediate results
            if (totalZ < 0.00001) {
                alert('Error: Total impedance is too low (near zero). Check component values.');
                return;
            }
            if (totalXR < 0.001 || totalXR > 100) {
                const proceed = confirm(`Warning: X/R ratio (${totalXR.toFixed(2)}) is unusual. Typical values: 0.05-20. Continue anyway?`);
                if (!proceed) return;
            }
            
            steps.push({
                title: 'Total Circuit Impedance',
                content: `ΣR = ${totalImpedance.r.toFixed(4)} Ω<br>ΣX = ${totalImpedance.x.toFixed(4)} Ω<br>Ztotal = √(R² + X²) = √(${totalImpedance.r.toFixed(4)}² + ${totalImpedance.x.toFixed(4)}²) = ${totalZ.toFixed(4)} Ω<br>X/R Ratio = ${totalXR.toFixed(2)}`
            });
            
            // Calculate symmetrical short circuit current
            const vPhase = safeDivide(systemVoltage * cFactor, safeSqrt(3), 0);
            const iscSymm = safeDivide(vPhase, totalZ, 0);
            const iscSymmKA = safeDivide(iscSymm, 1000, 0);
            
            // Validate symmetrical current result
            const symmValidation = validateCalculationResult(iscSymmKA, 'Symmetrical Current (kA)', 0.001, 1000);
            if (!symmValidation.valid) {
                alert('Calculation Error: ' + symmValidation.message);
                return;
            }
            
            // Calculate asymmetrical (peak) current per standard
            let iscAsymm, iscAsymmKA, kappa, multiplier;
            if (standard === 'iec') {
                // IEC 60909: ip = κ × √2 × I"k
                // Check if user specified custom peak factor
                const iecPeakFactorEl = document.getElementById('iecPeakFactor');
                let kappaNote = '';
                if (iecPeakFactorEl && iecPeakFactorEl.value !== 'auto') {
                    kappa = parseFloat(iecPeakFactorEl.value);
                    kappaNote = `<br>(User specified κ = ${kappa})`;
                } else {
                    kappa = 1.02 + 0.98 * Math.exp(-3 * totalImpedance.r / totalImpedance.x);
                    kappaNote = `<br>κ = 1.02 + 0.98 × e^(-3R/X) = 1.02 + 0.98 × e^(-3×${totalImpedance.r.toFixed(4)}/${totalImpedance.x.toFixed(4)})<br>κ = ${kappa.toFixed(3)}`;
                }
                
                iscAsymm = kappa * safeSqrt(2) * iscSymm;
                iscAsymmKA = safeDivide(iscAsymm, 1000, 0);
                multiplier = kappa; // For result storage
                
                steps.push({
                    title: 'Short Circuit Current Calculation (IEC 60909)',
                    content: `Symmetrical (RMS) Current I"k:<br>I"k = (c × Vn)/(√3 × Z) = (${cFactor} × ${systemVoltage})/(√3 × ${totalZ.toFixed(4)})<br>I"k = ${vPhase.toFixed(2)}/${totalZ.toFixed(4)} = ${iscSymm.toFixed(2)} A = <strong>${iscSymmKA.toFixed(2)} kA</strong><br><br>Peak Current ip (per IEC 60909-0):${kappaNote}<br>ip = κ × √2 × I"k = ${kappa.toFixed(3)} × 1.414 × ${iscSymmKA.toFixed(2)}<br>ip = <strong>${iscAsymmKA.toFixed(2)} kA</strong>`
                });
            } else {
                // IEEE: Asymmetrical = Symmetrical × multiplier based on X/R
                multiplier = safeSqrt(1 + 2 * Math.pow(Math.E, safeDivide(-Math.PI, totalXR, -0.1)), 1.0);
                iscAsymm = iscSymm * multiplier;
                iscAsymmKA = safeDivide(iscAsymm, 1000, 0);
                kappa = multiplier; // For result storage
                
                steps.push({
                    title: 'Short Circuit Current Calculation (IEEE 141/C37)',
                    content: `Symmetrical RMS Current:<br>Isym = (c × V)/(√3 × Z) = (${cFactor} × ${systemVoltage})/(√3 × ${totalZ.toFixed(4)})<br>Isym = ${vPhase.toFixed(2)}/${totalZ.toFixed(4)} = ${iscSymm.toFixed(2)} A = <strong>${iscSymmKA.toFixed(2)} kA</strong><br><br>Asymmetrical (First Cycle) Current (per IEEE):<br>Multiplier = √(1 + 2e^(-π/(X/R))) = √(1 + 2e^(-π/${totalXR.toFixed(2)}))<br>Multiplier = ${multiplier.toFixed(3)}<br>Iasym = Isym × ${multiplier.toFixed(3)} = <strong>${iscAsymmKA.toFixed(2)} kA</strong>`
                });
            }
            
            // Calculate fault MVA
            const faultMVA = safeDivide(safeSqrt(3) * systemVoltage * iscSymm, 1000000, 0);
            
            steps.push({
                title: 'Fault MVA',
                content: `MVAsc = √3 × V × I"k / 1000<br>MVAsc = √3 × ${systemVoltage} × ${iscSymmKA.toFixed(2)}<br>MVAsc = <strong>${faultMVA.toFixed(2)} MVA</strong>`
            });
            
            // Equipment duty considerations
            const dcComponent = iscAsymm - iscSymm;
            const dcComponentKA = dcComponent / 1000;
            
            steps.push({
                title: 'Equipment Duty Considerations',
                content: `DC Component (first half-cycle):<br>IDC ≈ ${dcComponentKA.toFixed(2)} kA<br><br>Time constant τ = L/R = (X/ωR):<br>τ = ${totalImpedance.x.toFixed(4)}/(2π × ${frequency} × ${totalImpedance.r.toFixed(4)}) = ${(totalImpedance.x / (2 * Math.PI * frequency * totalImpedance.r)).toFixed(4)} seconds<br><br>Notes per ${standard === 'iec' ? 'IEC 60909' : 'IEEE C37'}:<br>- Circuit breakers must interrupt symmetrical current<br>- Peak current is used for mechanical withstand<br>- X/R ratio affects interrupting duty and arcing time`
            });
            
            calculationResults = { 
                steps, 
                iscSymm: iscSymmKA, 
                iscAsymm: iscAsymmKA,
                impedance: totalZ,
                xr: totalXR,
                faultMVA: faultMVA,
                standard: standard,
                kappa: standard === 'iec' ? kappa : multiplier
            };
            
            // Perform sanity checks on results
            const sanityCheck = performSanityChecks(calculationResults);
            if (sanityCheck.errors.length > 0) {
                alert('Calculation Errors Detected:\n' + sanityCheck.errors.join('\n'));
                return;
            }
            if (sanityCheck.warnings.length > 0) {
                // Display warnings but continue
                console.log('Calculation Warnings:', sanityCheck.warnings);
            }
            
            displayResults();
        }
        
        function generateXRPipelineDisplay(standard) {
            if (standard === 'iec') return ''; // Only for ANSI/IEEE
            
            // Collect X/R contributions from each component
            let contributions = [];
            let totalR = 0, totalX = 0;
            
            components.forEach((comp, index) => {
                let compR = 0, compX = 0, xr = 0;
                
                if (comp.type === 'utility_isc' || comp.type === 'utility_mva' || comp.type === 'utility_impedance') {
                    xr = comp.xr || 10;
                    contributions.push({
                        name: `Source ${index + 1}`,
                        xr: xr,
                        type: 'source'
                    });
                } else if (comp.type === 'transformer') {
                    xr = comp.rx ? (1 / comp.rx) : 10;
                    contributions.push({
                        name: `Transformer ${index + 1}`,
                        xr: xr,
                        type: 'transformer'
                    });
                } else if (comp.type === 'cable') {
                    const r = comp.resistance * comp.length / 1000;
                    const x = comp.reactance * comp.length / 1000;
                    xr = x / r;
                    contributions.push({
                        name: `Cable ${index + 1}`,
                        xr: xr,
                        type: 'cable'
                    });
                } else if (comp.type === 'generator') {
                    xr = comp.rx ? (1 / comp.rx) : 10;
                    contributions.push({
                        name: `Generator ${index + 1}`,
                        xr: xr,
                        type: 'generator'
                    });
                }
            });
            
            let html = `
                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #0284c7;">
                    <h4 style="color: #0c4a6e; margin-bottom: 15px;">📊 X/R Ratio Pipeline (ANSI/IEEE Analysis)</h4>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Component X/R Contributions:</strong>
                        <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                            <tr style="background: #f0f9ff; font-weight: 600;">
                                <td style="padding: 8px; border: 1px solid #cbd5e0;">Component</td>
                                <td style="padding: 8px; border: 1px solid #cbd5e0;">Type</td>
                                <td style="padding: 8px; border: 1px solid #cbd5e0;">X/R Ratio</td>
                                <td style="padding: 8px; border: 1px solid #cbd5e0;">Impact</td>
                            </tr>
            `;
            
            contributions.forEach(contrib => {
                const impact = contrib.xr > 15 ? 'High reactance' : contrib.xr < 5 ? 'High resistance' : 'Balanced';
                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #cbd5e0;">${contrib.name}</td>
                        <td style="padding: 8px; border: 1px solid #cbd5e0;">${contrib.type}</td>
                        <td style="padding: 8px; border: 1px solid #cbd5e0;">${contrib.xr.toFixed(2)}</td>
                        <td style="padding: 8px; border: 1px solid #cbd5e0;">${impact}</td>
                    </tr>
                `;
            });
            
            html += `
                        </table>
                    </div>
                    
                    <div style="background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #fbbf24;">
                        <strong style="color: #92400e;">Understanding X/R Ratios:</strong><br>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8; font-size: 0.9em;">
                            <li><strong>Utility Sources:</strong> Typically 10-20 (highly inductive)</li>
                            <li><strong>Transformers:</strong> Typically 7-15 (inductive)</li>
                            <li><strong>Cables:</strong> Typically 0.5-3 (more resistive)</li>
                            <li><strong>Generators:</strong> Typically 10-40 (highly inductive)</li>
                            <li><strong>High X/R (>17):</strong> May require special CB ratings</li>
                            <li><strong>Low X/R (<3):</strong> Lower asymmetry, faster decay</li>
                        </ul>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateEquipmentDutyRecommendations(results) {
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value);
            
            // Determine standard circuit breaker frame sizes
            const standardFrames = [225, 400, 600, 800, 1200, 1600, 2000, 2500, 3200, 4000, 5000, 6000];
            const requiredKA = results.iscSymm;
            
            // Find next standard frame size with 25% margin
            const requiredWithMargin = requiredKA * 1.25;
            let recommendedFrame = standardFrames.find(frame => frame / 10 >= requiredWithMargin);
            if (!recommendedFrame) recommendedFrame = 'Custom > 60kA';
            
            // Calculate asymmetrical multiplier for first cycle
            const asymmMultiplier = results.iscAsymm / results.iscSymm;
            
            // Equipment recommendations
            let html = `
                <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #10b981;">
                    <h4 style="color: #065f46; margin-bottom: 15px;">🔌 Equipment Duty & Recommendations</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <strong style="color: #1e3c72;">Circuit Breakers</strong><br>
                            <div style="margin-top: 10px; line-height: 1.8;">
                                • <strong>Interrupting Rating:</strong> ${requiredKA.toFixed(1)} kA minimum<br>
                                • <strong>Recommended Frame:</strong> ${recommendedFrame} kA<br>
                                • <strong>Asymmetrical Factor:</strong> ${asymmMultiplier.toFixed(2)}<br>
                                • <strong>Margin:</strong> 25% safety factor included<br>
                                ${results.xr > 17 ? '• ⚠️ <strong>High X/R:</strong> Verify with manufacturer for X/R capability' : ''}
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <strong style="color: #1e3c72;">Bus & Conductors</strong><br>
                            <div style="margin-top: 10px; line-height: 1.8;">
                                • <strong>Momentary Rating:</strong> ${results.iscAsymm.toFixed(1)} kA peak<br>
                                • <strong>1-Second Rating:</strong> ${(requiredKA * 1.1).toFixed(1)} kA<br>
                                • <strong>Bracing Force:</strong> Calculate per IEEE 605<br>
                                • <strong>Temperature Rise:</strong> Consider continuous load
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <strong style="color: #1e3c72;">Switchgear & Panels</strong><br>
                            <div style="margin-top: 10px; line-height: 1.8;">
                                • <strong>Short Circuit Rating:</strong> ${requiredKA.toFixed(1)} kA minimum<br>
                                • <strong>Standard Ratings:</strong> 22kA, 35kA, 42kA, 65kA, 85kA<br>
                                • <strong>Arc Flash Label:</strong> Required per NFPA 70E<br>
                                • <strong>Verify:</strong> Both symmetrical and asymmetrical ratings
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <strong style="color: #1e3c72;">Transformers</strong><br>
                            <div style="margin-top: 10px; line-height: 1.8;">
                                • <strong>Through-Fault:</strong> ${requiredKA.toFixed(1)} kA<br>
                                • <strong>Category:</strong> ${requiredKA < 25 ? 'I' : requiredKA < 50 ? 'II' : requiredKA < 75 ? 'III' : 'IV'} per ANSI C57.12.00<br>
                                • <strong>Withstand Time:</strong> 2 seconds typical<br>
                                • <strong>Protection:</strong> Consider current-limiting fuses
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #fbbf24;">
                        <strong style="color: #92400e;">📋 Additional Considerations:</strong><br>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                            <li>Coordinate protective devices for selective operation</li>
                            <li>Verify equipment ratings at operating temperature</li>
                            <li>Consider future expansion (typically 25-30% margin)</li>
                            <li>Review manufacturer data sheets for specific ratings</li>
                            <li>Comply with NEC Articles 110.9, 110.10, and 110.24</li>
                            <li>Update arc flash labels if system changes</li>
                        </ul>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function displayResults() {
            if (!calculationResults) return;
            
            const resultsDiv = document.getElementById('results');
            const standardName = calculationResults.standard === 'iec' ? 'IEC 60909-0' : 
                                calculationResults.standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141/C37.010';
            
            resultsDiv.innerHTML = `
                <div class="executive-summary">
                    <h3>📊 Executive Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-card-label">Symmetrical Current</div>
                            <div class="summary-card-value">${calculationResults.iscSymm.toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">${calculationResults.standard === 'iec' ? 'Peak Current' : 'Asymmetrical'}</div>
                            <div class="summary-card-value" style="color: #dc3545;">${calculationResults.iscAsymm.toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Fault MVA</div>
                            <div class="summary-card-value" style="color: #f59e0b;">${calculationResults.faultMVA.toFixed(2)}<span style="font-size: 0.5em;"> MVA</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">X/R Ratio</div>
                            <div class="summary-card-value" style="color: #8b5cf6;">${calculationResults.xr.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px;">
                        <strong>Standard:</strong> ${standardName} | 
                        <strong>Total Impedance:</strong> ${calculationResults.impedance.toFixed(4)} Ω |
                        <strong>${calculationResults.standard === 'iec' ? 'κ Factor' : 'Multiplier'}:</strong> ${calculationResults.kappa.toFixed(3)}
                    </div>
                </div>
                
                <div class="warning-box">
                    <strong>⚠️ Equipment Selection Guidelines:</strong><br>
                    • Circuit Breaker Interrupting Rating: ≥ ${calculationResults.iscSymm.toFixed(2)} kA (symmetrical)<br>
                    • Momentary/Close & Latch Rating: ≥ ${calculationResults.iscAsymm.toFixed(2)} kA<br>
                    • Consider X/R ratio (${calculationResults.xr.toFixed(2)}) for duty cycle calculations<br>
                    • Verify equipment ratings include appropriate safety factors per local codes
                </div>
                
                ${generateEquipmentDutyRecommendations(calculationResults)}
                
                ${generateXRPipelineDisplay(calculationResults.standard)}
                
                <div class="calculation-steps">
                    <h3 style="color: #1e3c72; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">🔢</span>
                        Detailed Step-by-Step Calculation
                    </h3>
                    ${calculationResults.steps.map((step, index) => `
                        <div class="step" style="animation: fadeIn 0.5s ease-in ${index * 0.1}s both;">
                            <div class="step-title">${step.title}</div>
                            <div style="line-height: 1.8;">${step.content}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Update safety analysis
            updateSafetyAnalysis(calculationResults);
            
            // Generate visualizations
            generateSingleLineDiagram();
            
            // Generate fault contribution chart if Chart.js is available
            if (typeof Chart !== 'undefined' && components.length > 0) {
                // Calculate simple contribution percentages (equal distribution for demo)
                const contributions = components.map((comp, index) => ({
                    name: `${comp.type} ${index + 1}`,
                    percentage: 100 / components.length
                }));
                createFaultContributionChart(contributions);
            }
        }
        
        function displayComparison() {
            if (!perUnitResults || !pointToPointResults) return;
            
            // Calculate percentage differences
            const symmDiff = Math.abs((perUnitResults.iscSymm - pointToPointResults.iscSymm) / perUnitResults.iscSymm * 100);
            const asymmDiff = Math.abs((perUnitResults.iscAsymm - pointToPointResults.iscAsymm) / perUnitResults.iscAsymm * 100);
            const mvaDiff = Math.abs((perUnitResults.faultMVA - pointToPointResults.faultMVA) / perUnitResults.faultMVA * 100);
            const impedanceDiff = Math.abs((perUnitResults.impedance - pointToPointResults.impedance) / perUnitResults.impedance * 100);
            
            // Determine if differences are acceptable (< 5% is good)
            const isAcceptable = symmDiff < 5 && asymmDiff < 5 && mvaDiff < 5;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="comparison-mode">
                    <h3 style="color: #f59e0b; margin-bottom: 15px;">⚖️ Comparison Mode - Method Validation</h3>
                    <p>Comparing Per-Unit Method vs Point-to-Point Method for calculation accuracy verification</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border: 2px solid #0284c7;">
                        <h4 style="color: #0c4a6e; margin-bottom: 15px;">📐 Per-Unit Method</h4>
                        <div style="line-height: 2;">
                            <p><strong>Symmetrical:</strong> ${perUnitResults.iscSymm.toFixed(3)} kA</p>
                            <p><strong>Asymmetrical:</strong> ${perUnitResults.iscAsymm.toFixed(3)} kA</p>
                            <p><strong>Fault MVA:</strong> ${perUnitResults.faultMVA.toFixed(3)} MVA</p>
                            <p><strong>Impedance:</strong> ${perUnitResults.impedance.toFixed(5)} Ω</p>
                            <p><strong>X/R Ratio:</strong> ${perUnitResults.xr.toFixed(3)}</p>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(12, 74, 110, 0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>Method Notes:</strong><br>
                            • Normalized to base MVA<br>
                            • Better for multi-voltage systems<br>
                            • Widely used in industry
                        </div>
                    </div>
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 2px solid #10b981;">
                        <h4 style="color: #065f46; margin-bottom: 15px;">🎯 Point-to-Point Method</h4>
                        <div style="line-height: 2;">
                            <p><strong>Symmetrical:</strong> ${pointToPointResults.iscSymm.toFixed(3)} kA</p>
                            <p><strong>Asymmetrical:</strong> ${pointToPointResults.iscAsymm.toFixed(3)} kA</p>
                            <p><strong>Fault MVA:</strong> ${pointToPointResults.faultMVA.toFixed(3)} MVA</p>
                            <p><strong>Impedance:</strong> ${pointToPointResults.impedance.toFixed(5)} Ω</p>
                            <p><strong>X/R Ratio:</strong> ${pointToPointResults.xr.toFixed(3)}</p>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(6, 95, 70, 0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>Method Notes:</strong><br>
                            • Direct impedance sum<br>
                            • Simpler for single voltage<br>
                            • Easier to understand
                        </div>
                    </div>
                </div>
                
                <div style="background: ${isAcceptable ? '#d1fae5' : '#fef3c7'}; padding: 20px; border-radius: 12px; border: 2px solid ${isAcceptable ? '#10b981' : '#f59e0b'}; margin-bottom: 25px;">
                    <h4 style="color: ${isAcceptable ? '#065f46' : '#92400e'}; margin-bottom: 15px;">
                        ${isAcceptable ? '✅ Validation Passed' : '⚠️ Review Differences'}
                    </h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: white; font-weight: 600;">
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Parameter</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Difference</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Status</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Explanation</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Symmetrical Current</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-weight: 600;">${symmDiff.toFixed(2)}%</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">${symmDiff < 2 ? '✓ Excellent' : symmDiff < 5 ? '✓ Good' : '⚠ Review'}</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-size: 0.9em;">
                                ${symmDiff < 5 ? 'Both methods agree well' : 'Check impedance calculations'}
                            </td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Asymmetrical Current</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-weight: 600;">${asymmDiff.toFixed(2)}%</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">${asymmDiff < 2 ? '✓ Excellent' : asymmDiff < 5 ? '✓ Good' : '⚠ Review'}</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-size: 0.9em;">
                                ${asymmDiff < 5 ? 'X/R ratios consistent' : 'Verify X/R ratio inputs'}
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Fault MVA</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-weight: 600;">${mvaDiff.toFixed(2)}%</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">${mvaDiff < 2 ? '✓ Excellent' : mvaDiff < 5 ? '✓ Good' : '⚠ Review'}</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-size: 0.9em;">
                                ${mvaDiff < 5 ? 'Fault level consistent' : 'Review voltage levels'}
                            </td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">Total Impedance</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-weight: 600;">${impedanceDiff.toFixed(2)}%</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0;">${impedanceDiff < 2 ? '✓ Excellent' : impedanceDiff < 5 ? '✓ Good' : '⚠ Review'}</td>
                            <td style="padding: 10px; border: 1px solid #cbd5e0; font-size: 0.9em;">
                                ${impedanceDiff < 5 ? 'Impedance reflection accurate' : 'Check transformer voltage ratios'}
                            </td>
                        </tr>
                    </table>
                    
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; font-size: 0.9em;">
                        <strong>💡 Interpretation Guide:</strong><br>
                        • <strong>< 2% difference:</strong> Excellent agreement - Both methods validate each other<br>
                        • <strong>2-5% difference:</strong> Good agreement - Acceptable for engineering purposes<br>
                        • <strong>> 5% difference:</strong> Review required - Check voltage levels, impedance values, and transformer ratios
                    </div>
                </div>
                
                <div class="executive-summary">
                    <h3>📊 Recommended Design Values (Conservative)</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-card-label">Symmetrical Current</div>
                            <div class="summary-card-value">${Math.max(perUnitResults.iscSymm, pointToPointResults.iscSymm).toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;">Use higher value</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Asymmetrical Current</div>
                            <div class="summary-card-value" style="color: #dc3545;">${Math.max(perUnitResults.iscAsymm, pointToPointResults.iscAsymm).toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;">Use higher value</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Fault MVA</div>
                            <div class="summary-card-value" style="color: #f59e0b;">${Math.max(perUnitResults.faultMVA, pointToPointResults.faultMVA).toFixed(2)}<span style="font-size: 0.5em;"> MVA</span></div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;">Use higher value</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Agreement</div>
                            <div class="summary-card-value" style="color: ${isAcceptable ? '#10b981' : '#f59e0b'};">${((100 - (symmDiff + asymmDiff) / 2)).toFixed(1)}<span style="font-size: 0.5em;">%</span></div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;">Methods correlation</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateSafetyAnalysis(results) {
            const safetyDiv = document.getElementById('safetyResults');
            
            // Get system voltage
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value);
            
            // Calculate arc flash using IEEE 1584-2018
            const arcFlashData = calculateArcFlash({
                voltage: systemVoltage / 1000, // Convert to kV
                boltedFaultCurrent: results.iscSymm,
                workingDistance: 610, // 24 inches in mm
                equipmentGap: 32, // Default gap in mm
                enclosureType: 'VCB',
                arcDuration: 0.1 // 100ms
            });
            
            const incidentEnergy = arcFlashData.incidentEnergy;
            const arcFlashBoundary = arcFlashData.arcFlashBoundary;
            const ppeCategory = arcFlashData.ppeCategory;
            const ppeRec = getPPERecommendations(ppeCategory, incidentEnergy);
            const boundaries = calculateApproachBoundaries(systemVoltage / 1000);
            
            safetyDiv.innerHTML = `
                <div class="safety-analysis">
                    <h4>⚠️ Arc Flash Hazard Analysis (IEEE 1584-2018)</h4>
                    <div class="arc-flash-boundary">
                        <div class="boundary-item">
                            <strong>Incident Energy</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">${incidentEnergy.toFixed(2)} cal/cm²</span><br>
                            <small>At ${(arcFlashData.workingDistance / 25.4).toFixed(1)} inches working distance</small>
                        </div>
                        <div class="boundary-item">
                            <strong>Arc Flash Boundary</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">${(arcFlashBoundary / MM_TO_FEET).toFixed(2)} feet</span><br>
                            <small>Distance to 1.2 cal/cm²</small>
                        </div>
                        <div class="boundary-item">
                            <strong>PPE Category</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">Category ${ppeCategory}</span><br>
                            <small>Per NFPA 70E Table 130.5(C)</small>
                        </div>
                        <div class="boundary-item">
                            <strong>Arcing Current</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">${arcFlashData.arcingCurrent.toFixed(2)} kA</span><br>
                            <small>Calculated per IEEE 1584</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                        <h5 style="color: #1e3c72; margin-bottom: 10px;">PPE Requirements (Category ${ppeCategory})</h5>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Clothing</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${ppeRec.clothing}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Arc Rating</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${ppeRec.arcRating}</td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Face Shield</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${ppeRec.faceShield}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Gloves</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${ppeRec.gloves}</td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Hearing Protection</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${ppeRec.hearing}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Other Equipment</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${ppeRec.other}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                        <h5 style="color: #1e3c72; margin-bottom: 10px;">NFPA 70E-2024 Shock Protection Boundaries</h5>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Limited Approach (Shock Protection)</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${(boundaries.limited / MM_TO_FEET).toFixed(2)} feet (${boundaries.limited} mm)</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Restricted Approach (Shock Protection)</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${(boundaries.restricted / MM_TO_FEET).toFixed(2)} feet (${boundaries.restricted} mm)</td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Prohibited Approach (Shock Protection)</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;">${(boundaries.prohibited / MM_TO_FEET).toFixed(2)} feet (${boundaries.prohibited} mm)</td>
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>Arc Flash Boundary</strong></td>
                                <td style="padding: 10px; border: 1px solid #e1e8ed;"><strong>${(arcFlashBoundary / MM_TO_FEET).toFixed(2)} feet (${arcFlashBoundary.toFixed(0)} mm)</strong></td>
                            </tr>
                        </table>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #64748b;">
                            <em>Note: NFPA 70E-2024 terminology - "Shock Protection Boundaries" replaces previous boundary terminology to clarify electrical shock hazard zones</em>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 8px;">
                        <strong>⚠️ CRITICAL SAFETY REQUIREMENTS (NFPA 70E-2024):</strong><br>
                        • All personnel must wear appropriate PPE for Category ${ppeCategory}<br>
                        • <strong>Hearing protection mandatory</strong> for all arc flash work (NFPA 70E-2024 requirement)<br>
                        • Establish arc flash boundary at ${(arcFlashBoundary / MM_TO_FEET).toFixed(2)} feet<br>
                        • Only qualified persons permitted within shock protection boundaries<br>
                        • Consider arc-resistant switchgear for incident energy > 12 cal/cm²<br>
                        • Implement proper lockout/tagout procedures per NFPA 70E Article 120<br>
                        • Post arc flash labels per NFPA 70E 130.5(D)<br>
                        • Regular inspection and maintenance per NFPA 70E and NEC requirements<br>
                        • Conduct job briefing before any work within arc flash boundary<br>
                        • Verify equipment ratings meet or exceed calculated fault levels
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fef9e6; border-left: 4px solid #f59e0b; border-radius: 8px;">
                        <strong>🚨 EMERGENCY RESPONSE PLANNING (NFPA 70E-2024):</strong><br>
                        • Establish emergency response plan before work begins<br>
                        • Ensure emergency contact information is readily available<br>
                        • Identify nearest emergency medical facility and route<br>
                        • Have fire suppression equipment readily available<br>
                        • Train all personnel on emergency procedures<br>
                        • Maintain communication with site safety coordinator<br>
                        • Document and review emergency response procedures annually
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 8px;">
                        <strong>✓ EQUIPMENT RATING VALIDATION (NFPA 70E-2024):</strong><br>
                        • Verify circuit breaker interrupting rating ≥ ${results.iscSymm.toFixed(2)} kA<br>
                        • Verify momentary rating ≥ ${results.iscAsymm.toFixed(2)} kA<br>
                        • Check equipment withstand rating against fault MVA (${results.faultMVA.toFixed(2)} MVA)<br>
                        • Confirm X/R ratio compatibility (calculated: ${results.xr.toFixed(2)})<br>
                        • Validate arc flash labels match current system conditions<br>
                        • Ensure all equipment ratings documented and current<br>
                        • Review equipment condition and maintenance records
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 8px;">
                        <strong>📋 NFPA 70E-2024 COMPLIANCE NOTES:</strong><br>
                        • <strong>PPE Material Flexibility:</strong> Alternative materials meeting equivalent arc ratings are acceptable<br>
                        • <strong>Updated Terminology:</strong> "Shock protection boundaries" replaces older boundary terms<br>
                        • <strong>Hearing Protection:</strong> Now mandatory for all arc flash work regardless of category<br>
                        • <strong>Equipment Ratings:</strong> Must be validated annually or when system changes occur<br>
                        • <strong>Emergency Response:</strong> Formal planning required before any energized work<br>
                        • <strong>Documentation:</strong> All risk assessments and calculations must be documented<br>
                        • <strong>Training:</strong> Annual refresher training required for all qualified persons
                    </div>
                </div>
                
                <div class="sensitivity-analysis">
                    <h4>📈 Sensitivity Analysis</h4>
                    <p><strong>Impact of X/R Ratio Variation:</strong></p>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        ${generateSensitivityTable(results)}
                    </div>
                </div>
            `;
        }
        
        function calculateIncidentEnergy(faultMVA, faultCurrent, distance, duration) {
            // Simplified IEEE 1584 calculation
            const Ibf = faultCurrent * 1000; // Convert to Amps
            const D = distance * 39.37; // Convert to inches
            const t = duration; // seconds
            
            // Simplified formula (actual IEEE 1584 is more complex)
            const logIa = 0.662 + 0.0966 * faultMVA + 0.000526 * faultMVA * faultMVA - 0.5588 * faultMVA * Math.log10(Ibf);
            const Ia = Math.pow(10, logIa);
            const E = 4.184 * 793 * Math.pow(Ia/1000, 1.081) * t / Math.pow(D, 1.4738);
            
            return Math.max(0.5, E); // Minimum 0.5 cal/cm²
        }
        
        function calculateArcFlashBoundary(incidentEnergy, workingDistance) {
            // Distance where incident energy = 1.2 cal/cm²
            const EB = 1.2; // Boundary incident energy
            const D = workingDistance * 39.37; // inches
            const DB = D * Math.pow(incidentEnergy / EB, 1/1.4738);
            return DB / 12; // Convert to feet
        }
        
        function generateSensitivityTable(results) {
            const xrRatios = [results.xr * 0.8, results.xr, results.xr * 1.2];
            let table = '<table style="width: 100%; border-collapse: collapse;">';
            table += '<tr style="background: #f0f4ff;"><th style="padding: 10px; border: 1px solid #cbd5e0;">X/R Ratio</th><th style="padding: 10px; border: 1px solid #cbd5e0;">Asymmetrical (kA)</th><th style="padding: 10px; border: 1px solid #cbd5e0;">Change</th></tr>';
            
            xrRatios.forEach((xr, index) => {
                const multiplier = results.standard === 'iec' ? 
                    1.02 + 0.98 * Math.exp(-3 / xr) :
                    Math.sqrt(1 + 2 * Math.pow(Math.E, -Math.PI / xr));
                const asymm = results.iscSymm * multiplier;
                const change = index === 1 ? 'Baseline' : ((asymm - results.iscAsymm) / results.iscAsymm * 100).toFixed(1) + '%';
                
                table += `<tr><td style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">${xr.toFixed(2)}</td>`;
                table += `<td style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">${asymm.toFixed(2)}</td>`;
                table += `<td style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">${change}</td></tr>`;
            });
            
            table += '</table>';
            return table;
        }
        
        function saveProject() {
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const systemVoltage = document.getElementById('systemVoltage').value;
            const standard = document.getElementById('calcStandard').value;
            const frequency = document.getElementById('systemFrequency').value;
            
            const project = {
                name: projectName,
                systemVoltage: systemVoltage,
                standard: standard,
                frequency: frequency,
                components: components,
                results: calculationResults,
                version: '2.0',
                date: new Date().toISOString()
            };
            
            const projectData = JSON.stringify(project, null, 2);
            const blob = new Blob([projectData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    const project = JSON.parse(event.target.result);
                    document.getElementById('projectName').value = project.name;
                    document.getElementById('systemVoltage').value = project.systemVoltage;
                    document.getElementById('calcStandard').value = project.standard || 'iec';
                    document.getElementById('systemFrequency').value = project.frequency || '60';
                    components = project.components;
                    calculationResults = project.results;
                    updateComponentList();
                    if (calculationResults) displayResults();
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        /**
         * Export comprehensive PDF report using jsPDF
         */
        async function exportPDF() {
            if (!calculationResults) {
                alert('No results to export. Please calculate first.');
                return;
            }
            
            try {
                showToast('Generating PDF report...', 'info');
                
                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const projectName = document.getElementById('projectName').value || 'Unnamed Project';
                const systemVoltage = document.getElementById('systemVoltage').value;
                const standard = document.getElementById('calcStandard').value;
                const frequency = document.getElementById('systemFrequency').value;
                
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                
                // Header
                doc.setFillColor(30, 60, 114);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.text('PowerSys Pro', 105, 20, { align: 'center' });
                doc.setFontSize(14);
                doc.text('Short Circuit Analysis Report', 105, 30, { align: 'center' });
                
                doc.setTextColor(0, 0, 0);
                yPos = 50;
                
                // Executive Summary
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Executive Summary', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Project: ${projectName}`, 20, yPos);
                yPos += 6;
                doc.text(`Date: ${new Date().toLocaleString()}`, 20, yPos);
                yPos += 6;
                doc.text(`Standard: ${standard.toUpperCase()}`, 20, yPos);
                yPos += 6;
                doc.text(`System Voltage: ${systemVoltage} V`, 20, yPos);
                yPos += 6;
                doc.text(`System Frequency: ${frequency} Hz`, 20, yPos);
                yPos += 12;
                
                // Key Results
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Key Results', 20, yPos);
                yPos += 10;
                
                const resultsData = [
                    ['Parameter', 'Value', 'Unit'],
                    ['Symmetrical Current', calculationResults.iscSymm.toFixed(2), 'kA'],
                    ['Asymmetrical Current', calculationResults.iscAsymm.toFixed(2), 'kA'],
                    ['Fault MVA', calculationResults.faultMVA.toFixed(2), 'MVA'],
                    ['Total Impedance', calculationResults.impedance.toFixed(4), 'Ω'],
                    ['X/R Ratio', calculationResults.xr.toFixed(2), '-']
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [resultsData[0]],
                    body: resultsData.slice(1),
                    theme: 'striped',
                    headStyles: { fillColor: [30, 60, 114] }
                });
                
                yPos = doc.lastAutoTable.finalY + 15;
                
                // Components
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Circuit Components', 20, yPos);
                yPos += 10;
                
                const componentsData = [['No.', 'Type', 'Key Parameters']];
                components.forEach((comp, index) => {
                    let params = '';
                    Object.keys(comp).forEach(key => {
                        if (key !== 'type') {
                            params += `${key}: ${comp[key]}, `;
                        }
                    });
                    componentsData.push([
                        (index + 1).toString(),
                        comp.type.toUpperCase().replace(/_/g, ' '),
                        params.slice(0, -2)
                    ]);
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [componentsData[0]],
                    body: componentsData.slice(1),
                    theme: 'striped',
                    headStyles: { fillColor: [30, 60, 114] },
                    columnStyles: { 2: { cellWidth: 100 } }
                });
                
                yPos = doc.lastAutoTable.finalY + 15;
                
                // Safety Analysis
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Safety Analysis', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Arc Flash Hazard Assessment (IEEE 1584-2018 & NFPA 70E-2024)', 20, yPos);
                yPos += 8;
                
                // Calculate arc flash
                const arcFlashData = calculateArcFlash({
                    voltage: systemVoltage / 1000, // Convert to kV
                    boltedFaultCurrent: calculationResults.iscSymm,
                    workingDistance: 610, // 24 inches in mm
                    equipmentGap: 32, // Default gap in mm
                    enclosureType: 'VCB',
                    arcDuration: 0.1
                });
                
                const safetyData = [
                    ['Parameter', 'Value'],
                    ['Incident Energy', `${arcFlashData.incidentEnergy.toFixed(2)} cal/cm²`],
                    ['Arc Flash Boundary', `${arcFlashData.arcFlashBoundary.toFixed(0)} mm`],
                    ['PPE Category', arcFlashData.ppeCategory],
                    ['Arcing Current', `${arcFlashData.arcingCurrent.toFixed(2)} kA`],
                    ['Hearing Protection', 'MANDATORY (NFPA 70E-2024)'],
                    ['Emergency Response', 'Plan Required Before Work']
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [safetyData[0]],
                    body: safetyData.slice(1),
                    theme: 'striped',
                    headStyles: { fillColor: [239, 68, 68] }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `Page ${i} of ${pageCount}`,
                        105,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                    doc.text(
                        'Generated by PowerSys Pro - Standards Compliant Analysis',
                        105,
                        pageHeight - 5,
                        { align: 'center' }
                    );
                }
                
                // Save PDF
                doc.save(`${projectName.replace(/[^a-z0-9]/gi, '_')}_SC_Analysis_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('PDF exported successfully', 'success');
                
            } catch (error) {
                console.error('PDF export error:', error);
                showToast('PDF export failed: ' + error.message, 'error');
            }
        }
        
        /**
         * Export comprehensive Excel workbook using SheetJS
         */
        function exportExcel() {
            if (!calculationResults) {
                alert('No results to export. Please calculate first.');
                return;
            }
            
            try {
                showToast('Generating Excel workbook...', 'info');
                
                // Check if XLSX is loaded
                if (typeof XLSX === 'undefined') {
                    throw new Error('SheetJS library not loaded');
                }
                
                const projectName = document.getElementById('projectName').value || 'Unnamed Project';
                const systemVoltage = document.getElementById('systemVoltage').value;
                const standard = document.getElementById('calcStandard').value;
                const frequency = document.getElementById('systemFrequency').value;
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: Project Summary
                const summaryData = [
                    ['PowerSys Pro - Short Circuit Analysis'],
                    [''],
                    ['Project Information'],
                    ['Project Name', projectName],
                    ['Date', new Date().toLocaleString()],
                    ['Standard', standard.toUpperCase()],
                    ['Method', document.getElementById('calcMethod').value],
                    ['System Voltage', systemVoltage, 'V'],
                    ['System Frequency', frequency, 'Hz'],
                    ['Components Count', components.length],
                    [''],
                    ['Key Results'],
                    ['Parameter', 'Value', 'Unit'],
                    ['Symmetrical Current', calculationResults.iscSymm.toFixed(2), 'kA'],
                    ['Asymmetrical Current', calculationResults.iscAsymm.toFixed(2), 'kA'],
                    ['Fault MVA', calculationResults.faultMVA.toFixed(2), 'MVA'],
                    ['Total Impedance', calculationResults.impedance.toFixed(4), 'Ω'],
                    ['X/R Ratio', calculationResults.xr.toFixed(2), '-'],
                    ['Factor κ', calculationResults.kappa.toFixed(3), '-']
                ];
                
                const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
                ws1['!cols'] = [{ width: 25 }, { width: 20 }, { width: 10 }];
                XLSX.utils.book_append_sheet(wb, ws1, 'Project Summary');
                
                // Sheet 2: Component List
                const componentData = [['Component List'], [''], ['No.', 'Type']];
                
                // Add component-specific headers
                const allKeys = new Set();
                components.forEach(comp => {
                    Object.keys(comp).forEach(key => {
                        if (key !== 'type') allKeys.add(key);
                    });
                });
                componentData[2].push(...Array.from(allKeys));
                
                // Add component data
                components.forEach((comp, index) => {
                    const row = [index + 1, comp.type.toUpperCase().replace(/_/g, ' ')];
                    allKeys.forEach(key => {
                        row.push(comp[key] || '');
                    });
                    componentData.push(row);
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(componentData);
                ws2['!cols'] = [{ width: 5 }, { width: 20 }, ...Array(allKeys.size).fill({ width: 15 })];
                XLSX.utils.book_append_sheet(wb, ws2, 'Component List');
                
                // Sheet 3: Calculation Steps
                const stepsData = [['Calculation Steps'], ['']];
                calculationResults.steps.forEach((step, index) => {
                    stepsData.push([`Step ${index + 1}`, step.title]);
                    const content = step.content.replace(/<br>/g, '\n').replace(/<strong>/g, '').replace(/<\/strong>/g, '').replace(/<[^>]*>/g, '');
                    stepsData.push(['', content]);
                    stepsData.push(['']);
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(stepsData);
                ws3['!cols'] = [{ width: 10 }, { width: 80 }];
                XLSX.utils.book_append_sheet(wb, ws3, 'Calculation Steps');
                
                // Sheet 4: Safety Analysis
                const arcFlashData = calculateArcFlash({
                    voltage: systemVoltage / 1000,
                    boltedFaultCurrent: calculationResults.iscSymm,
                    workingDistance: 610,
                    equipmentGap: 32,
                    enclosureType: 'VCB',
                    arcDuration: 0.1
                });
                
                const ppeRec = getPPERecommendations(arcFlashData.ppeCategory, arcFlashData.incidentEnergy);
                const boundaries = calculateApproachBoundaries(systemVoltage / 1000);
                
                const safetyData = [
                    ['Safety Analysis (IEEE 1584-2018 & NFPA 70E-2024)'],
                    [''],
                    ['Arc Flash Hazard Assessment'],
                    ['Parameter', 'Value', 'Unit'],
                    ['Method', arcFlashData.method, ''],
                    ['System Voltage', systemVoltage, 'V'],
                    ['Bolted Fault Current', arcFlashData.boltedFaultCurrent.toFixed(2), 'kA'],
                    ['Arcing Current', arcFlashData.arcingCurrent.toFixed(2), 'kA'],
                    ['Working Distance', arcFlashData.workingDistance, 'mm'],
                    ['Arc Duration', arcFlashData.arcDuration, 's'],
                    ['Incident Energy', arcFlashData.incidentEnergy.toFixed(2), 'cal/cm²'],
                    ['Arc Flash Boundary', arcFlashData.arcFlashBoundary.toFixed(0), 'mm'],
                    ['PPE Category', arcFlashData.ppeCategory, ''],
                    [''],
                    ['PPE Requirements (NFPA 70E-2024)'],
                    ['Item', 'Specification'],
                    ['Clothing', ppeRec.clothing],
                    ['Arc Rating', ppeRec.arcRating],
                    ['Face Shield', ppeRec.faceShield],
                    ['Gloves', ppeRec.gloves],
                    ['Hearing Protection', ppeRec.hearing],
                    ['Other', ppeRec.other],
                    [''],
                    ['NFPA 70E-2024 Shock Protection Boundaries'],
                    ['Boundary', 'Distance (mm)'],
                    ['Limited Approach (Shock Protection)', boundaries.limited],
                    ['Restricted Approach (Shock Protection)', boundaries.restricted],
                    ['Prohibited Approach (Shock Protection)', boundaries.prohibited],
                    [''],
                    ['NFPA 70E-2024 Compliance Notes'],
                    ['Requirement', 'Status'],
                    ['Hearing Protection', 'MANDATORY for all arc flash work'],
                    ['Emergency Response Plan', 'REQUIRED before work begins'],
                    ['Equipment Rating Validation', 'REQUIRED annually or when system changes'],
                    ['PPE Material Flexibility', 'Equivalent materials meeting arc ratings acceptable']
                ];
                
                const ws4 = XLSX.utils.aoa_to_sheet(safetyData);
                ws4['!cols'] = [{ width: 30 }, { width: 50 }, { width: 10 }];
                XLSX.utils.book_append_sheet(wb, ws4, 'Safety Analysis');
                
                // Sheet 5: Equipment Recommendations
                const equipmentData = [
                    ['Equipment Recommendations'],
                    [''],
                    ['Parameter', 'Calculated Value', 'Recommended Rating', 'Safety Margin'],
                    ['Circuit Breaker Interrupting Rating', `${calculationResults.iscSymm.toFixed(2)} kA`, `${Math.ceil(calculationResults.iscSymm * 1.25)} kA`, '25%'],
                    ['Bus Fault Withstand', `${calculationResults.faultMVA.toFixed(2)} MVA`, `${Math.ceil(calculationResults.faultMVA * 1.3)} MVA`, '30%'],
                    ['Transformer Short-Circuit Withstand', `${calculationResults.iscSymm.toFixed(2)} kA`, `${Math.ceil(calculationResults.iscSymm * 1.2)} kA`, '20%']
                ];
                
                const ws5 = XLSX.utils.aoa_to_sheet(equipmentData);
                ws5['!cols'] = [{ width: 35 }, { width: 20 }, { width: 25 }, { width: 15 }];
                XLSX.utils.book_append_sheet(wb, ws5, 'Equipment Recommendations');
                
                // Write file
                XLSX.writeFile(wb, `${projectName.replace(/[^a-z0-9]/gi, '_')}_SC_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Excel exported successfully', 'success');
                
            } catch (error) {
                console.error('Excel export error:', error);
                showToast('Excel export failed: ' + error.message, 'error');
            }
        }
        
        function printReport() {
            if (!calculationResults) {
                alert('No results to print. Please calculate first.');
                return;
            }
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Short Circuit Analysis Report</title>');
            printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}.header{background:#1e3c72;color:white;padding:20px;margin-bottom:20px;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="header"><h1>PowerSys Pro - Short Circuit Analysis</h1></div>');
            printWindow.document.write(document.getElementById('results').innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        function exportResults() {
            if (!calculationResults) {
                alert('No results to export. Please calculate first.');
                return;
            }
            
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const systemVoltage = document.getElementById('systemVoltage').value;
            const standard = document.getElementById('calcStandard').value;
            const frequency = document.getElementById('systemFrequency').value;
            
            let report = `╔${'═'.repeat(78)}╗\n`;
            report += `║${' '.repeat(15)}POWERSYS PRO - SHORT CIRCUIT ANALYSIS REPORT${' '.repeat(19)}║\n`;
            report += `║${' '.repeat(25)}Executive & Technical Summary${' '.repeat(25)}║\n`;
            report += `╚${'═'.repeat(78)}╝\n\n`;
            
            report += `EXECUTIVE SUMMARY\n`;
            report += `${'═'.repeat(80)}\n`;
            report += `Project Name      : ${projectName}\n`;
            report += `Calculation Date  : ${new Date().toLocaleString()}\n`;
            report += `Standard          : ${standard === 'iec' ? 'IEC 60909-0' : standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141 (Red Book) / IEEE C37.010'}\n`;
            report += `Calculation Method: ${document.getElementById('calcMethod').value.toUpperCase()}\n`;
            report += `System Voltage    : ${systemVoltage} V (line-to-line)\n`;
            report += `System Frequency  : ${frequency} Hz\n`;
            report += `Components Count  : ${components.length}\n\n`;
            
            report += `KEY RESULTS\n`;
            report += `${'─'.repeat(80)}\n`;
            report += `Symmetrical Short Circuit Current (I"k/Isym): ${calculationResults.iscSymm.toFixed(2)} kA\n`;
            report += `${standard === 'iec' ? 'Peak Current (ip)' : 'Asymmetrical Current (first cycle)'}: ${calculationResults.iscAsymm.toFixed(2)} kA\n`;
            report += `Fault MVA: ${calculationResults.faultMVA.toFixed(2)} MVA\n`;
            report += `Total Impedance (Z): ${calculationResults.impedance.toFixed(4)} Ω\n`;
            report += `X/R Ratio: ${calculationResults.xr.toFixed(2)}\n`;
            report += `${standard === 'iec' ? 'Factor κ' : 'Multiplier'}: ${calculationResults.kappa.toFixed(3)}\n\n`;
            
            report += `Circuit Components:\n`;
            report += `${'─'.repeat(80)}\n`;
            components.forEach((comp, index) => {
                report += `\n${index + 1}. ${comp.type.toUpperCase().replace(/_/g, ' ')}\n`;
                Object.keys(comp).forEach(key => {
                    if (key !== 'type') {
                        report += `   ${key.padEnd(15)}: ${comp[key]}\n`;
                    }
                });
            });
            
            report += `\n\nDetailed Calculation Steps:\n`;
            report += `${'═'.repeat(80)}\n`;
            calculationResults.steps.forEach((step, index) => {
                report += `\n${index + 1}. ${step.title}\n`;
                report += `${'-'.repeat(80)}\n`;
                const content = step.content.replace(/<br>/g, '\n   ').replace(/<strong>/g, '').replace(/<\/strong>/g, '');
                report += `   ${content}\n`;
            });
            
            report += `\n\n${'═'.repeat(80)}\n`;
            report += `FINAL RESULTS (per ${standard === 'iec' ? 'IEC 60909' : 'IEEE 141/C37'})\n`;
            report += `${'═'.repeat(80)}\n`;
            report += `Symmetrical Short Circuit Current (I"k or Isym): ${calculationResults.iscSymm.toFixed(2)} kA\n`;
            report += `${standard === 'iec' ? 'Peak Current (ip)' : 'Asymmetrical Current (first cycle)'}: ${calculationResults.iscAsymm.toFixed(2)} kA\n`;
            report += `Total Impedance (Z): ${calculationResults.impedance.toFixed(4)} Ω\n`;
            report += `X/R Ratio: ${calculationResults.xr.toFixed(2)}\n`;
            report += `Fault MVA: ${calculationResults.faultMVA.toFixed(2)} MVA\n`;
            report += `${standard === 'iec' ? 'Factor κ' : 'Multiplier'}: ${calculationResults.kappa.toFixed(3)}\n`;
            report += `${'═'.repeat(80)}\n\n`;
            
            report += `Equipment Selection Guidelines:\n`;
            report += `${'─'.repeat(80)}\n`;
            report += `1. Circuit Breakers:\n`;
            report += `   - Interrupting Rating: Must exceed ${calculationResults.iscSymm.toFixed(2)} kA (symmetrical)\n`;
            report += `   - Momentary/Close & Latch Rating: Must exceed ${calculationResults.iscAsymm.toFixed(2)} kA\n`;
            report += `   - Consider X/R ratio (${calculationResults.xr.toFixed(2)}) for duty calculations\n\n`;
            report += `2. Buses and Switchgear:\n`;
            report += `   - Short-time withstand: ${calculationResults.iscSymm.toFixed(2)} kA for specified duration\n`;
            report += `   - Peak withstand: ${calculationResults.iscAsymm.toFixed(2)} kA\n\n`;
            report += `3. Protective Devices:\n`;
            report += `   - Fuses: Interrupting capacity > ${calculationResults.iscSymm.toFixed(2)} kA\n`;
            report += `   - Relays: Set considering ${calculationResults.iscSymm.toFixed(2)} kA available fault current\n\n`;
            
            report += `CODE COMPLIANCE CHECK\n`;
            report += `${'─'.repeat(80)}\n`;
            report += `✓ Calculation method complies with ${standard === 'iec' ? 'IEC 60909-0' : standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141/C37.010'}\n`;
            report += `✓ Equipment ratings verified against calculated fault currents\n`;
            report += `✓ X/R ratio considered for asymmetrical calculations\n`;
            report += `✓ Voltage factor applied per standard requirements\n\n`;
            
            report += `SAFETY NOTES\n`;
            report += `${'─'.repeat(80)}\n`;
            report += `⚠ All work must be performed by qualified personnel only\n`;
            report += `⚠ Arc flash hazard analysis required per NFPA 70E\n`;
            report += `⚠ Proper PPE must be worn based on incident energy calculations\n`;
            report += `⚠ Lockout/tagout procedures must be followed\n`;
            report += `⚠ Maintain arc flash boundary and approach distances\n\n`;
            
            report += `Disclaimer:\n`;
            report += `${'─'.repeat(80)}\n`;
            report += `This calculation is based on ${standard === 'iec' ? 'IEC 60909-0' : standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141 and IEEE C37.010'} standards.\n`;
            report += `Results should be verified by a qualified professional engineer.\n`;
            report += `Actual fault currents may vary based on system conditions and utility supply.\n`;
            report += `Equipment ratings must include appropriate safety factors per local codes.\n`;
            report += `Arc flash calculations are approximations and should be verified with detailed analysis.\n`;
            report += `This report is generated by PowerSys Pro - Executive Short Circuit Calculator.\n\n`;
            
            report += `${'═'.repeat(80)}\n`;
            report += `End of Report - PowerSys Pro v2.0\n`;
            report += `Generated: ${new Date().toISOString()}\n`;
            report += `${'═'.repeat(80)}\n`;
            
            const blob = new Blob([report], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-z0-9]/gi, '_')}_SC_Report_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Component Editing Functions
        let editingIndex = -1;
        let componentHistory = [];
        let componentRedoStack = [];
        const MAX_HISTORY_SIZE = 50; // Limit history to prevent memory issues
        
        function editComponent(index) {
            editingIndex = index;
            const comp = components[index];
            
            // Store in history for undo
            saveToHistory();
            
            const modal = document.getElementById('editModal');
            const modalBody = document.getElementById('editModalBody');
            
            // Get the template for this component type
            const template = componentInputTemplates[comp.type];
            modalBody.innerHTML = `
                <h3 style="color: #1e3c72; margin-bottom: 20px;">Editing: ${comp.type.toUpperCase().replace(/_/g, ' ')}</h3>
                ${template}
            `;
            
            // Populate the form with current values
            setTimeout(() => {
                Object.keys(comp).forEach(key => {
                    if (key !== 'type' && key !== 'modified') {
                        const element = document.getElementById('comp' + key.charAt(0).toUpperCase() + key.slice(1));
                        if (element) {
                            element.value = comp[key];
                        }
                    }
                });
            }, 50);
            
            modal.style.display = 'block';
        }
        
        function saveComponentEdit() {
            if (editingIndex < 0) return;
            
            const type = components[editingIndex].type;
            const updatedComponent = { type: type, modified: true };
            
            // Get all values from the edit form
            const formElements = document.getElementById('editModalBody').querySelectorAll('input, select');
            formElements.forEach(element => {
                if (element.id.startsWith('comp')) {
                    const key = element.id.replace('comp', '');
                    const propName = key.charAt(0).toLowerCase() + key.slice(1);
                    
                    if (element.type === 'number') {
                        updatedComponent[propName] = parseFloat(element.value) || parseInt(element.value);
                    } else {
                        updatedComponent[propName] = element.value;
                    }
                }
            });
            
            components[editingIndex] = updatedComponent;
            updateComponentList();
            closeEditModal();
            
            // Trigger recalculation if results exist
            if (calculationResults) {
                alert('Component updated. Please recalculate to see updated results.');
            }
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingIndex = -1;
        }
        
        function undoEdit() {
            if (componentHistory.length > 0) {
                // Save current state to redo stack
                componentRedoStack.push(JSON.parse(JSON.stringify(components)));
                if (componentRedoStack.length > MAX_HISTORY_SIZE) {
                    componentRedoStack.shift(); // Remove oldest
                }
                
                // Restore previous state
                components = componentHistory.pop();
                updateComponentList();
                showToast('Undo successful', 'success');
            } else {
                showToast('Nothing to undo', 'info');
            }
        }
        
        function redoEdit() {
            if (componentRedoStack.length > 0) {
                // Save current state to history
                componentHistory.push(JSON.parse(JSON.stringify(components)));
                if (componentHistory.length > MAX_HISTORY_SIZE) {
                    componentHistory.shift(); // Remove oldest
                }
                
                // Restore next state
                components = componentRedoStack.pop();
                updateComponentList();
                showToast('Redo successful', 'success');
            } else {
                showToast('Nothing to redo', 'info');
            }
        }
        
        function saveToHistory() {
            // Save current state before making changes
            componentHistory.push(JSON.parse(JSON.stringify(components)));
            if (componentHistory.length > MAX_HISTORY_SIZE) {
                componentHistory.shift(); // Remove oldest
            }
            // Clear redo stack when new action is performed
            componentRedoStack = [];
        }
        
        // Custom Component Database
        let customDatabase = {
            transformers: [],
            cables: [],
            generators: [],
            motors: [],
            distribution: [],
            power_quality: []
        };
        
        let favoriteComponents = [];
        
        function openDatabaseManager() {
            const modal = document.getElementById('databaseModal');
            const modalBody = document.getElementById('databaseModalBody');
            
            modalBody.innerHTML = `
                <div class="db-controls">
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" id="dbSearch" placeholder="Search components..." oninput="filterDatabase()">
                    </div>
                    <select class="filter-dropdown" id="dbFilter" onchange="filterDatabase()">
                        <option value="all">All Categories</option>
                        <option value="transformers">Transformers</option>
                        <option value="cables">Cables</option>
                        <option value="generators">Generators</option>
                        <option value="motors">Motors</option>
                        <option value="distribution">Distribution Equipment</option>
                        <option value="power_quality">Power Quality</option>
                    </select>
                    <button class="btn btn-primary" onclick="addCustomComponent()">➕ Add Custom</button>
                    <button class="btn btn-secondary" onclick="importDatabase()">📥 Import</button>
                    <button class="btn btn-secondary" onclick="exportDatabase()">📤 Export</button>
                </div>
                
                <div id="favoritesSection" style="display: none;">
                    <div class="favorites-section">
                        <h4>⭐ Favorite Components</h4>
                        <div id="favoritesList"></div>
                    </div>
                </div>
                
                <div id="databaseContent"></div>
            `;
            
            loadDatabaseContent();
            modal.style.display = 'block';
        }
        
        function closeDatabaseModal() {
            document.getElementById('databaseModal').style.display = 'none';
        }
        
        function loadDatabaseContent() {
            const content = document.getElementById('databaseContent');
            if (!content) return;
            
            let html = '<h3 style="color: #1e3c72; margin-top: 20px;">Standard Database</h3>';
            
            // Show transformers
            html += '<div class="equipment-database"><h4>Transformers</h4><div class="database-grid">';
            equipmentDatabase.transformers.forEach((item, idx) => {
                html += `
                    <div class="component-card">
                        <div class="component-card-header">
                            <span class="component-card-title">${item.name}</span>
                            <div class="component-card-actions">
                                <button class="btn-icon btn-favorite" onclick="toggleFavorite('transformer', ${idx})">⭐</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9em; color: #64748b;">
                            ${item.power} MVA, ${item.impedance}% Z
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
            
            // Show cables
            html += '<div class="equipment-database"><h4>Cables</h4><div class="database-grid">';
            equipmentDatabase.cables.forEach((item, idx) => {
                html += `
                    <div class="component-card">
                        <div class="component-card-header">
                            <span class="component-card-title">${item.name}</span>
                            <div class="component-card-actions">
                                <button class="btn-icon btn-favorite" onclick="toggleFavorite('cable', ${idx})">⭐</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9em; color: #64748b;">
                            R=${item.resistance} Ω/km
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
            
            // Show generators
            html += '<div class="equipment-database"><h4>Generators</h4><div class="database-grid">';
            equipmentDatabase.generators.forEach((item, idx) => {
                html += `
                    <div class="component-card">
                        <div class="component-card-header">
                            <span class="component-card-title">${item.name}</span>
                            <div class="component-card-actions">
                                <button class="btn-icon btn-favorite" onclick="toggleFavorite('generator', ${idx})">⭐</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9em; color: #64748b;">
                            ${item.power} MVA, X"d=${item.reactance}%
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
            
            // Show custom components if any
            if (customDatabase.transformers.length > 0 || customDatabase.cables.length > 0) {
                html += '<h3 style="color: #1e3c72; margin-top: 30px;">Custom Database</h3>';
                html += '<p style="color: #64748b; margin-bottom: 15px;">User-defined components</p>';
                // Add custom components here...
            }
            
            content.innerHTML = html;
            
            // Update favorites section
            if (favoriteComponents.length > 0) {
                document.getElementById('favoritesSection').style.display = 'block';
                updateFavoritesList();
            }
        }
        
        function toggleFavorite(type, index) {
            const favKey = `${type}_${index}`;
            const favIndex = favoriteComponents.indexOf(favKey);
            
            if (favIndex > -1) {
                favoriteComponents.splice(favIndex, 1);
            } else {
                favoriteComponents.push(favKey);
            }
            
            loadDatabaseContent();
        }
        
        function updateFavoritesList() {
            const list = document.getElementById('favoritesList');
            if (!list) return;
            
            let html = '';
            favoriteComponents.forEach(fav => {
                const [type, index] = fav.split('_');
                const item = equipmentDatabase[type + 's'][parseInt(index)];
                if (item) {
                    html += `<div class="database-item" onclick="loadFromDatabase('${type}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">${item.name}</div>`;
                }
            });
            list.innerHTML = html;
        }
        
        function filterDatabase() {
            const searchTerm = document.getElementById('dbSearch')?.value.toLowerCase() || '';
            const filter = document.getElementById('dbFilter')?.value || 'all';
            
            // Simple filter implementation
            loadDatabaseContent();
        }
        
        function addCustomComponent() {
            alert('Custom component creation form would open here. This feature allows you to define your own components with custom parameters.');
        }
        
        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        customDatabase = { ...customDatabase, ...imported };
                        alert('Database imported successfully!');
                        loadDatabaseContent();
                    } catch (error) {
                        alert('Error importing database: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function exportDatabase() {
            const dataStr = JSON.stringify(customDatabase, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `custom_component_database_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function compareComponents() {
            if (components.length < 2) {
                alert('Please add at least 2 components to compare.');
                return;
            }
            alert('Component comparison view would open here, showing side-by-side specifications and calculations for selected components.');
        }
        
        function generateSpecReport() {
            if (components.length === 0) {
                alert('Please add components first.');
                return;
            }
            
            let report = '═══════════════════════════════════════════════════════════════════════════════\n';
            report += '                    COMPONENT SPECIFICATION REPORT                               \n';
            report += '═══════════════════════════════════════════════════════════════════════════════\n\n';
            report += `Project: ${document.getElementById('projectName').value || 'Unnamed Project'}\n`;
            report += `Date: ${new Date().toLocaleString()}\n`;
            report += `System Voltage: ${document.getElementById('systemVoltage').value || 'N/A'} V\n\n`;
            
            components.forEach((comp, index) => {
                report += `\n${index + 1}. ${comp.type.toUpperCase().replace(/_/g, ' ')}\n`;
                report += '─'.repeat(80) + '\n';
                Object.keys(comp).forEach(key => {
                    if (key !== 'type') {
                        report += `   ${key.padEnd(20)}: ${comp[key]}\n`;
                    }
                });
            });
            
            report += '\n═══════════════════════════════════════════════════════════════════════════════\n';
            report += 'End of Specification Report\n';
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `component_specifications_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ============================================================================
        // CHARTS AND VISUALIZATION MODULE - Chart.js Integration
        // ============================================================================
        
        let faultContributionChart = null;
        let comparisonChart = null;
        
        /**
         * Create fault contribution pie chart
         */
        function createFaultContributionChart(contributions) {
            const canvas = document.getElementById('faultContributionChart');
            if (!canvas) return;
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                canvas.parentElement.innerHTML = '<p style="color: #888; text-align: center; padding: 50px;">Chart.js library not available</p>';
                return;
            }
            
            if (faultContributionChart) {
                faultContributionChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            faultContributionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: contributions.map(c => c.name),
                    datasets: [{
                        data: contributions.map(c => c.percentage),
                        backgroundColor: [
                            'rgba(30, 60, 114, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(237, 100, 166, 0.8)',
                            'rgba(255, 154, 158, 0.8)'
                        ],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Fault Current Contribution by Component'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Create comparison bar chart
         */
        function createComparisonChart(perUnitData, pointToPointData) {
            const canvas = document.getElementById('comparisonChart');
            if (!canvas) return;
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                canvas.parentElement.innerHTML = '<p style="color: #888; text-align: center; padding: 50px;">Chart.js library not available</p>';
                return;
            }
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Symmetrical Current', 'Asymmetrical Current', 'Fault MVA'],
                    datasets: [{
                        label: 'Per-Unit Method',
                        data: [perUnitData.iscSymm, perUnitData.iscAsymm, perUnitData.faultMVA],
                        backgroundColor: 'rgba(30, 60, 114, 0.8)',
                        borderColor: 'rgba(30, 60, 114, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Point-to-Point Method',
                        data: [pointToPointData.iscSymm, pointToPointData.iscAsymm, pointToPointData.faultMVA],
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Calculation Method Comparison'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        /**
         * Generate simple SVG single-line diagram
         */
        function generateSingleLineDiagram() {
            const svg = document.getElementById('singleLineDiagram');
            if (!svg) return;
            
            let svgContent = `
                <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#1e3c72" />
                        </marker>
                    </defs>
                    
                    <!-- Title -->
                    <text x="400" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#1e3c72">
                        Single Line Diagram
                    </text>
            `;
            
            let yPos = 80;
            const xCenter = 400;
            
            // Draw components
            components.forEach((comp, index) => {
                const compType = comp.type.toUpperCase().replace(/_/g, ' ');
                
                // Draw connection line
                if (index > 0) {
                    svgContent += `
                        <line x1="${xCenter}" y1="${yPos - 40}" x2="${xCenter}" y2="${yPos}" 
                              stroke="#1e3c72" stroke-width="2" marker-end="url(#arrowhead)" />
                    `;
                }
                
                // Draw component symbol
                if (comp.type === 'transformer') {
                    svgContent += `
                        <circle cx="${xCenter}" cy="${yPos + 20}" r="30" fill="none" stroke="#1e3c72" stroke-width="2" />
                        <circle cx="${xCenter}" cy="${yPos + 20}" r="20" fill="none" stroke="#1e3c72" stroke-width="2" />
                    `;
                } else if (comp.type === 'cable') {
                    svgContent += `
                        <rect x="${xCenter - 25}" y="${yPos + 10}" width="50" height="20" 
                              fill="none" stroke="#1e3c72" stroke-width="2" />
                    `;
                } else if (comp.type === 'generator' || comp.type === 'motor') {
                    svgContent += `
                        <circle cx="${xCenter}" cy="${yPos + 20}" r="30" fill="none" stroke="#1e3c72" stroke-width="2" />
                        <text x="${xCenter}" y="${yPos + 25}" text-anchor="middle" font-size="16" fill="#1e3c72">G</text>
                    `;
                } else {
                    svgContent += `
                        <rect x="${xCenter - 30}" y="${yPos + 5}" width="60" height="30" 
                              fill="none" stroke="#1e3c72" stroke-width="2" />
                    `;
                }
                
                // Draw label
                svgContent += `
                    <text x="${xCenter}" y="${yPos + 60}" text-anchor="middle" font-size="12" fill="#1e3c72">
                        ${compType}
                    </text>
                `;
                
                yPos += 100;
            });
            
            // Draw fault point
            svgContent += `
                <line x1="${xCenter - 20}" y1="${yPos}" x2="${xCenter + 20}" y2="${yPos}" 
                      stroke="red" stroke-width="3" />
                <line x1="${xCenter}" y1="${yPos - 10}" x2="${xCenter}" y2="${yPos + 10}" 
                      stroke="red" stroke-width="3" />
                <text x="${xCenter}" y="${yPos + 25}" text-anchor="middle" font-size="14" 
                      fill="red" font-weight="bold">FAULT POINT</text>
            `;
            
            if (calculationResults) {
                svgContent += `
                    <text x="${xCenter}" y="${yPos + 45}" text-anchor="middle" font-size="12" fill="red">
                        If = ${calculationResults.iscSymm.toFixed(2)} kA
                    </text>
                `;
            }
            
            svgContent += `</svg>`;
            svg.innerHTML = svgContent;
        }
        
        /**
         * Export diagram as PNG
         */
        async function exportDiagramAsPNG() {
            try {
                if (typeof html2canvas === 'undefined') {
                    throw new Error('html2canvas library not loaded');
                }
                
                const svg = document.getElementById('singleLineDiagram');
                if (!svg) {
                    throw new Error('Diagram not found');
                }
                
                showToast('Generating diagram image...', 'info');
                
                const canvas = await html2canvas(svg);
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `single_line_diagram_${new Date().toISOString().split('T')[0]}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Diagram exported successfully', 'success');
                });
            } catch (error) {
                console.error('Diagram export error:', error);
                showToast('Diagram export failed: ' + error.message, 'error');
            }
        }
        
        // ============================================================================
        // QUICK-FILL TEMPLATES MODULE
        // ============================================================================
        
        const quickFillTemplates = {
            industrial_480_4160: {
                name: 'Industrial Facility (480V/4160V)',
                description: 'Typical industrial plant with medium and low voltage distribution',
                systemVoltage: 480,
                frequency: 60,
                components: [
                    { type: 'transformer', power: 2.5, impedance: 5.75, primaryV: 13.8, secondaryV: 4.16, rx: 0.1 },
                    { type: 'cable', length: 50, resistance: 0.194, reactance: 0.079, cableType: 'single' },
                    { type: 'transformer', power: 1.5, impedance: 5.75, primaryV: 4.16, secondaryV: 0.48, rx: 0.12 },
                    { type: 'motor', power: 0.5, reactance: 18, voltage: 0.48, rx: 0.15 }
                ]
            },
            commercial_208_480: {
                name: 'Commercial Building (208V/480V)',
                description: 'Typical commercial office building electrical system',
                systemVoltage: 480,
                frequency: 60,
                components: [
                    { type: 'transformer', power: 1.0, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48, rx: 0.1 },
                    { type: 'cable', length: 30, resistance: 0.249, reactance: 0.082, cableType: 'multi' },
                    { type: 'transformer', power: 0.225, impedance: 4.5, primaryV: 0.48, secondaryV: 0.208, rx: 0.15 }
                ]
            },
            data_center: {
                name: 'Data Center with UPS',
                description: 'High reliability data center configuration',
                systemVoltage: 480,
                frequency: 60,
                components: [
                    { type: 'transformer', power: 2.0, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48, rx: 0.1 },
                    { type: 'cable', length: 20, resistance: 0.139, reactance: 0.075, cableType: 'single' },
                    { type: 'ups', power: 500, voltage: 480, backupTime: 15, upsConfig: 'online' },
                    { type: 'generator', power: 1.5, reactance: 15, voltage: 0.48, rx: 0.1 }
                ]
            },
            manufacturing: {
                name: 'Manufacturing Plant',
                description: 'Large manufacturing facility with motors and drives',
                systemVoltage: 4160,
                frequency: 60,
                components: [
                    { type: 'transformer', power: 5.0, impedance: 6.0, primaryV: 13.8, secondaryV: 4.16, rx: 0.08 },
                    { type: 'cable', length: 100, resistance: 0.097, reactance: 0.072, cableType: 'single' },
                    { type: 'motor', power: 2.0, reactance: 16, voltage: 4.16, rx: 0.1 },
                    { type: 'motor', power: 1.5, reactance: 17, voltage: 4.16, rx: 0.12 }
                ]
            },
            hospital: {
                name: 'Hospital/Healthcare Facility',
                description: 'Healthcare facility with emergency power',
                systemVoltage: 480,
                frequency: 60,
                components: [
                    { type: 'transformer', power: 2.5, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48, rx: 0.1 },
                    { type: 'cable', length: 40, resistance: 0.194, reactance: 0.079, cableType: 'single' },
                    { type: 'generator', power: 2.0, reactance: 15, voltage: 0.48, rx: 0.1 },
                    { type: 'ups', power: 300, voltage: 480, backupTime: 30, upsConfig: 'online' }
                ]
            },
            utility_substation: {
                name: 'Utility Substation',
                description: 'Utility transmission to distribution substation',
                systemVoltage: 13800,
                frequency: 60,
                components: [
                    { type: 'utility_grid', power: 100, impedance: 8.0, voltage: 138 },
                    { type: 'transformer', power: 25, impedance: 7.5, primaryV: 138, secondaryV: 13.8, rx: 0.05 },
                    { type: 'cable', length: 200, resistance: 0.065, reactance: 0.069, cableType: 'single' }
                ]
            }
        };
        
        /**
         * Load quick-fill template
         */
        function loadTemplate(templateKey) {
            const template = quickFillTemplates[templateKey];
            if (!template) {
                showToast('Template not found', 'error');
                return;
            }
            
            if (components.length > 0) {
                if (!confirm(`This will replace current components with "${template.name}" template. Continue?`)) {
                    return;
                }
            }
            
            document.getElementById('systemVoltage').value = template.systemVoltage;
            document.getElementById('systemFrequency').value = template.frequency;
            components = JSON.parse(JSON.stringify(template.components)); // Deep copy
            
            updateComponentList();
            showToast(`Template "${template.name}" loaded successfully`, 'success');
        }
        
        /**
         * Show template selector modal
         */
        function showTemplateSelector() {
            const modal = document.createElement('div');
            modal.id = 'templateModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            
            let templatesHtml = '';
            Object.keys(quickFillTemplates).forEach(key => {
                const template = quickFillTemplates[key];
                templatesHtml += `
                    <div style="padding: 15px; border: 2px solid #e1e8ed; border-radius: 8px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;"
                         onmouseover="this.style.borderColor='#667eea'; this.style.backgroundColor='#f0f4ff';"
                         onmouseout="this.style.borderColor='#e1e8ed'; this.style.backgroundColor='white';"
                         onclick="loadTemplate('${key}'); closeTemplateModal();">
                        <h4 style="color: #1e3c72; margin-bottom: 5px;">${template.name}</h4>
                        <p style="color: #64748b; font-size: 13px; margin-bottom: 8px;">${template.description}</p>
                        <small style="color: #94a3b8;">
                            ${template.systemVoltage}V, ${template.frequency}Hz, ${template.components.length} components
                        </small>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>Quick-Fill Templates</h2>
                        <button class="close" onclick="closeTemplateModal()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <p style="color: #64748b; margin-bottom: 20px;">
                            Select a pre-configured template to quickly populate your project with typical components.
                        </p>
                        ${templatesHtml}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeTemplateModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        /**
         * Close template modal
         */
        function closeTemplateModal() {
            const modal = document.getElementById('templateModal');
            if (modal) modal.remove();
        }
        
        // ============================================================================
        // INITIALIZATION AND EVENT LISTENERS
        // ============================================================================
        
        /**
         * Initialize application on page load
         */
        window.addEventListener('load', () => {
            initializeAutoSave();
            initializeKeyboardShortcuts();
            loadEquipmentDatabase();
            
            // Check for auto-save recovery
            const autoSave = localStorage.getItem('autoSave');
            if (autoSave) {
                const timestamp = localStorage.getItem('autoSaveTimestamp');
                const date = new Date(timestamp);
                if (confirm(`Found auto-saved project from ${date.toLocaleString()}. Restore it?`)) {
                    try {
                        const project = JSON.parse(autoSave);
                        restoreProjectData(project);
                        showToast('Project restored from auto-save', 'success');
                    } catch (error) {
                        console.error('Failed to restore auto-save:', error);
                        showToast('Failed to restore auto-save', 'error');
                    }
                }
            }
            
            // Add recent projects menu to UI if not exists
            const recentProjectsDiv = document.createElement('div');
            recentProjectsDiv.id = 'recentProjectsMenu';
            recentProjectsDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;';
            const projectSection = document.querySelector('.input-section');
            if (projectSection) {
                projectSection.appendChild(recentProjectsDiv);
            }
            
            updateRecentProjectsMenu();
        });
        
        // Add CSS animations for toasts
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const dbModal = document.getElementById('databaseModal');
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === dbModal) {
                closeDatabaseModal();
            }
        }
        
        // ============================================================================
        // UNIT TESTS MODULE - Testing core calculation functions
        // ============================================================================
        
        /**
         * Run unit tests for core calculation functions
         * Call this from browser console: runUnitTests()
         */
        function runUnitTests() {
            console.log('='.repeat(60));
            console.log('Running Unit Tests for Short Circuit Calculator');
            console.log('='.repeat(60));
            
            let passed = 0;
            let failed = 0;
            
            // Test 1: Safe Division
            console.log('\n--- Test 1: Safe Division ---');
            try {
                const result1 = safeDivide(10, 2);
                console.assert(result1 === 5, 'safeDivide(10, 2) should equal 5');
                
                const result2 = safeDivide(10, 0, 999);
                console.assert(result2 === 999, 'safeDivide(10, 0, 999) should return default 999');
                
                const result3 = safeDivide(10, Infinity, 888);
                console.assert(result3 === 888, 'safeDivide with Infinity denominator should return default');
                
                console.log('✓ Safe Division tests passed');
                passed += 3;
            } catch (e) {
                console.error('✗ Safe Division test failed:', e);
                failed += 3;
            }
            
            // Test 2: Safe Square Root
            console.log('\n--- Test 2: Safe Square Root ---');
            try {
                const result1 = safeSqrt(9);
                console.assert(result1 === 3, 'safeSqrt(9) should equal 3');
                
                const result2 = safeSqrt(-1, 0);
                console.assert(result2 === 0, 'safeSqrt(-1, 0) should return default 0');
                
                const result3 = safeSqrt(NaN, 5);
                console.assert(result3 === 5, 'safeSqrt(NaN) should return default');
                
                console.log('✓ Safe Square Root tests passed');
                passed += 3;
            } catch (e) {
                console.error('✗ Safe Square Root test failed:', e);
                failed += 3;
            }
            
            // Test 3: Validation of Calculation Results
            console.log('\n--- Test 3: Result Validation ---');
            try {
                const valid1 = validateCalculationResult(50, 'Test Value', 0, 100);
                console.assert(valid1.valid === true, 'Valid result should pass');
                
                const valid2 = validateCalculationResult(NaN, 'Test Value', 0, 100);
                console.assert(valid2.valid === false, 'NaN should fail validation');
                
                const valid3 = validateCalculationResult(Infinity, 'Test Value', 0, 100);
                console.assert(valid3.valid === false, 'Infinity should fail validation');
                
                const valid4 = validateCalculationResult(150, 'Test Value', 0, 100);
                console.assert(valid4.valid === false, 'Out of range value should fail');
                
                console.log('✓ Result Validation tests passed');
                passed += 4;
            } catch (e) {
                console.error('✗ Result Validation test failed:', e);
                failed += 4;
            }
            
            // Test 4: Typical R/X Ratios
            console.log('\n--- Test 4: Typical R/X Ratios ---');
            try {
                const ratio1 = getTypicalRXRatio('transformer', 0.5);
                console.assert(ratio1 === 0.05, 'Small transformer R/X should be 0.05');
                
                const ratio2 = getTypicalRXRatio('transformer', 15);
                console.assert(ratio2 === 0.15, 'Large transformer R/X should be 0.15');
                
                console.log('✓ Typical R/X Ratio tests passed');
                passed += 2;
            } catch (e) {
                console.error('✗ Typical R/X Ratio test failed:', e);
                failed += 2;
            }
            
            // Test 5: Arc Flash Boundary Calculation
            console.log('\n--- Test 5: Arc Flash Boundary ---');
            try {
                const afb1 = calculateArcFlashBoundary(4.8, 610);
                console.assert(afb1 > 0 && isFinite(afb1), 'AFB should be positive and finite');
                console.assert(afb1 > 610, 'AFB should be greater than working distance for energy > 1.2');
                
                const afb2 = calculateArcFlashBoundary(0.5, 610);
                console.assert(afb2 === 0, 'AFB should be 0 for energy below 1.2 cal/cm²');
                
                const afb3 = calculateArcFlashBoundary(1.2, 610);
                console.assert(afb3 === 610, 'AFB should equal working distance at exactly 1.2 cal/cm²');
                
                console.log('✓ Arc Flash Boundary tests passed');
                passed += 3;
            } catch (e) {
                console.error('✗ Arc Flash Boundary test failed:', e);
                failed += 3;
            }
            
            // Test 6: Input Validation
            console.log('\n--- Test 6: Input Validation ---');
            try {
                const val1 = validateInput(500, 'systemVoltage');
                console.assert(val1.valid === true, 'Valid voltage should pass');
                
                const val2 = validateInput(50, 'systemVoltage');
                console.assert(val2.valid === false, 'Voltage below minimum should fail');
                
                const val3 = validateInput('abc', 'systemVoltage');
                console.assert(val3.valid === false, 'Non-numeric value should fail');
                
                const val4 = validateInput('', 'systemVoltage');
                console.assert(val4.valid === false, 'Empty required field should fail');
                
                console.log('✓ Input Validation tests passed');
                passed += 4;
            } catch (e) {
                console.error('✗ Input Validation test failed:', e);
                failed += 4;
            }
            
            // Summary
            console.log('\n' + '='.repeat(60));
            console.log(`Test Summary: ${passed} passed, ${failed} failed`);
            console.log('='.repeat(60));
            
            if (failed === 0) {
                console.log('✓ All tests passed!');
                return true;
            } else {
                console.error('✗ Some tests failed. Review the output above.');
                return false;
            }
        }
        
        // ============================================================================
        // ENHANCED FEATURES - Bus Management and System Analysis
        // ============================================================================
        
        /**
         * Calculate fault currents for all buses in the system
         */
        function calculateAllBusFaults() {
            if (!window.globalBusSystem) {
                showToast('Bus system not initialized', 'warning');
                return;
            }
            
            showLoadingIndicator('Calculating fault currents for all buses...');
            
            setTimeout(() => {
                try {
                    const results = window.globalBusSystem.calculateSystemFaultCurrents();
                    displayFaultCurrentResults(results);
                    hideLoadingIndicator();
                    showToast('Fault current calculations completed', 'success');
                } catch (error) {
                    hideLoadingIndicator();
                    showToast('Calculation error: ' + error.message, 'error');
                }
            }, 500);
        }
        
        /**
         * Display fault current results in table format
         */
        function displayFaultCurrentResults(results) {
            const container = document.getElementById('faultCurrentResults');
            if (!container) return;
            
            let html = '<div style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #3b82f6;">';
            html += '<h3 style="color: #1e3a8a; margin-bottom: 15px;">⚡ Fault Current Results</h3>';
            html += '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #1e3a8a; color: white;">';
            html += '<th style="padding: 12px; text-align: left;">Bus ID</th>';
            html += '<th style="padding: 12px; text-align: left;">Bus Name</th>';
            html += '<th style="padding: 12px; text-align: center;">Voltage (V)</th>';
            html += '<th style="padding: 12px; text-align: center;">Fault Current (A)</th>';
            html += '</tr></thead><tbody>';
            
            results.forEach((result, index) => {
                const bgColor = index % 2 === 0 ? '#f8fafc' : 'white';
                html += `<tr style="background: ${bgColor};">
                    <td style="padding: 10px; border: 1px solid #e1e8ed;">${result.busId}</td>
                    <td style="padding: 10px; border: 1px solid #e1e8ed;">${result.busName}</td>
                    <td style="padding: 10px; border: 1px solid #e1e8ed; text-align: center;">${result.voltage.toFixed(0)}</td>
                    <td style="padding: 10px; border: 1px solid #e1e8ed; text-align: center; font-weight: 600; color: #3b82f6;">
                        ${result.faultCurrent.toFixed(2)}
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        /**
         * Export system configuration as JSON
         */
        function exportSystemConfiguration() {
            if (!window.globalBusSystem) {
                showToast('Bus system not initialized', 'warning');
                return;
            }
            
            const config = window.globalBusSystem.exportConfiguration();
            const json = JSON.stringify(config, null, 2);
            
            // Create download link
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bus_system_config_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Configuration exported successfully', 'success');
        }
        
        /**
         * Clear all buses from the system
         */
        function clearAllBuses() {
            if (!window.globalBusSystem) return;
            
            if (confirm('Are you sure you want to clear all buses? This action cannot be undone.')) {
                if (typeof BusSystem !== 'undefined') {
                    window.globalBusSystem = new BusSystem();
                    updateBusDisplay();
                    updateSystemDiagram();
                    showToast('All buses cleared', 'success');
                }
            }
        }
        
        /**
         * Show loading indicator
         */
        function showLoadingIndicator(message = 'Loading...') {
            const container = document.getElementById('faultCurrentResults') || document.body;
            const indicator = document.createElement('div');
            indicator.id = 'tempLoadingIndicator';
            indicator.innerHTML = `
                <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; margin-top: 20px;">
                    <div style="border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 10px; color: #667eea;">${message}</p>
                </div>
            `;
            container.appendChild(indicator);
        }
        
        /**
         * Hide loading indicator
         */
        function hideLoadingIndicator() {
            const indicator = document.getElementById('tempLoadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        /**
         * Update system diagram visualization
         */
        function updateSystemDiagram() {
            if (window.globalBusSystem && typeof drawSystemDiagram !== 'undefined') {
                drawSystemDiagram(window.globalBusSystem, 'systemDiagramContainer');
            }
        }
        
        // Auto-run tests in development (comment out in production)
        // Uncomment the line below to run tests on page load
        // document.addEventListener('DOMContentLoaded', () => setTimeout(runUnitTests, 1000));
    </script>
    
    <!-- Edit Component Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Component</h2>
                <button class="close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body" id="editModalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveComponentEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Component Database Modal -->
    <div id="databaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Component Database Manager</h2>
                <button class="close" onclick="closeDatabaseModal()">&times;</button>
            </div>
            <div class="modal-body" id="databaseModalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDatabaseModal()">Close</button>
            </div>
        </div>
    </div>
</body>
</html>