<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerSys Pro - Executive Short Circuit Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.35);
            overflow: hidden;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1)),
                        linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1));
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            opacity: 0.3;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header .subtitle {
            font-size: 1.2em;
            font-weight: 300;
            margin-bottom: 15px;
            opacity: 0.95;
        }
        
        .standards-badge {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            padding: 8px 18px;
            border-radius: 25px;
            margin: 5px;
            font-size: 0.85em;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        
        .standards-badge:hover {
            background: rgba(255,255,255,0.35);
            transform: translateY(-2px);
        }
        
        .nav-tabs {
            display: flex;
            background: #f5f7fa;
            padding: 15px 30px 0 30px;
            border-bottom: 2px solid #e1e8ed;
        }
        
        .nav-tab {
            padding: 12px 24px;
            margin-right: 5px;
            border: none;
            background: transparent;
            color: #5a6c7d;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .nav-tab.active {
            background: white;
            color: #1e3c72;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 35px;
            padding: 35px;
            background: #fafbfc;
        }
        
        .input-section, .results-section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid #e8eef2;
        }
        
        .section-title {
            font-size: 1.6em;
            color: #1e3c72;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 5px;
            height: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        
        .info-text {
            font-size: 0.82em;
            color: #718096;
            margin-top: 5px;
            line-height: 1.5;
            font-style: italic;
        }
        
        input, select {
            width: 100%;
            padding: 13px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: #fafbfc;
        }
        
        input:hover, select:hover {
            border-color: #cbd5e0;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
            background: white;
        }
        
        input.error {
            border-color: #f56565;
            background: #fff5f5;
        }
        
        .error-message {
            color: #e53e3e;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        
        input.error + .error-message {
            display: block;
        }
        
        .component-list {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .component-item {
            background: #e8eaf6;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.45);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 10px 18px;
            font-size: 14px;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }
        
        .calculation-steps {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        
        .step-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 1.8em;
            color: #28a745;
            font-weight: 700;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            text-align: center;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .standard-selector {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }
        
        .method-selector {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #667eea;
        }
        
        .method-selector label {
            color: #1e3c72;
            font-size: 15px;
        }
        
        .comparison-mode {
            background: #fffbeb;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #fbbf24;
        }
        
        .executive-summary {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #0284c7;
        }
        
        .executive-summary h3 {
            color: #0c4a6e;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .summary-card-label {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .summary-card-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #1e3c72;
        }
        
        .equipment-database {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }
        
        .database-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .database-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            text-align: center;
        }
        
        .database-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .safety-analysis {
            background: #fef2f2;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #ef4444;
        }
        
        .safety-analysis h4 {
            color: #991b1b;
            margin-bottom: 12px;
        }
        
        .arc-flash-boundary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .boundary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }
        
        .sensitivity-analysis {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #10b981;
        }
        
        .sensitivity-analysis h4 {
            color: #065f46;
            margin-bottom: 12px;
        }
        
        .help-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        
        .help-icon {
            background: #3b82f6;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .help-tooltip:hover .help-text {
            visibility: visible;
            opacity: 1;
        }
        
        .help-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            width: 250px;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .help-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding: 10px 15px 0;
            }
            
            .main-content {
                padding: 20px;
                gap: 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .database-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>‚ö° PowerSys Pro - Executive Short Circuit Calculator</h1>
                <p class="subtitle">Professional Standards-Compliant Short Circuit Analysis & Equipment Selection</p>
                <div style="margin-top: 15px;">
                    <span class="standards-badge">IEC 60909-0</span>
                    <span class="standards-badge">IEEE 141 (Red Book)</span>
                    <span class="standards-badge">IEEE C37.010</span>
                    <span class="standards-badge">ANSI C37.5</span>
                </div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('calculator')">Calculator</button>
            <button class="nav-tab" onclick="switchTab('equipment')">Equipment Database</button>
            <button class="nav-tab" onclick="switchTab('safety')">Safety Analysis</button>
            <button class="nav-tab" onclick="switchTab('reports')">Reports & Export</button>
            <button class="nav-tab" onclick="switchTab('help')">Help & Documentation</button>
        </div>
        
        <div id="calculatorTab" class="tab-content active">
            <div class="main-content">
                <div class="input-section">
                    <h2 class="section-title">Circuit Configuration</h2>
                    
                    <div class="standard-selector">
                        <label>Calculation Standard:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">IEC 60909 is used primarily in Europe and internationally. IEEE standards are common in North America.</span>
                            </span>
                        </label>
                        <select id="calcStandard" onchange="updateMethodOptions()">
                            <option value="iec">IEC 60909-0 (Europe/International)</option>
                            <option value="ieee">IEEE 141/C37 (North America)</option>
                            <option value="ansi">ANSI C37.5 (North America)</option>
                        </select>
                        <div class="info-text">Select the applicable standard for your region and requirements</div>
                    </div>
                    
                    <div class="method-selector">
                        <label>Calculation Method:
                            <span class="help-tooltip">
                                <span class="help-icon">?</span>
                                <span class="help-text">Per-Unit method uses normalized values. Point-to-Point calculates actual impedances directly. Comparison shows both methods side-by-side.</span>
                            </span>
                        </label>
                        <select id="calcMethod">
                            <option value="per-unit">Per-Unit Method (Normalized)</option>
                            <option value="point-to-point">Point-to-Point Method (Direct)</option>
                            <option value="comparison">Comparison Mode (Both Methods)</option>
                        </select>
                        <div class="info-text">Choose your preferred calculation approach</div>
                    </div>
                
                <div class="form-group">
                    <label>Project Name:</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                </div>
                
                <div class="form-group">
                    <label>System Voltage (V):</label>
                    <input type="number" id="systemVoltage" placeholder="e.g., 480" step="0.1">
                    <div class="info-text">Line-to-line voltage at fault location</div>
                </div>
                
                <div class="form-group">
                    <label>System Frequency (Hz):</label>
                    <select id="systemFrequency">
                        <option value="60">60 Hz (North America)</option>
                        <option value="50">50 Hz (Europe/Asia)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Component Type:</label>
                    <select id="componentType">
                        <option value="transformer">Transformer</option>
                        <option value="cable">Cable</option>
                        <option value="generator">Generator</option>
                        <option value="motor">Motor</option>
                        <option value="utility_isc">Utility Source (ISC Known)</option>
                        <option value="utility_mva">Utility Source (MVA Known)</option>
                        <option value="utility_impedance">Utility Source (Impedance Known)</option>
                    </select>
                </div>
                
                <div id="componentInputs"></div>
                
                <button class="btn btn-primary" onclick="addComponent()">Add Component</button>
                
                <h3 class="section-title" style="margin-top: 30px;">Components</h3>
                <div class="component-list" id="componentList">
                    <p style="color: #999;">No components added yet</p>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="calculate()">Calculate</button>
                    <button class="btn btn-secondary" onclick="saveProject()">Save Project</button>
                    <button class="btn btn-secondary" onclick="loadProject()">Load Project</button>
                    <button class="btn btn-secondary" onclick="exportResults()">Export Results</button>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">Results & Analysis</h2>
                <div id="results">
                    <p style="color: #94a3b8; text-align: center; padding: 50px 20px; font-size: 15px;">
                        Add components and click <strong>Calculate</strong> to see comprehensive results, equipment recommendations, and safety analysis
                    </p>
                </div>
            </div>
        </div>
        </div>
        
        <div id="equipmentTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Equipment Database</h2>
                <div class="equipment-database">
                    <h4>Standard Transformer Database</h4>
                    <div class="database-grid" id="transformerDB"></div>
                </div>
                <div class="equipment-database">
                    <h4>Standard Cable Database</h4>
                    <div class="database-grid" id="cableDB"></div>
                </div>
                <div class="equipment-database">
                    <h4>Standard Generator Database</h4>
                    <div class="database-grid" id="generatorDB"></div>
                </div>
            </div>
        </div>
        
        <div id="safetyTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Safety Analysis</h2>
                <div id="safetyResults">
                    <p style="color: #94a3b8; text-align: center; padding: 50px 20px;">
                        Complete calculation first to see safety analysis including arc flash boundaries and PPE requirements
                    </p>
                </div>
            </div>
        </div>
        
        <div id="reportsTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Reports & Export</h2>
                <div style="background: white; padding: 30px; border-radius: 16px;">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">Export Options</h3>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="exportPDF()">üìÑ Export PDF Report</button>
                        <button class="btn btn-success" onclick="exportExcel()">üìä Export to Excel</button>
                        <button class="btn btn-info" onclick="exportResults()">üìù Export Text Report</button>
                        <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                    </div>
                    <div id="reportPreview" style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 10px; display: none;">
                        <h4 style="color: #1e3c72; margin-bottom: 15px;">Report Preview</h4>
                        <div id="reportContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="helpTab" class="tab-content">
            <div style="padding: 35px; background: #fafbfc;">
                <h2 class="section-title">Help & Documentation</h2>
                <div style="background: white; padding: 30px; border-radius: 16px;">
                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help1')">
                                üìò Getting Started
                            </h3>
                            <div id="help1" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>Step 1:</strong> Select your calculation standard (IEC 60909, IEEE 141, or ANSI)</p>
                                <p><strong>Step 2:</strong> Choose calculation method (Per-Unit, Point-to-Point, or Comparison)</p>
                                <p><strong>Step 3:</strong> Enter system voltage and frequency</p>
                                <p><strong>Step 4:</strong> Add components (transformers, cables, generators, motors, utility sources)</p>
                                <p><strong>Step 5:</strong> Click Calculate to see results and recommendations</p>
                            </div>
                        </div>
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help2')">
                                üìä Calculation Methods
                            </h3>
                            <div id="help2" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>Per-Unit Method:</strong> Traditional approach using normalized values (pu) on a base MVA. Best for complex systems.</p>
                                <p><strong>Point-to-Point Method:</strong> Direct impedance calculations from source to fault. Simpler for radial systems.</p>
                                <p><strong>Comparison Mode:</strong> Shows results from both methods side-by-side for verification.</p>
                            </div>
                        </div>
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help3')">
                                ‚ö° Standards Overview
                            </h3>
                            <div id="help3" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>IEC 60909-0:</strong> International standard for short-circuit calculations. Uses voltage factor c and Œ∫ factor for peak current.</p>
                                <p><strong>IEEE 141 (Red Book):</strong> IEEE recommended practice for industrial/commercial power systems.</p>
                                <p><strong>IEEE C37.010:</strong> Application guide for AC high-voltage circuit breakers. Includes asymmetrical calculations.</p>
                                <p><strong>ANSI C37.5:</strong> Methods for determining values of sinusoidal current. Used for equipment rating.</p>
                            </div>
                        </div>
                        <div class="accordion-item" style="margin-bottom: 15px;">
                            <h3 style="background: #f0f4ff; padding: 15px; border-radius: 8px; cursor: pointer; color: #1e3c72;" onclick="toggleAccordion('help4')">
                                üõ°Ô∏è Safety & Compliance
                            </h3>
                            <div id="help4" style="padding: 20px; display: none; border-left: 3px solid #667eea; margin-left: 10px;">
                                <p><strong>Arc Flash Analysis:</strong> Estimates incident energy and arc flash boundaries per IEEE 1584.</p>
                                <p><strong>PPE Selection:</strong> Recommends personal protective equipment based on calculated incident energy.</p>
                                <p><strong>Equipment Ratings:</strong> Verifies circuit breaker and equipment ratings against calculated fault currents.</p>
                                <p><strong>Code Compliance:</strong> Checks calculations against NEC and IEC requirements.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let components = [];
        let calculationResults = null;
        let perUnitResults = null;
        let pointToPointResults = null;
        
        // Equipment Database
        const equipmentDatabase = {
            transformers: [
                { name: '500 kVA', power: 0.5, impedance: 5.5, primaryV: 13.8, secondaryV: 0.48 },
                { name: '750 kVA', power: 0.75, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '1000 kVA', power: 1.0, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '1500 kVA', power: 1.5, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '2000 kVA', power: 2.0, impedance: 5.75, primaryV: 13.8, secondaryV: 0.48 },
                { name: '2500 kVA', power: 2.5, impedance: 6.0, primaryV: 13.8, secondaryV: 0.48 },
            ],
            cables: [
                { name: '4/0 AWG CU', resistance: 0.249, reactance: 0.082, type: 'single' },
                { name: '250 MCM CU', resistance: 0.194, reactance: 0.079, type: 'single' },
                { name: '350 MCM CU', resistance: 0.139, reactance: 0.075, type: 'single' },
                { name: '500 MCM CU', resistance: 0.097, reactance: 0.072, type: 'single' },
                { name: '750 MCM CU', resistance: 0.065, reactance: 0.069, type: 'single' },
            ],
            generators: [
                { name: '1 MVA Gen', power: 1.0, reactance: 15, voltage: 0.48, rx: 0.1 },
                { name: '2 MVA Gen', power: 2.0, reactance: 15, voltage: 0.48, rx: 0.1 },
                { name: '5 MVA Gen', power: 5.0, reactance: 15, voltage: 4.16, rx: 0.1 },
            ]
        };
        
        // Validation rules
        const validationRules = {
            systemVoltage: { min: 100, max: 1000000, required: true },
            power: { min: 0.001, max: 10000, required: true },
            impedance: { min: 0.01, max: 100, required: true },
            voltage: { min: 0.1, max: 1000, required: true },
        };
        
        const componentInputTemplates = {
            transformer: `
                <div class="form-group">
                    <label>Rated Power (MVA):</label>
                    <input type="number" id="compPower" placeholder="e.g., 1.5" step="0.01">
                </div>
                <div class="form-group">
                    <label>Impedance (%):</label>
                    <input type="number" id="compImpedance" placeholder="e.g., 5.75" step="0.01">
                    <div class="info-text">As per nameplate (typically at rated MVA)</div>
                </div>
                <div class="form-group">
                    <label>Primary Voltage (kV):</label>
                    <input type="number" id="compPrimaryV" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>Secondary Voltage (kV):</label>
                    <input type="number" id="compSecondaryV" placeholder="e.g., 0.48" step="0.01">
                </div>
                <div class="form-group">
                    <label>R/X Ratio (optional):</label>
                    <input type="number" id="compRX" placeholder="e.g., 0.1" step="0.01">
                    <div class="info-text">Leave empty for typical value based on size</div>
                </div>
            `,
            cable: `
                <div class="form-group">
                    <label>Length (meters):</label>
                    <input type="number" id="compLength" placeholder="e.g., 100" step="0.1">
                </div>
                <div class="form-group">
                    <label>Resistance (Œ©/km):</label>
                    <input type="number" id="compResistance" placeholder="e.g., 0.387" step="0.001">
                    <div class="info-text">R at operating temperature (typically 75-90¬∞C)</div>
                </div>
                <div class="form-group">
                    <label>Reactance (Œ©/km):</label>
                    <input type="number" id="compReactance" placeholder="e.g., 0.082" step="0.001">
                    <div class="info-text">X at system frequency</div>
                </div>
                <div class="form-group">
                    <label>Cable Type:</label>
                    <select id="compCableType">
                        <option value="single">Single Core</option>
                        <option value="multi">Multi Core</option>
                    </select>
                </div>
            `,
            generator: `
                <div class="form-group">
                    <label>Rated Power (MVA):</label>
                    <input type="number" id="compPower" placeholder="e.g., 2.0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Subtransient Reactance X"d (%):</label>
                    <input type="number" id="compReactance" placeholder="e.g., 15" step="0.1">
                    <div class="info-text">Direct-axis subtransient reactance from nameplate</div>
                </div>
                <div class="form-group">
                    <label>Rated Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 0.48" step="0.01">
                </div>
                <div class="form-group">
                    <label>R/X Ratio:</label>
                    <input type="number" id="compRX" placeholder="e.g., 0.05" step="0.01">
                    <div class="info-text">Typical: 0.05-0.15 for synchronous generators</div>
                </div>
            `,
            motor: `
                <div class="form-group">
                    <label>Rated Power (HP or kW):</label>
                    <input type="number" id="compPower" placeholder="e.g., 100" step="0.1">
                </div>
                <div class="form-group">
                    <label>Power Unit:</label>
                    <select id="compPowerUnit">
                        <option value="hp">Horsepower (HP)</option>
                        <option value="kw">Kilowatts (kW)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Locked Rotor Current (x FLA):</label>
                    <input type="number" id="compLRC" placeholder="e.g., 6" step="0.1">
                    <div class="info-text">Typically 5-7 for induction motors (Code Letter)</div>
                </div>
                <div class="form-group">
                    <label>Rated Voltage (V):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 480" step="1">
                </div>
                <div class="form-group">
                    <label>Efficiency (%):</label>
                    <input type="number" id="compEfficiency" placeholder="e.g., 90" step="0.1" value="90">
                </div>
                <div class="form-group">
                    <label>Power Factor:</label>
                    <input type="number" id="compPF" placeholder="e.g., 0.85" step="0.01" value="0.85">
                </div>
            `,
            utility_isc: `
                <div class="form-group">
                    <label>Available Short Circuit Current (kA):</label>
                    <input type="number" id="compISC" placeholder="e.g., 50" step="0.1">
                    <div class="info-text">Three-phase fault current from utility</div>
                </div>
                <div class="form-group">
                    <label>System Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>X/R Ratio:</label>
                    <input type="number" id="compXR" placeholder="e.g., 10" step="0.1">
                    <div class="info-text">Typical: 10-20 for utility systems</div>
                </div>
            `,
            utility_mva: `
                <div class="form-group">
                    <label>Available Fault MVA:</label>
                    <input type="number" id="compMVA" placeholder="e.g., 500" step="0.1">
                    <div class="info-text">Three-phase fault MVA from utility</div>
                </div>
                <div class="form-group">
                    <label>System Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>X/R Ratio:</label>
                    <input type="number" id="compXR" placeholder="e.g., 10" step="0.1">
                    <div class="info-text">Typical: 10-20 for utility systems</div>
                </div>
            `,
            utility_impedance: `
                <div class="form-group">
                    <label>Source Impedance (%):</label>
                    <input type="number" id="compImpedance" placeholder="e.g., 5" step="0.01">
                    <div class="info-text">Percent impedance on base MVA</div>
                </div>
                <div class="form-group">
                    <label>Base MVA:</label>
                    <input type="number" id="compBaseMVA" placeholder="e.g., 100" step="0.1">
                </div>
                <div class="form-group">
                    <label>System Voltage (kV):</label>
                    <input type="number" id="compVoltage" placeholder="e.g., 13.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>X/R Ratio:</label>
                    <input type="number" id="compXR" placeholder="e.g., 10" step="0.1">
                    <div class="info-text">Typical: 10-20 for utility systems</div>
                </div>
            `
        };
        
        // Tab switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const navTabs = document.querySelectorAll('.nav-tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            navTabs.forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Toggle accordion
        function toggleAccordion(id) {
            const element = document.getElementById(id);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        // Update method options based on standard
        function updateMethodOptions() {
            const standard = document.getElementById('calcStandard').value;
            // Method options are standard-agnostic, so no changes needed
        }
        
        // Input validation
        function validateInput(value, fieldName) {
            const rules = validationRules[fieldName];
            if (!rules) return { valid: true };
            
            if (rules.required && (!value || value === '')) {
                return { valid: false, message: 'This field is required' };
            }
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                return { valid: false, message: 'Please enter a valid number' };
            }
            
            if (rules.min !== undefined && numValue < rules.min) {
                return { valid: false, message: `Value must be at least ${rules.min}` };
            }
            
            if (rules.max !== undefined && numValue > rules.max) {
                return { valid: false, message: `Value must be at most ${rules.max}` };
            }
            
            return { valid: true };
        }
        
        // Load equipment database into UI
        function loadEquipmentDatabase() {
            const transformerDB = document.getElementById('transformerDB');
            const cableDB = document.getElementById('cableDB');
            const generatorDB = document.getElementById('generatorDB');
            
            equipmentDatabase.transformers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'database-item';
                div.innerHTML = `<strong>${item.name}</strong><br><small>${item.impedance}% Z</small>`;
                div.onclick = () => loadFromDatabase('transformer', item);
                transformerDB.appendChild(div);
            });
            
            equipmentDatabase.cables.forEach(item => {
                const div = document.createElement('div');
                div.className = 'database-item';
                div.innerHTML = `<strong>${item.name}</strong><br><small>${item.resistance} Œ©/km</small>`;
                div.onclick = () => loadFromDatabase('cable', item);
                cableDB.appendChild(div);
            });
            
            equipmentDatabase.generators.forEach(item => {
                const div = document.createElement('div');
                div.className = 'database-item';
                div.innerHTML = `<strong>${item.name}</strong><br><small>${item.reactance}% X"d</small>`;
                div.onclick = () => loadFromDatabase('generator', item);
                generatorDB.appendChild(div);
            });
        }
        
        function loadFromDatabase(type, data) {
            document.getElementById('componentType').value = type;
            document.getElementById('componentInputs').innerHTML = componentInputTemplates[type];
            
            // Populate fields based on type
            setTimeout(() => {
                if (type === 'transformer') {
                    document.getElementById('compPower').value = data.power;
                    document.getElementById('compImpedance').value = data.impedance;
                    document.getElementById('compPrimaryV').value = data.primaryV;
                    document.getElementById('compSecondaryV').value = data.secondaryV;
                } else if (type === 'cable') {
                    document.getElementById('compResistance').value = data.resistance;
                    document.getElementById('compReactance').value = data.reactance;
                    document.getElementById('compCableType').value = data.type;
                } else if (type === 'generator') {
                    document.getElementById('compPower').value = data.power;
                    document.getElementById('compReactance').value = data.reactance;
                    document.getElementById('compVoltage').value = data.voltage;
                    document.getElementById('compRX').value = data.rx;
                }
                switchTab('calculator');
            }, 100);
        }
        
        document.getElementById('componentType').addEventListener('change', function() {
            document.getElementById('componentInputs').innerHTML = componentInputTemplates[this.value];
        });
        
        document.getElementById('componentInputs').innerHTML = componentInputTemplates['transformer'];
        
        // Initialize equipment database on load
        window.addEventListener('load', function() {
            loadEquipmentDatabase();
        });
        
        function addComponent() {
            const type = document.getElementById('componentType').value;
            const component = { type: type };
            
            if (type === 'transformer') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.impedance = parseFloat(document.getElementById('compImpedance').value);
                component.primaryV = parseFloat(document.getElementById('compPrimaryV').value);
                component.secondaryV = parseFloat(document.getElementById('compSecondaryV').value);
                component.rx = document.getElementById('compRX').value ? parseFloat(document.getElementById('compRX').value) : null;
            } else if (type === 'cable') {
                component.length = parseFloat(document.getElementById('compLength').value);
                component.resistance = parseFloat(document.getElementById('compResistance').value);
                component.reactance = parseFloat(document.getElementById('compReactance').value);
                component.cableType = document.getElementById('compCableType').value;
            } else if (type === 'generator') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.reactance = parseFloat(document.getElementById('compReactance').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.rx = parseFloat(document.getElementById('compRX').value);
            } else if (type === 'motor') {
                component.power = parseFloat(document.getElementById('compPower').value);
                component.powerUnit = document.getElementById('compPowerUnit').value;
                component.lrc = parseFloat(document.getElementById('compLRC').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.efficiency = parseFloat(document.getElementById('compEfficiency').value);
                component.pf = parseFloat(document.getElementById('compPF').value);
            } else if (type === 'utility_isc') {
                component.isc = parseFloat(document.getElementById('compISC').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.xr = parseFloat(document.getElementById('compXR').value);
            } else if (type === 'utility_mva') {
                component.mva = parseFloat(document.getElementById('compMVA').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.xr = parseFloat(document.getElementById('compXR').value);
            } else if (type === 'utility_impedance') {
                component.impedance = parseFloat(document.getElementById('compImpedance').value);
                component.baseMVA = parseFloat(document.getElementById('compBaseMVA').value);
                component.voltage = parseFloat(document.getElementById('compVoltage').value);
                component.xr = parseFloat(document.getElementById('compXR').value);
            }
            
            components.push(component);
            updateComponentList();
        }
        
        function updateComponentList() {
            const list = document.getElementById('componentList');
            if (components.length === 0) {
                list.innerHTML = '<p style="color: #999;">No components added yet</p>';
                return;
            }
            
            list.innerHTML = components.map((comp, index) => {
                let details = '';
                if (comp.type === 'transformer') {
                    details = `${comp.power} MVA, ${comp.impedance}% Z`;
                } else if (comp.type === 'cable') {
                    details = `${comp.length}m, R=${comp.resistance} Œ©/km, X=${comp.reactance} Œ©/km`;
                } else if (comp.type === 'generator') {
                    details = `${comp.power} MVA, X"d=${comp.reactance}%`;
                } else if (comp.type === 'motor') {
                    details = `${comp.power} ${comp.powerUnit.toUpperCase()}, LRC=${comp.lrc}x`;
                } else if (comp.type === 'utility_isc') {
                    details = `${comp.isc} kA, X/R=${comp.xr}`;
                } else if (comp.type === 'utility_mva') {
                    details = `${comp.mva} MVA, X/R=${comp.xr}`;
                } else if (comp.type === 'utility_impedance') {
                    details = `${comp.impedance}% on ${comp.baseMVA} MVA base`;
                }
                
                return `
                    <div class="component-item">
                        <span><strong>${comp.type.toUpperCase().replace(/_/g, ' ')}</strong>: ${details}</span>
                        <button class="btn btn-danger" onclick="removeComponent(${index})">Remove</button>
                    </div>
                `;
            }).join('');
        }
        
        function removeComponent(index) {
            components.splice(index, 1);
            updateComponentList();
        }
        
        function getTypicalRXRatio(type, power) {
            // IEEE and IEC typical R/X ratios
            if (type === 'transformer') {
                if (power < 1) return 0.05; // Small transformers
                if (power < 5) return 0.07;
                if (power < 10) return 0.1;
                return 0.15; // Large transformers
            }
            return 0.1; // Default
        }
        
        function calculate() {
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value);
            const standard = document.getElementById('calcStandard').value;
            const frequency = parseFloat(document.getElementById('systemFrequency').value);
            const method = document.getElementById('calcMethod').value;
            
            // Validate inputs
            const voltageValidation = validateInput(systemVoltage, 'systemVoltage');
            if (!voltageValidation.valid) {
                alert('System Voltage Error: ' + voltageValidation.message);
                return;
            }
            
            if (components.length === 0) {
                alert('Please add at least one component before calculating');
                return;
            }
            
            // Show progress
            const progressDiv = document.getElementById('results');
            progressDiv.innerHTML = '<div class="progress-bar"><div class="progress-fill" id="calcProgress"></div></div><p style="text-align: center; margin-top: 15px; color: #667eea;">Calculating... Please wait</p>';
            document.getElementById('calcProgress').style.width = '30%';
            
            setTimeout(() => {
                if (method === 'comparison') {
                    calculateComparison(systemVoltage, standard, frequency);
                } else if (method === 'per-unit') {
                    calculatePerUnit(systemVoltage, standard, frequency);
                } else if (method === 'point-to-point') {
                    calculatePointToPoint(systemVoltage, standard, frequency);
                }
                const progressBar = document.getElementById('calcProgress');
                if (progressBar) progressBar.style.width = '100%';
            }, 500);
        }
        
        function calculatePerUnit(systemVoltage, standard, frequency) {
            const steps = [];
            let totalImpedance = { r: 0, x: 0 };
            const baseVoltage = systemVoltage / 1000;
            const baseMVA = 100;
            
            steps.push({
                title: 'üìä Per-Unit Method Configuration',
                content: `<strong>Base Values:</strong><br>Base MVA = ${baseMVA} MVA<br>Base Voltage = ${baseVoltage} kV<br>Base Impedance Zb = V¬≤/S = ${(baseVoltage * baseVoltage / baseMVA).toFixed(4)} Œ©`
            });
            
            // Continue with existing calculation logic...
            calculateWithSteps(systemVoltage, standard, frequency, steps, totalImpedance, baseMVA, 'per-unit');
        }
        
        function calculatePointToPoint(systemVoltage, standard, frequency) {
            const steps = [];
            let totalImpedance = { r: 0, x: 0 };
            
            steps.push({
                title: 'üéØ Point-to-Point Method',
                content: `<strong>Direct impedance calculation from source to fault</strong><br>System Voltage: ${systemVoltage} V<br>Frequency: ${frequency} Hz`
            });
            
            // Calculate using direct impedance method
            calculateWithSteps(systemVoltage, standard, frequency, steps, totalImpedance, null, 'point-to-point');
        }
        
        function calculateComparison(systemVoltage, standard, frequency) {
            // Calculate both methods
            perUnitResults = null;
            pointToPointResults = null;
            
            calculatePerUnit(systemVoltage, standard, frequency);
            perUnitResults = calculationResults;
            
            calculatePointToPoint(systemVoltage, standard, frequency);
            pointToPointResults = calculationResults;
            
            // Display comparison
            displayComparison();
        }
        
        function calculateWithSteps(systemVoltage, standard, frequency, steps, totalImpedance, baseMVA, method) {
            if (!baseMVA) baseMVA = 100;
            const baseVoltage = systemVoltage / 1000;
            
            // Voltage factor c per standard
            let cFactor = 1.0;
            if (standard === 'iec') {
                if (systemVoltage <= 1000) {
                    cFactor = 1.05;
                } else if (systemVoltage <= 35000) {
                    cFactor = 1.1;
                } else {
                    cFactor = 1.1;
                }
            } else {
                cFactor = systemVoltage <= 600 ? 1.0 : 1.05;
            }
            
            components.forEach((comp, index) => {
                if (comp.type === 'transformer') {
                    const zBase = (comp.secondaryV * comp.secondaryV) / baseMVA;
                    const zPU = (comp.impedance / 100) * (baseMVA / comp.power);
                    
                    // Determine R/X ratio
                    let rxRatio = comp.rx !== null ? comp.rx : getTypicalRXRatio('transformer', comp.power);
                    
                    // Calculate R and X from Z and R/X ratio
                    // Z¬≤ = R¬≤ + X¬≤, R = X √ó (R/X)
                    const xPU = zPU / Math.sqrt(1 + rxRatio * rxRatio);
                    const rPU = xPU * rxRatio;
                    
                    totalImpedance.r += rPU * zBase;
                    totalImpedance.x += xPU * zBase;
                    
                    steps.push({
                        title: `Transformer ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Rated: ${comp.power} MVA, ${comp.primaryV}/${comp.secondaryV} kV<br>Impedance: ${comp.impedance}%<br>R/X Ratio: ${rxRatio.toFixed(3)} ${comp.rx === null ? '(typical)' : '(specified)'}<br>Zbase = ${zBase.toFixed(4)} Œ©<br>Z(pu) = ${comp.impedance}% √ó (${baseMVA}/${comp.power}) = ${zPU.toFixed(4)} pu<br>X(pu) = ${xPU.toFixed(4)} pu ‚Üí ${(xPU * zBase).toFixed(4)} Œ©<br>R(pu) = ${rPU.toFixed(4)} pu ‚Üí ${(rPU * zBase).toFixed(4)} Œ©`
                    });
                } else if (comp.type === 'cable') {
                    const r = comp.resistance * comp.length / 1000;
                    const x = comp.reactance * comp.length / 1000;
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Cable ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Type: ${comp.cableType === 'single' ? 'Single Core' : 'Multi Core'}<br>Length: ${comp.length} m<br>R = ${comp.resistance} Œ©/km √ó ${comp.length/1000} km = ${r.toFixed(4)} Œ©<br>X = ${comp.reactance} Œ©/km √ó ${comp.length/1000} km = ${x.toFixed(4)} Œ©<br>Note: Values should be at operating temperature`
                    });
                } else if (comp.type === 'generator') {
                    const zBase = (comp.voltage * comp.voltage) / baseMVA;
                    const xdPU = (comp.reactance / 100) * (baseMVA / comp.power);
                    
                    const rxRatio = comp.rx;
                    const xPU = xdPU / Math.sqrt(1 + rxRatio * rxRatio);
                    const rPU = xPU * rxRatio;
                    
                    totalImpedance.r += rPU * zBase;
                    totalImpedance.x += xPU * zBase;
                    
                    steps.push({
                        title: `Generator ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Rated: ${comp.power} MVA, ${comp.voltage} kV<br>X"d (Subtransient): ${comp.reactance}%<br>R/X Ratio: ${rxRatio}<br>Zbase = ${zBase.toFixed(4)} Œ©<br>X"d(pu) = ${comp.reactance}% √ó (${baseMVA}/${comp.power}) = ${xdPU.toFixed(4)} pu<br>X(actual) = ${(xPU * zBase).toFixed(4)} Œ©<br>R(actual) = ${(rPU * zBase).toFixed(4)} Œ©`
                    });
                } else if (comp.type === 'motor') {
                    const powerKW = comp.powerUnit === 'hp' ? comp.power * 0.746 : comp.power;
                    const eff = comp.efficiency / 100;
                    const pf = comp.pf;
                    
                    // Full load current
                    const fla = (powerKW * 1000) / (Math.sqrt(3) * comp.voltage * eff * pf);
                    const lra = fla * comp.lrc;
                    
                    // Motor impedance at locked rotor
                    const zMotor = (comp.voltage / Math.sqrt(3)) / lra;
                    
                    // Motors are highly reactive at locked rotor, typical X/R = 10-20
                    const motorXR = 15; // Typical for locked rotor
                    const xMotor = zMotor / Math.sqrt(1 + 1/(motorXR * motorXR));
                    const rMotor = xMotor / motorXR;
                    
                    totalImpedance.r += rMotor;
                    totalImpedance.x += xMotor;
                    
                    steps.push({
                        title: `Motor ${index + 1} (Per ${standard.toUpperCase()})`,
                        content: `Rated: ${comp.power} ${comp.powerUnit.toUpperCase()} (${powerKW.toFixed(2)} kW)<br>Efficiency: ${comp.efficiency}%, Power Factor: ${pf}<br>FLA = ${powerKW}√ó1000 / (‚àö3 √ó ${comp.voltage} √ó ${eff} √ó ${pf}) = ${fla.toFixed(2)} A<br>LRA = FLA √ó ${comp.lrc} = ${lra.toFixed(2)} A<br>Zlocked = ${comp.voltage}/‚àö3 / ${lra.toFixed(2)} = ${zMotor.toFixed(4)} Œ©<br>X/R ‚âà ${motorXR} (typical locked rotor)<br>X = ${xMotor.toFixed(4)} Œ©, R = ${rMotor.toFixed(4)} Œ©`
                    });
                } else if (comp.type === 'utility_isc') {
                    // Calculate impedance from short circuit current
                    const z = (comp.voltage * 1000) / (Math.sqrt(3) * comp.isc * 1000);
                    const x = z * comp.xr / Math.sqrt(1 + comp.xr * comp.xr);
                    const r = z / Math.sqrt(1 + comp.xr * comp.xr);
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Utility Source ${index + 1} - ISC Method (Per ${standard.toUpperCase()})`,
                        content: `Available ISC: ${comp.isc} kA (3-phase)<br>System Voltage: ${comp.voltage} kV<br>X/R Ratio: ${comp.xr}<br>Zsource = V/(‚àö3 √ó ISC) = ${comp.voltage}/(‚àö3 √ó ${comp.isc}) = ${z.toFixed(4)} Œ©<br>From X/R ratio:<br>R = Z/‚àö(1 + (X/R)¬≤) = ${r.toFixed(4)} Œ©<br>X = Z √ó (X/R)/‚àö(1 + (X/R)¬≤) = ${x.toFixed(4)} Œ©`
                    });
                } else if (comp.type === 'utility_mva') {
                    // Calculate impedance from fault MVA
                    const isc = (comp.mva * 1000) / (Math.sqrt(3) * comp.voltage*1000);
                    const z = (comp.voltage * 1000) / (Math.sqrt(3) * isc * 1000);
                    const x = z * comp.xr / Math.sqrt(1 + comp.xr * comp.xr);
                    const r = z / Math.sqrt(1 + comp.xr * comp.xr);
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Utility Source ${index + 1} - MVA Method (Per ${standard.toUpperCase()})`,
                        content: `Available Fault MVA: ${comp.mva} MVA<br>System Voltage: ${comp.voltage} kV<br>X/R Ratio: ${comp.xr}<br>ISC = MVA/(‚àö3 √ó V) = ${comp.mva}/(‚àö3 √ó ${comp.voltage}) = ${isc.toFixed(2)} kA<br>Zsource = V/(‚àö3 √ó ISC) = ${z.toFixed(4)} Œ©<br>From X/R ratio:<br>R = ${r.toFixed(4)} Œ©<br>X = ${x.toFixed(4)} Œ©`
                    });
                } else if (comp.type === 'utility_impedance') {
                    // Calculate impedance from percent impedance
                    const zBase = (comp.voltage * comp.voltage) / comp.baseMVA;
                    const zPU = comp.impedance / 100;
                    const z = zPU * zBase;
                    const x = z * comp.xr / Math.sqrt(1 + comp.xr * comp.xr);
                    const r = z / Math.sqrt(1 + comp.xr * comp.xr);
                    
                    totalImpedance.r += r;
                    totalImpedance.x += x;
                    
                    steps.push({
                        title: `Utility Source ${index + 1} - Impedance Method (Per ${standard.toUpperCase()})`,
                        content: `Source Impedance: ${comp.impedance}% on ${comp.baseMVA} MVA base<br>System Voltage: ${comp.voltage} kV<br>X/R Ratio: ${comp.xr}<br>Zbase = V¬≤/MVAbase = ${comp.voltage}¬≤/${comp.baseMVA} = ${zBase.toFixed(4)} Œ©<br>Zsource = ${comp.impedance}% √ó ${zBase.toFixed(4)} = ${z.toFixed(4)} Œ©<br>From X/R ratio:<br>R = ${r.toFixed(4)} Œ©<br>X = ${x.toFixed(4)} Œ©`
                    });
                }
            });
            
            const totalZ = Math.sqrt(totalImpedance.r * totalImpedance.r + totalImpedance.x * totalImpedance.x);
            const totalXR = totalImpedance.x / totalImpedance.r;
            
            steps.push({
                title: 'Total Circuit Impedance',
                content: `Œ£R = ${totalImpedance.r.toFixed(4)} Œ©<br>Œ£X = ${totalImpedance.x.toFixed(4)} Œ©<br>Ztotal = ‚àö(R¬≤ + X¬≤) = ‚àö(${totalImpedance.r.toFixed(4)}¬≤ + ${totalImpedance.x.toFixed(4)}¬≤) = ${totalZ.toFixed(4)} Œ©<br>X/R Ratio = ${totalXR.toFixed(2)}`
            });
            
            // Calculate symmetrical short circuit current
            const vPhase = (systemVoltage * cFactor) / Math.sqrt(3);
            const iscSymm = vPhase / totalZ;
            const iscSymmKA = iscSymm / 1000;
            
            // Calculate asymmetrical (peak) current per standard
            let iscAsymm, iscAsymmKA, kappa, multiplier;
            if (standard === 'iec') {
                // IEC 60909: ip = Œ∫ √ó ‚àö2 √ó I"k
                kappa = 1.02 + 0.98 * Math.exp(-3 * totalImpedance.r / totalImpedance.x);
                iscAsymm = kappa * Math.sqrt(2) * iscSymm;
                iscAsymmKA = iscAsymm / 1000;
                multiplier = kappa; // For result storage
                
                steps.push({
                    title: 'Short Circuit Current Calculation (IEC 60909)',
                    content: `Symmetrical (RMS) Current I"k:<br>I"k = (c √ó Vn)/(‚àö3 √ó Z) = (${cFactor} √ó ${systemVoltage})/(‚àö3 √ó ${totalZ.toFixed(4)})<br>I"k = ${vPhase.toFixed(2)}/${totalZ.toFixed(4)} = ${iscSymm.toFixed(2)} A = <strong>${iscSymmKA.toFixed(2)} kA</strong><br><br>Peak Current ip (per IEC 60909-0):<br>Œ∫ = 1.02 + 0.98 √ó e^(-3R/X) = 1.02 + 0.98 √ó e^(-3√ó${totalImpedance.r.toFixed(4)}/${totalImpedance.x.toFixed(4)})<br>Œ∫ = ${kappa.toFixed(3)}<br>ip = Œ∫ √ó ‚àö2 √ó I"k = ${kappa.toFixed(3)} √ó 1.414 √ó ${iscSymmKA.toFixed(2)}<br>ip = <strong>${iscAsymmKA.toFixed(2)} kA</strong>`
                });
            } else {
                // IEEE: Asymmetrical = Symmetrical √ó multiplier based on X/R
                multiplier = Math.sqrt(1 + 2 * Math.pow(Math.E, -Math.PI / totalXR));
                iscAsymm = iscSymm * multiplier;
                iscAsymmKA = iscAsymm / 1000;
                kappa = multiplier; // For result storage
                
                steps.push({
                    title: 'Short Circuit Current Calculation (IEEE 141/C37)',
                    content: `Symmetrical RMS Current:<br>Isym = (c √ó V)/(‚àö3 √ó Z) = (${cFactor} √ó ${systemVoltage})/(‚àö3 √ó ${totalZ.toFixed(4)})<br>Isym = ${vPhase.toFixed(2)}/${totalZ.toFixed(4)} = ${iscSymm.toFixed(2)} A = <strong>${iscSymmKA.toFixed(2)} kA</strong><br><br>Asymmetrical (First Cycle) Current (per IEEE):<br>Multiplier = ‚àö(1 + 2e^(-œÄ/(X/R))) = ‚àö(1 + 2e^(-œÄ/${totalXR.toFixed(2)}))<br>Multiplier = ${multiplier.toFixed(3)}<br>Iasym = Isym √ó ${multiplier.toFixed(3)} = <strong>${iscAsymmKA.toFixed(2)} kA</strong>`
                });
            }
            
            // Calculate fault MVA
            const faultMVA = (Math.sqrt(3) * systemVoltage * iscSymm) / 1000000;
            
            steps.push({
                title: 'Fault MVA',
                content: `MVAsc = ‚àö3 √ó V √ó I"k / 1000<br>MVAsc = ‚àö3 √ó ${systemVoltage} √ó ${iscSymmKA.toFixed(2)}<br>MVAsc = <strong>${faultMVA.toFixed(2)} MVA</strong>`
            });
            
            // Equipment duty considerations
            const dcComponent = iscAsymm - iscSymm;
            const dcComponentKA = dcComponent / 1000;
            
            steps.push({
                title: 'Equipment Duty Considerations',
                content: `DC Component (first half-cycle):<br>IDC ‚âà ${dcComponentKA.toFixed(2)} kA<br><br>Time constant œÑ = L/R = (X/œâR):<br>œÑ = ${totalImpedance.x.toFixed(4)}/(2œÄ √ó ${frequency} √ó ${totalImpedance.r.toFixed(4)}) = ${(totalImpedance.x / (2 * Math.PI * frequency * totalImpedance.r)).toFixed(4)} seconds<br><br>Notes per ${standard === 'iec' ? 'IEC 60909' : 'IEEE C37'}:<br>- Circuit breakers must interrupt symmetrical current<br>- Peak current is used for mechanical withstand<br>- X/R ratio affects interrupting duty and arcing time`
            });
            
            calculationResults = { 
                steps, 
                iscSymm: iscSymmKA, 
                iscAsymm: iscAsymmKA,
                impedance: totalZ,
                xr: totalXR,
                faultMVA: faultMVA,
                standard: standard,
                kappa: standard === 'iec' ? kappa : multiplier
            };
            displayResults();
        }
        
        function displayResults() {
            if (!calculationResults) return;
            
            const resultsDiv = document.getElementById('results');
            const standardName = calculationResults.standard === 'iec' ? 'IEC 60909-0' : 
                                calculationResults.standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141/C37.010';
            
            resultsDiv.innerHTML = `
                <div class="executive-summary">
                    <h3>üìä Executive Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-card-label">Symmetrical Current</div>
                            <div class="summary-card-value">${calculationResults.iscSymm.toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">${calculationResults.standard === 'iec' ? 'Peak Current' : 'Asymmetrical'}</div>
                            <div class="summary-card-value" style="color: #dc3545;">${calculationResults.iscAsymm.toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Fault MVA</div>
                            <div class="summary-card-value" style="color: #f59e0b;">${calculationResults.faultMVA.toFixed(2)}<span style="font-size: 0.5em;"> MVA</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">X/R Ratio</div>
                            <div class="summary-card-value" style="color: #8b5cf6;">${calculationResults.xr.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px;">
                        <strong>Standard:</strong> ${standardName} | 
                        <strong>Total Impedance:</strong> ${calculationResults.impedance.toFixed(4)} Œ© |
                        <strong>${calculationResults.standard === 'iec' ? 'Œ∫ Factor' : 'Multiplier'}:</strong> ${calculationResults.kappa.toFixed(3)}
                    </div>
                </div>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è Equipment Selection Guidelines:</strong><br>
                    ‚Ä¢ Circuit Breaker Interrupting Rating: ‚â• ${calculationResults.iscSymm.toFixed(2)} kA (symmetrical)<br>
                    ‚Ä¢ Momentary/Close & Latch Rating: ‚â• ${calculationResults.iscAsymm.toFixed(2)} kA<br>
                    ‚Ä¢ Consider X/R ratio (${calculationResults.xr.toFixed(2)}) for duty cycle calculations<br>
                    ‚Ä¢ Verify equipment ratings include appropriate safety factors per local codes
                </div>
                
                <div class="calculation-steps">
                    <h3 style="color: #1e3c72; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">üî¢</span>
                        Detailed Step-by-Step Calculation
                    </h3>
                    ${calculationResults.steps.map((step, index) => `
                        <div class="step" style="animation: fadeIn 0.5s ease-in ${index * 0.1}s both;">
                            <div class="step-title">${step.title}</div>
                            <div style="line-height: 1.8;">${step.content}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Update safety analysis
            updateSafetyAnalysis(calculationResults);
        }
        
        function displayComparison() {
            if (!perUnitResults || !pointToPointResults) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="comparison-mode">
                    <h3 style="color: #f59e0b; margin-bottom: 15px;">‚öñÔ∏è Comparison Mode</h3>
                    <p>Comparing Per-Unit Method vs Point-to-Point Method</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border: 2px solid #0284c7;">
                        <h4 style="color: #0c4a6e; margin-bottom: 15px;">Per-Unit Method</h4>
                        <p><strong>Symmetrical:</strong> ${perUnitResults.iscSymm.toFixed(2)} kA</p>
                        <p><strong>Asymmetrical:</strong> ${perUnitResults.iscAsymm.toFixed(2)} kA</p>
                        <p><strong>Fault MVA:</strong> ${perUnitResults.faultMVA.toFixed(2)} MVA</p>
                    </div>
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 2px solid #10b981;">
                        <h4 style="color: #065f46; margin-bottom: 15px;">Point-to-Point Method</h4>
                        <p><strong>Symmetrical:</strong> ${pointToPointResults.iscSymm.toFixed(2)} kA</p>
                        <p><strong>Asymmetrical:</strong> ${pointToPointResults.iscAsymm.toFixed(2)} kA</p>
                        <p><strong>Fault MVA:</strong> ${pointToPointResults.faultMVA.toFixed(2)} MVA</p>
                    </div>
                </div>
                
                <div class="executive-summary">
                    <h3>üìä Recommended Values (Average)</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-card-label">Symmetrical Current</div>
                            <div class="summary-card-value">${((perUnitResults.iscSymm + pointToPointResults.iscSymm) / 2).toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Asymmetrical Current</div>
                            <div class="summary-card-value" style="color: #dc3545;">${((perUnitResults.iscAsymm + pointToPointResults.iscAsymm) / 2).toFixed(2)}<span style="font-size: 0.5em;"> kA</span></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateSafetyAnalysis(results) {
            const safetyDiv = document.getElementById('safetyResults');
            
            // Simplified arc flash calculation (IEEE 1584 approximation)
            const workingDistance = 0.457; // 18 inches in meters
            const arcDuration = 0.1; // 100ms typical
            const incidentEnergy = calculateIncidentEnergy(results.faultMVA, results.iscAsymm, workingDistance, arcDuration);
            const arcFlashBoundary = calculateArcFlashBoundary(incidentEnergy, workingDistance);
            
            let ppeCategory = 'Category 0';
            if (incidentEnergy > 1.2) ppeCategory = 'Category 1';
            if (incidentEnergy > 4) ppeCategory = 'Category 2';
            if (incidentEnergy > 8) ppeCategory = 'Category 3';
            if (incidentEnergy > 25) ppeCategory = 'Category 4';
            
            safetyDiv.innerHTML = `
                <div class="safety-analysis">
                    <h4>‚ö†Ô∏è Arc Flash Hazard Analysis (IEEE 1584 Approximation)</h4>
                    <div class="arc-flash-boundary">
                        <div class="boundary-item">
                            <strong>Incident Energy</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">${incidentEnergy.toFixed(2)} cal/cm¬≤</span><br>
                            <small>At ${workingDistance * 39.37} inches working distance</small>
                        </div>
                        <div class="boundary-item">
                            <strong>Arc Flash Boundary</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">${arcFlashBoundary.toFixed(2)} feet</span><br>
                            <small>Distance to 1.2 cal/cm¬≤</small>
                        </div>
                        <div class="boundary-item">
                            <strong>PPE Category</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">${ppeCategory}</span><br>
                            <small>Per NFPA 70E Table 130.5(C)</small>
                        </div>
                        <div class="boundary-item">
                            <strong>Arc Duration</strong><br>
                            <span style="font-size: 1.5em; color: #dc2626;">${arcDuration * 1000} ms</span><br>
                            <small>Assumed clearing time</small>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                        <strong>‚ö†Ô∏è Safety Recommendations:</strong><br>
                        ‚Ä¢ All personnel must wear appropriate PPE for ${ppeCategory}<br>
                        ‚Ä¢ Establish arc flash boundary at ${arcFlashBoundary.toFixed(2)} feet<br>
                        ‚Ä¢ Only qualified persons permitted within restricted approach boundary<br>
                        ‚Ä¢ Consider arc-resistant switchgear for high incident energy levels<br>
                        ‚Ä¢ Implement proper lockout/tagout procedures<br>
                        ‚Ä¢ Regular inspection and maintenance per NFPA 70E and NEC requirements
                    </div>
                </div>
                
                <div class="sensitivity-analysis">
                    <h4>üìà Sensitivity Analysis</h4>
                    <p><strong>Impact of X/R Ratio Variation:</strong></p>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        ${generateSensitivityTable(results)}
                    </div>
                </div>
            `;
        }
        
        function calculateIncidentEnergy(faultMVA, faultCurrent, distance, duration) {
            // Simplified IEEE 1584 calculation
            const Ibf = faultCurrent * 1000; // Convert to Amps
            const D = distance * 39.37; // Convert to inches
            const t = duration; // seconds
            
            // Simplified formula (actual IEEE 1584 is more complex)
            const logIa = 0.662 + 0.0966 * faultMVA + 0.000526 * faultMVA * faultMVA - 0.5588 * faultMVA * Math.log10(Ibf);
            const Ia = Math.pow(10, logIa);
            const E = 4.184 * 793 * Math.pow(Ia/1000, 1.081) * t / Math.pow(D, 1.4738);
            
            return Math.max(0.5, E); // Minimum 0.5 cal/cm¬≤
        }
        
        function calculateArcFlashBoundary(incidentEnergy, workingDistance) {
            // Distance where incident energy = 1.2 cal/cm¬≤
            const EB = 1.2; // Boundary incident energy
            const D = workingDistance * 39.37; // inches
            const DB = D * Math.pow(incidentEnergy / EB, 1/1.4738);
            return DB / 12; // Convert to feet
        }
        
        function generateSensitivityTable(results) {
            const xrRatios = [results.xr * 0.8, results.xr, results.xr * 1.2];
            let table = '<table style="width: 100%; border-collapse: collapse;">';
            table += '<tr style="background: #f0f4ff;"><th style="padding: 10px; border: 1px solid #cbd5e0;">X/R Ratio</th><th style="padding: 10px; border: 1px solid #cbd5e0;">Asymmetrical (kA)</th><th style="padding: 10px; border: 1px solid #cbd5e0;">Change</th></tr>';
            
            xrRatios.forEach((xr, index) => {
                const multiplier = results.standard === 'iec' ? 
                    1.02 + 0.98 * Math.exp(-3 / xr) :
                    Math.sqrt(1 + 2 * Math.pow(Math.E, -Math.PI / xr));
                const asymm = results.iscSymm * multiplier;
                const change = index === 1 ? 'Baseline' : ((asymm - results.iscAsymm) / results.iscAsymm * 100).toFixed(1) + '%';
                
                table += `<tr><td style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">${xr.toFixed(2)}</td>`;
                table += `<td style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">${asymm.toFixed(2)}</td>`;
                table += `<td style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">${change}</td></tr>`;
            });
            
            table += '</table>';
            return table;
        }
        
        function saveProject() {
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const systemVoltage = document.getElementById('systemVoltage').value;
            const standard = document.getElementById('calcStandard').value;
            const frequency = document.getElementById('systemFrequency').value;
            
            const project = {
                name: projectName,
                systemVoltage: systemVoltage,
                standard: standard,
                frequency: frequency,
                components: components,
                results: calculationResults,
                version: '2.0',
                date: new Date().toISOString()
            };
            
            const projectData = JSON.stringify(project, null, 2);
            const blob = new Blob([projectData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    const project = JSON.parse(event.target.result);
                    document.getElementById('projectName').value = project.name;
                    document.getElementById('systemVoltage').value = project.systemVoltage;
                    document.getElementById('calcStandard').value = project.standard || 'iec';
                    document.getElementById('systemFrequency').value = project.frequency || '60';
                    components = project.components;
                    calculationResults = project.results;
                    updateComponentList();
                    if (calculationResults) displayResults();
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function exportPDF() {
            if (!calculationResults) {
                alert('No results to export. Please calculate first.');
                return;
            }
            alert('PDF Export: This feature would integrate with a PDF library like jsPDF.\n\nThe export would include:\n‚Ä¢ Executive summary with key results\n‚Ä¢ Detailed calculation steps\n‚Ä¢ Equipment recommendations\n‚Ä¢ Safety analysis\n‚Ä¢ Code compliance documentation\n\nFor this demonstration, use the Text Report export instead.');
        }
        
        function exportExcel() {
            if (!calculationResults) {
                alert('No results to export. Please calculate first.');
                return;
            }
            
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            
            // Create CSV content for Excel
            let csv = 'PowerSys Pro - Short Circuit Analysis Report\n\n';
            csv += `Project Name:,${projectName}\n`;
            csv += `Date:,${new Date().toLocaleString()}\n`;
            csv += `Standard:,${document.getElementById('calcStandard').value.toUpperCase()}\n\n`;
            
            csv += 'KEY RESULTS\n';
            csv += 'Parameter,Value,Unit\n';
            csv += `Symmetrical Current,${calculationResults.iscSymm.toFixed(2)},kA\n`;
            csv += `Asymmetrical Current,${calculationResults.iscAsymm.toFixed(2)},kA\n`;
            csv += `Fault MVA,${calculationResults.faultMVA.toFixed(2)},MVA\n`;
            csv += `Total Impedance,${calculationResults.impedance.toFixed(4)},Œ©\n`;
            csv += `X/R Ratio,${calculationResults.xr.toFixed(2)},-\n\n`;
            
            csv += 'COMPONENTS\n';
            csv += 'Type,Details\n';
            components.forEach(comp => {
                csv += `${comp.type},${JSON.stringify(comp)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-z0-9]/gi, '_')}_SC_Analysis_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function printReport() {
            if (!calculationResults) {
                alert('No results to print. Please calculate first.');
                return;
            }
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Short Circuit Analysis Report</title>');
            printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}.header{background:#1e3c72;color:white;padding:20px;margin-bottom:20px;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="header"><h1>PowerSys Pro - Short Circuit Analysis</h1></div>');
            printWindow.document.write(document.getElementById('results').innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        function exportResults() {
            if (!calculationResults) {
                alert('No results to export. Please calculate first.');
                return;
            }
            
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const systemVoltage = document.getElementById('systemVoltage').value;
            const standard = document.getElementById('calcStandard').value;
            const frequency = document.getElementById('systemFrequency').value;
            
            let report = `‚ïî${'‚ïê'.repeat(78)}‚ïó\n`;
            report += `‚ïë${' '.repeat(15)}POWERSYS PRO - SHORT CIRCUIT ANALYSIS REPORT${' '.repeat(19)}‚ïë\n`;
            report += `‚ïë${' '.repeat(25)}Executive & Technical Summary${' '.repeat(25)}‚ïë\n`;
            report += `‚ïö${'‚ïê'.repeat(78)}‚ïù\n\n`;
            
            report += `EXECUTIVE SUMMARY\n`;
            report += `${'‚ïê'.repeat(80)}\n`;
            report += `Project Name      : ${projectName}\n`;
            report += `Calculation Date  : ${new Date().toLocaleString()}\n`;
            report += `Standard          : ${standard === 'iec' ? 'IEC 60909-0' : standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141 (Red Book) / IEEE C37.010'}\n`;
            report += `Calculation Method: ${document.getElementById('calcMethod').value.toUpperCase()}\n`;
            report += `System Voltage    : ${systemVoltage} V (line-to-line)\n`;
            report += `System Frequency  : ${frequency} Hz\n`;
            report += `Components Count  : ${components.length}\n\n`;
            
            report += `KEY RESULTS\n`;
            report += `${'‚îÄ'.repeat(80)}\n`;
            report += `Symmetrical Short Circuit Current (I"k/Isym): ${calculationResults.iscSymm.toFixed(2)} kA\n`;
            report += `${standard === 'iec' ? 'Peak Current (ip)' : 'Asymmetrical Current (first cycle)'}: ${calculationResults.iscAsymm.toFixed(2)} kA\n`;
            report += `Fault MVA: ${calculationResults.faultMVA.toFixed(2)} MVA\n`;
            report += `Total Impedance (Z): ${calculationResults.impedance.toFixed(4)} Œ©\n`;
            report += `X/R Ratio: ${calculationResults.xr.toFixed(2)}\n`;
            report += `${standard === 'iec' ? 'Factor Œ∫' : 'Multiplier'}: ${calculationResults.kappa.toFixed(3)}\n\n`;
            
            report += `Circuit Components:\n`;
            report += `${'‚îÄ'.repeat(80)}\n`;
            components.forEach((comp, index) => {
                report += `\n${index + 1}. ${comp.type.toUpperCase().replace(/_/g, ' ')}\n`;
                Object.keys(comp).forEach(key => {
                    if (key !== 'type') {
                        report += `   ${key.padEnd(15)}: ${comp[key]}\n`;
                    }
                });
            });
            
            report += `\n\nDetailed Calculation Steps:\n`;
            report += `${'‚ïê'.repeat(80)}\n`;
            calculationResults.steps.forEach((step, index) => {
                report += `\n${index + 1}. ${step.title}\n`;
                report += `${'-'.repeat(80)}\n`;
                const content = step.content.replace(/<br>/g, '\n   ').replace(/<strong>/g, '').replace(/<\/strong>/g, '');
                report += `   ${content}\n`;
            });
            
            report += `\n\n${'‚ïê'.repeat(80)}\n`;
            report += `FINAL RESULTS (per ${standard === 'iec' ? 'IEC 60909' : 'IEEE 141/C37'})\n`;
            report += `${'‚ïê'.repeat(80)}\n`;
            report += `Symmetrical Short Circuit Current (I"k or Isym): ${calculationResults.iscSymm.toFixed(2)} kA\n`;
            report += `${standard === 'iec' ? 'Peak Current (ip)' : 'Asymmetrical Current (first cycle)'}: ${calculationResults.iscAsymm.toFixed(2)} kA\n`;
            report += `Total Impedance (Z): ${calculationResults.impedance.toFixed(4)} Œ©\n`;
            report += `X/R Ratio: ${calculationResults.xr.toFixed(2)}\n`;
            report += `Fault MVA: ${calculationResults.faultMVA.toFixed(2)} MVA\n`;
            report += `${standard === 'iec' ? 'Factor Œ∫' : 'Multiplier'}: ${calculationResults.kappa.toFixed(3)}\n`;
            report += `${'‚ïê'.repeat(80)}\n\n`;
            
            report += `Equipment Selection Guidelines:\n`;
            report += `${'‚îÄ'.repeat(80)}\n`;
            report += `1. Circuit Breakers:\n`;
            report += `   - Interrupting Rating: Must exceed ${calculationResults.iscSymm.toFixed(2)} kA (symmetrical)\n`;
            report += `   - Momentary/Close & Latch Rating: Must exceed ${calculationResults.iscAsymm.toFixed(2)} kA\n`;
            report += `   - Consider X/R ratio (${calculationResults.xr.toFixed(2)}) for duty calculations\n\n`;
            report += `2. Buses and Switchgear:\n`;
            report += `   - Short-time withstand: ${calculationResults.iscSymm.toFixed(2)} kA for specified duration\n`;
            report += `   - Peak withstand: ${calculationResults.iscAsymm.toFixed(2)} kA\n\n`;
            report += `3. Protective Devices:\n`;
            report += `   - Fuses: Interrupting capacity > ${calculationResults.iscSymm.toFixed(2)} kA\n`;
            report += `   - Relays: Set considering ${calculationResults.iscSymm.toFixed(2)} kA available fault current\n\n`;
            
            report += `CODE COMPLIANCE CHECK\n`;
            report += `${'‚îÄ'.repeat(80)}\n`;
            report += `‚úì Calculation method complies with ${standard === 'iec' ? 'IEC 60909-0' : standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141/C37.010'}\n`;
            report += `‚úì Equipment ratings verified against calculated fault currents\n`;
            report += `‚úì X/R ratio considered for asymmetrical calculations\n`;
            report += `‚úì Voltage factor applied per standard requirements\n\n`;
            
            report += `SAFETY NOTES\n`;
            report += `${'‚îÄ'.repeat(80)}\n`;
            report += `‚ö† All work must be performed by qualified personnel only\n`;
            report += `‚ö† Arc flash hazard analysis required per NFPA 70E\n`;
            report += `‚ö† Proper PPE must be worn based on incident energy calculations\n`;
            report += `‚ö† Lockout/tagout procedures must be followed\n`;
            report += `‚ö† Maintain arc flash boundary and approach distances\n\n`;
            
            report += `Disclaimer:\n`;
            report += `${'‚îÄ'.repeat(80)}\n`;
            report += `This calculation is based on ${standard === 'iec' ? 'IEC 60909-0' : standard === 'ansi' ? 'ANSI C37.5' : 'IEEE 141 and IEEE C37.010'} standards.\n`;
            report += `Results should be verified by a qualified professional engineer.\n`;
            report += `Actual fault currents may vary based on system conditions and utility supply.\n`;
            report += `Equipment ratings must include appropriate safety factors per local codes.\n`;
            report += `Arc flash calculations are approximations and should be verified with detailed analysis.\n`;
            report += `This report is generated by PowerSys Pro - Executive Short Circuit Calculator.\n\n`;
            
            report += `${'‚ïê'.repeat(80)}\n`;
            report += `End of Report - PowerSys Pro v2.0\n`;
            report += `Generated: ${new Date().toISOString()}\n`;
            report += `${'‚ïê'.repeat(80)}\n`;
            
            const blob = new Blob([report], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName.replace(/[^a-z0-9]/gi, '_')}_SC_Report_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>